<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>myTVS SCM Expense Management System</title>
    <!-- Updated: Removed demo user info from login -->
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
            position: relative;
            overflow-x: hidden;
        }
        
        /* myTVS Color Scheme */
        :root {
            --mytvs-orange: #FF6600;
            --mytvs-blue: #003366;
            --mytvs-blue-light: #004d99;
            --mytvs-gray: #f5f5f5;
            --mytvs-white: #ffffff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #003366;
            background: var(--mytvs-white);
            border: 3px solid var(--mytvs-orange);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(255, 102, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--mytvs-orange) 0%, var(--mytvs-blue) 100%);
        }

        .logo {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo img {
            max-height: 60px;
            width: auto;
        }

        .logo-text {
            font-size: 3rem;
            font-weight: bold;
            font-family: 'Arial', sans-serif;
            letter-spacing: -1px;
        }

        .logo-text .my {
            color: #FF6600;
            text-transform: lowercase;
        }

        .logo-text .tvs {
            color: #003366;
            text-transform: uppercase;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #003366;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom: 2px solid var(--mytvs-orange);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .header p {
            font-size: 1.1rem;
            color: #666;
            margin-top: 10px;
            font-weight: 500;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 50px auto;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--mytvs-orange);
            background: white;
            box-shadow: 0 0 0 3px rgba(255, 102, 0, 0.1);
        }

        .btn {
            background: var(--mytvs-orange);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);
            width: 100%;
        }

        .btn:hover {
            background: #e55a00;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 102, 0, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: var(--mytvs-white);
            border-radius: 15px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-tab {
            padding: 12px 24px;
            margin: 0 5px;
            background: transparent;
            border: none;
            color: var(--mytvs-blue);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab.active {
            background: var(--mytvs-orange);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);
        }

        .nav-tab:hover {
            background: rgba(255, 102, 0, 0.1);
            color: var(--mytvs-orange);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-info {
            background: var(--mytvs-blue);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .warehouse-selector {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .expense-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
            padding-right: 50px;
        }

        .expense-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .expense-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 10px;
        }

        .expense-category {
            background: var(--mytvs-orange);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .expense-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .expense-details {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .expense-description {
            color: #495057;
            font-style: italic;
        }

        .warehouse-badge {
            background: var(--mytvs-blue);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: var(--mytvs-blue);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 51, 102, 0.3);
        }

        .summary-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .summary-card p {
            opacity: 0.9;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--mytvs-orange);
            background: transparent;
            color: var(--mytvs-orange);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn.active {
            background: var(--mytvs-orange);
            color: white;
        }

        .filter-btn:hover {
            background: var(--mytvs-orange);
            color: white;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .delete-btn:hover {
            background: #ff5252;
            transform: scale(1.1);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .download-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #28a745;
        }

        .download-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .user-management {
            background: #fff3cd;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
        }

        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .user-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .user-role {
            background: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .user-role.master {
            background: #dc3545;
        }

        .user-role.approver {
            background: #ffc107;
            color: #000;
        }

        .user-role.warehouse {
            background: #28a745;
        }

        .approval-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .approval-status.pending {
            background: #ffc107;
            color: #000;
        }

        .approval-status.approved {
            background: #28a745;
            color: white;
        }

        .approval-status.rejected {
            background: #dc3545;
            color: white;
        }

        .approval-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .approval-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .approve-btn {
            background: var(--mytvs-orange);
            color: white;
        }

        .approve-btn:hover {
            background: #e55a00;
        }

        .reject-btn {
            background: #dc3545;
            color: white;
        }

        .reject-btn:hover {
            background: #c82333;
        }

        .approval-card {
            background: var(--mytvs-white);
            border: 2px solid var(--mytvs-orange);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .approval-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 102, 0, 0.2);
        }

        .category-breakdown {
            margin-top: 0;
        }

        .date-wise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .date-wise-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(5px);
            transition: all 0.3s ease;
        }

        .date-info {
            flex: 1;
        }

        .date-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .date-details {
            font-size: 14px;
            color: #6c757d;
        }

        .date-stats {
            text-align: right;
            margin-left: 20px;
        }

        .entries-count {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .expense-total {
            font-size: 20px;
            font-weight: bold;
            color: #28a745;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-container h3 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #2a5298;
            padding-bottom: 10px;
        }

        .budget-summary-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .budget-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid #2a5298;
        }

        .budget-progress {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .budget-progress-bar {
            height: 100%;
            transition: width 0.3s ease;
        }

        .budget-progress-bar.under-budget {
            background: #28a745;
        }

        .budget-progress-bar.over-budget {
            background: #dc3545;
        }

        .budget-stat {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 14px;
        }

        .budget-remaining.positive {
            color: #28a745;
        }

        .budget-remaining.negative {
            color: #dc3545;
        }

        .budget-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .budget-input-group label {
            flex: 0 0 150px;
            font-weight: 600;
        }

        .budget-input-group input {
            flex: 1;
        }

        /* Toast Notifications */
        /* Custom Modal Dialog */
        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .custom-modal-overlay.show {
            display: flex;
        }

        .custom-modal {
            background: white;
            border-radius: 15px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .custom-modal-header {
            background: var(--mytvs-blue);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            font-weight: 600;
            font-size: 18px;
        }

        .custom-modal-body {
            padding: 25px;
            color: #333;
            white-space: pre-line;
            line-height: 1.6;
        }

        .custom-modal-footer {
            padding: 15px 25px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .custom-modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .custom-modal-btn-primary {
            background: var(--mytvs-orange);
            color: white;
        }

        .custom-modal-btn-primary:hover {
            background: #e55a00;
        }

        .custom-modal-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .custom-modal-btn-secondary:hover {
            background: #5a6268;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
        
        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
            border-left: 4px solid;
        }
        
        .toast.success { border-left-color: #28a745; }
        .toast.error { border-left-color: #dc3545; }
        .toast.info { border-left-color: #17a2b8; }
        .toast.warning { border-left-color: #ffc107; }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }
        
        .toast-icon {
            font-size: 24px;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 14px;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .chart-container {
                grid-template-columns: 1fr !important;
            }
            
            .toast {
                min-width: 280px;
                right: 10px;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 5px;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .filter-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Toast Container -->
        <div id="toastContainer" class="toast-container"></div>
        
        <!-- Custom Modal Dialog -->
        <div id="customModalOverlay" class="custom-modal-overlay">
            <div class="custom-modal">
                <div class="custom-modal-header" id="customModalTitle">myTVS Expenses Management</div>
                <div class="custom-modal-body" id="customModalMessage"></div>
                <div class="custom-modal-footer" id="customModalFooter"></div>
            </div>
        </div>
        
        <!-- Login Screen -->
        <div id="loginScreen" class="login-container">
            <div class="login-form">
                <div class="logo" style="margin-bottom: 20px;">
                    <!-- Option 1: Use image logo (if you have myTVS-logo.png in the same folder) -->
                    <!-- <img src="myTVS-logo.png" alt="myTVS Logo"> -->
                    
                    <!-- Option 2: CSS-based logo -->
                    <div class="logo-text">
                        <span class="my">my</span><span class="tvs">TVS</span>
                    </div>
                </div>
                <h2>üîê Login to Expense Tracker</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" id="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" class="btn">Login</button>
                </form>
            </div>
        </div>

        <!-- Main Application -->
        <div id="mainApp" style="display: none;">
            <div class="header">
                <div class="logo">
                    <!-- Option 1: Use image logo (if you have myTVS-logo.png in the same folder) -->
                    <!-- <img src="myTVS-logo.png" alt="myTVS Logo"> -->
                    
                    <!-- Option 2: CSS-based logo -->
                    <div class="logo-text">
                        <span class="my">my</span><span class="tvs">TVS</span>
                    </div>
                </div>
                <h1>SCM Expense Management System</h1>
                <p>Multi-User Expense Management System</p>
            </div>

            <div class="user-info">
                <div>
                    <strong>Welcome, <span id="currentUser"></span></strong>
                    <span class="user-role" id="userRole"></span>
                </div>
                <button onclick="logout()" class="btn btn-danger" style="width: auto; padding: 8px 16px;">Logout</button>
            </div>

            <!-- Warehouse Selector for Master Users -->
            <div id="warehouseSelector" class="warehouse-selector" style="display: none;">
                <h3>Select Warehouse to View:</h3>
                <select id="warehouseSelect" onchange="switchWarehouse()">
                    <option value="all">All Warehouses</option>
                    <option value="warehouse_1">Warehouse 1</option>
                    <option value="warehouse_2">Warehouse 2</option>
                    <option value="warehouse_3">Warehouse 3</option>
                    <option value="warehouse_4">Warehouse 4</option>
                    <option value="warehouse_5">Warehouse 5</option>
                    <option value="warehouse_6">Warehouse 6</option>
                    <option value="warehouse_7">Warehouse 7</option>
                    <option value="warehouse_8">Warehouse 8</option>
                    <option value="warehouse_9">Warehouse 9</option>
                    <option value="warehouse_10">Warehouse 10</option>
                    <option value="warehouse_11">Warehouse 11</option>
                    <option value="warehouse_12">Warehouse 12</option>
                    <option value="warehouse_13">Warehouse 13</option>
                    <option value="warehouse_14">Warehouse 14</option>
                    <option value="warehouse_15">Warehouse 15</option>
                    <option value="warehouse_16">Warehouse 16</option>
                    <option value="warehouse_17">Warehouse 17</option>
                    <option value="warehouse_18">Warehouse 18</option>
                    <option value="warehouse_19">Warehouse 19</option>
                    <option value="warehouse_20">Warehouse 20</option>
                    <option value="warehouse_21">Warehouse 21</option>
                    <option value="warehouse_22">Warehouse 22</option>
                    <option value="warehouse_23">Warehouse 23</option>
                    <option value="warehouse_24">Warehouse 24</option>
                    <option value="warehouse_25">Warehouse 25</option>
                    <option value="warehouse_26">Warehouse 26</option>
                    <option value="warehouse_27">Warehouse 27</option>
                    <option value="warehouse_28">Warehouse 28</option>
                </select>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('add')">‚ûï Add Expense</button>
                <button class="nav-tab" onclick="showTab('list')">üìã Expense List</button>
                <button class="nav-tab" onclick="showTab('summary')">üìä Summary</button>
                <button class="nav-tab" onclick="showTab('budget')">üí∞ Budget</button>
                <button class="nav-tab" onclick="showTab('approvals')" id="approvalsTab" style="display: none;">‚úÖ Approvals</button>
                <button class="nav-tab" onclick="showTab('download')">üì• Download</button>
                <button class="nav-tab" onclick="showTab('users')" id="usersTab" style="display: none;">üë• Users</button>
            </div>

            <!-- Add Expense Tab -->
            <div id="add" class="tab-content active">
                <h2>Add New Expense</h2>
                <form id="expenseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseDate">Date</label>
                            <input type="date" id="expenseDate" required>
                        </div>
                        <div class="form-group">
                            <label for="expenseTime">Time</label>
                            <input type="time" id="expenseTime" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseCategory">Category</label>
                            <select id="expenseCategory" required>
                                <option value="Pooja">Pooja</option>
                                <option value="Tea">Tea</option>
                                <option value="Petrol">Petrol</option>
                                <option value="Lunch">Lunch</option>
                                <option value="Travel">Travel</option>
                                <option value="Freight">Freight</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Supplies">Supplies</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expenseAmount">Amount (‚Çπ)</label>
                            <input type="number" id="expenseAmount" step="0.01" min="0" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="vendorName">Vendor Name *</label>
                            <input type="text" id="vendorName" required placeholder="Enter vendor/supplier name">
                        </div>
                        <div class="form-group">
                            <label for="paymentMode">Payment Mode *</label>
                            <select id="paymentMode" required>
                                <option value="">Select payment mode</option>
                                <option value="Cash">Cash</option>
                                <option value="UPI">UPI</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Debit Card">Debit Card</option>
                                <option value="Net Banking">Net Banking</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="invoiceNumber">Invoice Number *</label>
                        <input type="text" id="invoiceNumber" required placeholder="Enter invoice number (e.g., INV-2024/001)">
                        <small style="color: #6c757d; font-size: 14px; display: block; margin-top: 5px;">Allowed: Letters, Numbers, Spaces, -, _, /</small>
                    </div>

                    <div class="form-group">
                        <label for="invoiceFile">Invoice Document (PDF/JPEG) *</label>
                        <input type="file" id="invoiceFile" accept=".pdf,.jpg,.jpeg,.png" required>
                        <small style="color: #6c757d; font-size: 14px; display: block; margin-top: 5px;">Supported formats: PDF, JPG, JPEG, PNG (Max size: 750KB for Firebase, 10MB for local storage)</small>
                    </div>

                    <div class="form-group">
                        <label for="expenseDescription">Description (Optional)</label>
                        <textarea id="expenseDescription" rows="3" placeholder="Add any additional details..."></textarea>
                    </div>

                    <button type="submit" class="btn">üíæ Add Expense</button>
                </form>
            </div>

            <!-- Expense List Tab -->
            <div id="list" class="tab-content">
                <h2>Expense List</h2>
                
                <div class="filter-section">
                    <h3>Filter Expenses</h3>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterExpenses('all')">All</button>
                        <button class="filter-btn" onclick="filterExpenses('daily')">Today</button>
                        <button class="filter-btn" onclick="filterExpenses('weekly')">This Week</button>
                        <button class="filter-btn" onclick="filterExpenses('monthly')">This Month</button>
                    </div>
                </div>

                <div id="expenseList">
                    <!-- Expenses will be populated here -->
                </div>
            </div>

            <!-- Summary Tab -->
            <div id="summary" class="tab-content">
                <h2>Expense Summary</h2>
                
                <div class="filter-section">
                    <h3>Filter by Date</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="summaryFromDate">From Date</label>
                            <input type="date" id="summaryFromDate">
                        </div>
                        <div class="form-group">
                            <label for="summaryToDate">To Date</label>
                            <input type="date" id="summaryToDate">
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button class="btn" onclick="updateSummaryWithDateFilter()" style="margin-bottom: 0;">Apply Filter</button>
                        </div>
                    </div>
                </div>
                
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3 id="totalAmount">‚Çπ0.00</h3>
                        <p>Total Expenses</p>
                    </div>
                    <div class="summary-card">
                        <h3 id="totalCount">0</h3>
                        <p>Total Entries</p>
                    </div>
                    <div class="summary-card">
                        <h3 id="averageAmount">‚Çπ0.00</h3>
                        <p>Average per Entry</p>
                    </div>
                    <div class="summary-card">
                        <h3 id="dateRange">-</h3>
                        <p>Date Range</p>
                    </div>
                    <div class="summary-card">
                        <h3 id="lastExpenseDate">-</h3>
                        <p>Last Expense</p>
                    </div>
                </div>

                <div class="category-breakdown">
                    <h3>Date-wise Summary</h3>
                    <div id="dateWiseSummary">
                        <!-- Date-wise breakdown will be populated here -->
                    </div>
                </div>

                <div class="category-breakdown" style="margin-top: 30px;">
                    <h3>Category Breakdown</h3>
                    <div id="categoryBreakdown">
                        <!-- Category breakdown will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Approvals Tab (Master Users Only) -->
            <div id="approvals" class="tab-content">
                <h2>Expense Approvals</h2>
                
                <div class="filter-section">
                    <h3>Filter Pending Approvals</h3>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterApprovals('all')">All Pending</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_1')">Warehouse 1</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_2')">Warehouse 2</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_3')">Warehouse 3</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_4')">Warehouse 4</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_5')">Warehouse 5</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_6')">Warehouse 6</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_7')">Warehouse 7</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_8')">Warehouse 8</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_9')">Warehouse 9</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_10')">Warehouse 10</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_11')">Warehouse 11</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_12')">Warehouse 12</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_13')">Warehouse 13</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_14')">Warehouse 14</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_15')">Warehouse 15</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_16')">Warehouse 16</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_17')">Warehouse 17</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_18')">Warehouse 18</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_19')">Warehouse 19</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_20')">Warehouse 20</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_21')">Warehouse 21</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_22')">Warehouse 22</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_23')">Warehouse 23</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_24')">Warehouse 24</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_25')">Warehouse 25</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_26')">Warehouse 26</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_27')">Warehouse 27</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_28')">Warehouse 28</button>
                    </div>
                </div>

                <div id="approvalsList">
                    <!-- Pending approvals will be populated here -->
                </div>
            </div>

            <!-- Budget Tab -->
            <div id="budget" class="tab-content">
                <h2>üí∞ Budget Management & Visualization</h2>
                
                <div class="filter-section">
                    <h3>Select Warehouse</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="budgetWarehouse">Warehouse</label>
                            <select id="budgetWarehouse" onchange="loadBudgetVisualization(); loadBudgetManagement()">
                                <option value="warehouse_1">Warehouse 1</option>
                                <option value="warehouse_2">Warehouse 2</option>
                                <option value="warehouse_3">Warehouse 3</option>
                                <option value="warehouse_4">Warehouse 4</option>
                                <option value="warehouse_5">Warehouse 5</option>
                                <option value="warehouse_6">Warehouse 6</option>
                                <option value="warehouse_7">Warehouse 7</option>
                                <option value="warehouse_8">Warehouse 8</option>
                                <option value="warehouse_9">Warehouse 9</option>
                                <option value="warehouse_10">Warehouse 10</option>
                                <option value="warehouse_11">Warehouse 11</option>
                                <option value="warehouse_12">Warehouse 12</option>
                                <option value="warehouse_13">Warehouse 13</option>
                                <option value="warehouse_14">Warehouse 14</option>
                                <option value="warehouse_15">Warehouse 15</option>
                                <option value="warehouse_16">Warehouse 16</option>
                                <option value="warehouse_17">Warehouse 17</option>
                                <option value="warehouse_18">Warehouse 18</option>
                                <option value="warehouse_19">Warehouse 19</option>
                                <option value="warehouse_20">Warehouse 20</option>
                                <option value="warehouse_21">Warehouse 21</option>
                                <option value="warehouse_22">Warehouse 22</option>
                                <option value="warehouse_23">Warehouse 23</option>
                                <option value="warehouse_24">Warehouse 24</option>
                                <option value="warehouse_25">Warehouse 25</option>
                                <option value="warehouse_26">Warehouse 26</option>
                                <option value="warehouse_27">Warehouse 27</option>
                                <option value="warehouse_28">Warehouse 28</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="budgetMonth">Month</label>
                            <input type="month" id="budgetMonth" onchange="loadBudgetVisualization(); loadBudgetManagement()">
                        </div>
                    </div>
                </div>

                <!-- Budget Management (Master Users Only) -->
                <div id="budgetManagementSection" style="background: #e8f5e9; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #28a745; display: none;">
                    <h3>üîß Set Monthly Budgets (Master Access Only)</h3>
                    
                    <!-- Excel Upload Option -->
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px dashed #667eea;">
                        <h4 style="margin-bottom: 10px;">üìä Upload Budget from Excel/CSV</h4>
                        <p style="color: #6c757d; font-size: 14px; margin-bottom: 20px;">
                            Download the template, fill in your budget values, and upload the CSV file. Budgets will be automatically saved.
                        </p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="downloadBudgetTemplate()">üì• Download Template</button>
                            <button class="btn" onclick="document.getElementById('budgetFileInput').click()">üì§ Upload CSV File</button>
                            <button class="btn" onclick="exportBudgetsToCSV()">üíæ Export Current Budgets</button>
                            <input type="file" id="budgetFileInput" accept=".csv" style="display: none;" onchange="uploadBudgetFile(event)">
                        </div>
                    </div>
                    
                    <!-- Uploaded Budget Preview -->
                    <div id="budgetPreview" style="display: none;">
                        <h4>üìã Budget Preview (Ready to Save)</h4>
                        <div id="budgetPreviewList" style="background: white; padding: 15px; border-radius: 10px;">
                            <!-- Budget preview will be shown here -->
                        </div>
                        <button class="btn btn-success" onclick="saveUploadedBudgets()" style="margin-top: 15px;">üíæ Save Budgets</button>
                    </div>
                </div>

                <!-- Budget vs Expense Charts -->
                <div id="budgetVisualization">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="chart-container">
                            <h3>Pie Chart - Budget vs Expense</h3>
                            <div id="pieChartContainer">
                                <!-- Pie chart will be rendered here -->
                            </div>
                        </div>
                        <div class="chart-container">
                            <h3>Bar Graph - Budget vs Expense</h3>
                            <div id="barChartContainer">
                                <!-- Bar chart will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="budget-summary-section">
                        <h3>Budget Summary</h3>
                        <div id="budgetSummaryList">
                            <!-- Budget summary will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Download Tab -->
            <div id="download" class="tab-content">
                <h2>Download Reports</h2>
                
                <div class="download-section">
                    <h3>üì• Export Expense Data</h3>
                    <p>Download expense reports in various formats</p>
                    <div class="download-buttons">
                        <button class="btn btn-success" onclick="downloadCSV()">üìä Download CSV</button>
                        <button class="btn btn-success" onclick="downloadJSON()">üìÑ Download JSON</button>
                        <button class="btn btn-success" onclick="downloadPDF()">üìã Download PDF Report</button>
                    </div>
                </div>

                <div class="filter-section">
                    <h3>Filter Data for Download</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="downloadFromDate">From Date</label>
                            <input type="date" id="downloadFromDate">
                        </div>
                        <div class="form-group">
                            <label for="downloadToDate">To Date</label>
                            <input type="date" id="downloadToDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="downloadCategory">Category (Optional)</label>
                        <select id="downloadCategory">
                            <option value="">All Categories</option>
                            <option value="Pooja">Pooja</option>
                            <option value="Tea">Tea</option>
                            <option value="Petrol">Petrol</option>
                            <option value="Lunch">Lunch</option>
                            <option value="Travel">Travel</option>
                            <option value="Freight">Freight</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Supplies">Supplies</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- User Management Tab (Master Admin Only) -->
            <div id="users" class="tab-content">
                <h2>User Management</h2>
                
                <!-- Add New User Section -->
                <div class="user-management" style="background: #e8f5e9; border: 2px solid #28a745;">
                    <h3>‚ûï Add New User</h3>
                    <form id="addUserForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newUsername">Username</label>
                                <input type="text" id="newUsername" required placeholder="Enter username">
                            </div>
                            <div class="form-group">
                                <label for="newPassword">Password</label>
                                <input type="password" id="newPassword" required placeholder="Enter password">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newName">Full Name</label>
                                <input type="text" id="newName" required placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label for="newEmployeeCode">Employee Code</label>
                                <input type="text" id="newEmployeeCode" required placeholder="Enter employee code">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newRole">Role</label>
                                <select id="newRole" required onchange="toggleWarehouseField()">
                                    <option value="master">Master (Full Access)</option>
                                    <option value="approver">Approver (All Access Except User Creation)</option>
                                    <option value="warehouse">Warehouse Entry (Entry Only)</option>
                                </select>
                            </div>
                            <div class="form-group" id="warehouseFieldGroup">
                                <label for="newWarehouse">Warehouse (Hold Ctrl/Cmd to select multiple)</label>
                                <select id="newWarehouse" multiple size="8" style="min-height: 150px;">
                                    <option value="warehouse_1">Warehouse 1</option>
                                    <option value="warehouse_2">Warehouse 2</option>
                                    <option value="warehouse_3">Warehouse 3</option>
                                    <option value="warehouse_4">Warehouse 4</option>
                                    <option value="warehouse_5">Warehouse 5</option>
                                    <option value="warehouse_6">Warehouse 6</option>
                                    <option value="warehouse_7">Warehouse 7</option>
                                    <option value="warehouse_8">Warehouse 8</option>
                                    <option value="warehouse_9">Warehouse 9</option>
                                    <option value="warehouse_10">Warehouse 10</option>
                                    <option value="warehouse_11">Warehouse 11</option>
                                    <option value="warehouse_12">Warehouse 12</option>
                                    <option value="warehouse_13">Warehouse 13</option>
                                    <option value="warehouse_14">Warehouse 14</option>
                                    <option value="warehouse_15">Warehouse 15</option>
                                    <option value="warehouse_16">Warehouse 16</option>
                                    <option value="warehouse_17">Warehouse 17</option>
                                    <option value="warehouse_18">Warehouse 18</option>
                                    <option value="warehouse_19">Warehouse 19</option>
                                    <option value="warehouse_20">Warehouse 20</option>
                                    <option value="warehouse_21">Warehouse 21</option>
                                    <option value="warehouse_22">Warehouse 22</option>
                                    <option value="warehouse_23">Warehouse 23</option>
                                    <option value="warehouse_24">Warehouse 24</option>
                                    <option value="warehouse_25">Warehouse 25</option>
                                    <option value="warehouse_26">Warehouse 26</option>
                                    <option value="warehouse_27">Warehouse 27</option>
                                    <option value="warehouse_28">Warehouse 28</option>
                                </select>
                                <small style="color: #6c757d; font-size: 12px; display: block; margin-top: 5px;">
                                    üí° Tip: Select multiple warehouses or leave empty for "All Warehouses"
                                </small>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">‚ûï Add User</button>
                    </form>
                </div>
                
                <div class="user-management">
                    <h3>üë• System Users</h3>
                    <div class="user-list" id="userList">
                        <!-- Users will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        // Firebase config for myTVS Expense Tracker
        const firebaseConfig = {
            apiKey: "AIzaSyABOT-m3kraMuaTDjGDLmBcESbxL3XpRlA",
            authDomain: "mytvs-expense-tracker.firebaseapp.com",
            projectId: "mytvs-expense-tracker",
            storageBucket: "mytvs-expense-tracker.firebasestorage.app",
            messagingSenderId: "653659771144",
            appId: "1:653659771144:web:7ebd5e188e94e19666dcbd",
            measurementId: "G-JQ5MQ08SMH"
        };
        
        // Initialize Firebase (only if config is provided)
        let db = null;
        let useFirebase = false;
        
        if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                useFirebase = true;
                console.log('‚úÖ Firebase initialized successfully');
            } catch (error) {
                console.error('‚ùå Firebase initialization error:', error);
                useFirebase = false;
            }
        } else {
            console.log('‚ÑπÔ∏è Firebase not configured - using localStorage');
        }
        
        // ============================================
        // DATA SERVICE FUNCTIONS (Firebase or localStorage)
        // ============================================
        
        // Users Service
        async function getUsers() {
            if (useFirebase && db) {
                try {
                    const snapshot = await db.collection('users').get();
                    const users = {};
                    snapshot.forEach(doc => {
                        users[doc.id] = doc.data();
                    });
                    
                    // Ensure admin user exists
                    if (!users['admin']) {
                        await saveUser('admin', { password: 'admin123', role: 'master', name: 'Master Admin' });
                        users['admin'] = { password: 'admin123', role: 'master', name: 'Master Admin' };
                    }
                    
                    return users;
                } catch (error) {
                    console.error('Error loading users from Firebase:', error);
                    return getUsersLocalStorage();
                }
            } else {
                return getUsersLocalStorage();
            }
        }
        
        function getUsersLocalStorage() {
            const storedUsers = localStorage.getItem('warehouseUsers');
            if (storedUsers) {
                const parsedUsers = JSON.parse(storedUsers);
                const cleanedUsers = {};
                Object.keys(parsedUsers).forEach(username => {
                    if (username === 'admin') {
                        cleanedUsers[username] = parsedUsers[username];
                    } else if (!username.startsWith('warehouse_')) {
                        cleanedUsers[username] = parsedUsers[username];
                    }
                });
                
                if (!cleanedUsers['admin']) {
                    cleanedUsers['admin'] = { password: 'admin123', role: 'master', name: 'Master Admin' };
                }
                
                localStorage.setItem('warehouseUsers', JSON.stringify(cleanedUsers));
                return cleanedUsers;
            } else {
                const defaultUsers = {
                    'admin': { password: 'admin123', role: 'master', name: 'Master Admin' }
                };
                localStorage.setItem('warehouseUsers', JSON.stringify(defaultUsers));
                return defaultUsers;
            }
        }
        
        async function saveUser(username, userData) {
            if (useFirebase && db) {
                try {
                    await db.collection('users').doc(username).set(userData);
                    return true;
                } catch (error) {
                    console.error('Error saving user to Firebase:', error);
                    saveUserLocalStorage(username, userData);
                    return false;
                }
            } else {
                saveUserLocalStorage(username, userData);
                return true;
            }
        }
        
        function saveUserLocalStorage(username, userData) {
            const users = getUsersLocalStorage();
            users[username] = userData;
            localStorage.setItem('warehouseUsers', JSON.stringify(users));
        }
        
        async function deleteUserFirebase(username) {
            if (useFirebase && db) {
                try {
                    await db.collection('users').doc(username).delete();
                    return true;
                } catch (error) {
                    console.error('Error deleting user from Firebase:', error);
                    return false;
                }
            }
            return false;
        }
        
        // Expenses Service
        async function getExpenses() {
            if (useFirebase && db) {
                try {
                    const snapshot = await db.collection('expenses').orderBy('date', 'desc').get();
                    return snapshot.docs.map(doc => {
                        const data = doc.data();
                        // Reconstruct invoiceFile from flattened fields
                        if (data.invoiceFileName || data.invoiceFileData) {
                            data.invoiceFile = {
                                filename: data.invoiceFileName || null,
                                type: data.invoiceFileType || null,
                                size: data.invoiceFileSize || null,
                                data: data.invoiceFileData || null,
                                tooLarge: data.invoiceFileTooLarge || false
                            };
                            // Remove flattened fields
                            delete data.invoiceFileName;
                            delete data.invoiceFileType;
                            delete data.invoiceFileSize;
                            delete data.invoiceFileData;
                            delete data.invoiceFileTooLarge;
                        }
                        return { id: doc.id, ...data };
                    });
                } catch (error) {
                    console.error('Error loading expenses from Firebase:', error);
                    return getExpensesLocalStorage();
                }
            } else {
                return getExpensesLocalStorage();
            }
        }
        
        function getExpensesLocalStorage() {
            return JSON.parse(localStorage.getItem('warehouseExpenses')) || [];
        }
        
        async function saveExpense(expense) {
            if (useFirebase && db) {
                try {
                    // Clean the expense object - Firebase doesn't like undefined values
                    // Also flatten invoiceFile for Firebase compatibility
                    const cleanExpense = {};
                    Object.keys(expense).forEach(key => {
                        if (expense[key] !== undefined && expense[key] !== null) {
                            if (key === 'invoiceFile' && expense[key] && typeof expense[key] === 'object') {
                                // Flatten invoiceFile object for Firebase
                                cleanExpense['invoiceFileName'] = expense[key].filename || null;
                                cleanExpense['invoiceFileType'] = expense[key].type || null;
                                cleanExpense['invoiceFileSize'] = expense[key].size || null;
                                // Check base64 size before storing (Firestore 1MB limit = 1,048,487 bytes)
                                const base64Data = expense[key].data || null;
                                if (base64Data && base64Data.length > 1048487) {
                                    console.warn('Base64 data too large for Firestore, storing without file data');
                                    cleanExpense['invoiceFileData'] = null;
                                    cleanExpense['invoiceFileTooLarge'] = true;
                                } else {
                                    cleanExpense['invoiceFileData'] = base64Data;
                                }
                            } else {
                                cleanExpense[key] = expense[key];
                            }
                        }
                    });
                    
                    if (expense.id && typeof expense.id === 'string' && expense.id.length > 0) {
                        await db.collection('expenses').doc(expense.id).set(cleanExpense);
                    } else {
                        const docRef = await db.collection('expenses').add(cleanExpense);
                        expense.id = docRef.id;
                        cleanExpense.id = docRef.id;
                    }
                    // Also save to localStorage as backup (without large file data)
                    saveExpenseLocalStorage(expense, true); // Pass flag to skip large files
                    return true;
                } catch (error) {
                    console.error('Error saving expense to Firebase:', error);
                    console.error('Error details:', error.code, error.message);
                    // Fallback to localStorage (without large file data)
                    try {
                        saveExpenseLocalStorage(expense, true);
                    } catch (localError) {
                        console.error('Error saving to localStorage:', localError);
                        // If localStorage fails, at least the expense is saved in Firebase
                    }
                    throw error; // Re-throw to show error message
                }
            } else {
                saveExpenseLocalStorage(expense, true); // Skip large files in localStorage
                return true;
            }
        }
        
        function saveExpenseLocalStorage(expense, skipLargeFiles = false) {
            const expenses = getExpensesLocalStorage();
            
            // Create a copy of expense for localStorage
            const expenseForStorage = { ...expense };
            
            // If skipLargeFiles is true, remove base64 data to prevent quota exceeded
            if (skipLargeFiles && expenseForStorage.invoiceFile && expenseForStorage.invoiceFile.data) {
                expenseForStorage.invoiceFile = {
                    filename: expenseForStorage.invoiceFile.filename,
                    type: expenseForStorage.invoiceFile.type,
                    size: expenseForStorage.invoiceFile.size,
                    data: null // Don't store base64 in localStorage
                };
            }
            
            if (expense.id) {
                const index = expenses.findIndex(e => e.id === expense.id);
                if (index !== -1) {
                    expenses[index] = expenseForStorage;
                } else {
                    expenses.push(expenseForStorage);
                }
            } else {
                expenseForStorage.id = Date.now().toString();
                expenses.push(expenseForStorage);
            }
            
            try {
                localStorage.setItem('warehouseExpenses', JSON.stringify(expenses));
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    console.warn('localStorage quota exceeded. Storing expenses without file data.');
                    // Remove all file data from all expenses and try again
                    const expensesWithoutFiles = expenses.map(e => {
                        const exp = { ...e };
                        if (exp.invoiceFile && exp.invoiceFile.data) {
                            exp.invoiceFile = {
                                filename: exp.invoiceFile.filename,
                                type: exp.invoiceFile.type,
                                size: exp.invoiceFile.size,
                                data: null
                            };
                        }
                        return exp;
                    });
                    localStorage.setItem('warehouseExpenses', JSON.stringify(expensesWithoutFiles));
                } else {
                    throw error;
                }
            }
        }
        
        async function saveAllExpenses(expensesArray) {
            if (useFirebase && db) {
                try {
                    const batch = db.batch();
                    expensesArray.forEach(expense => {
                        // Flatten invoiceFile for Firebase
                        const cleanExpense = {};
                        Object.keys(expense).forEach(key => {
                            if (expense[key] !== undefined && expense[key] !== null) {
                                if (key === 'invoiceFile' && expense[key] && typeof expense[key] === 'object') {
                                    cleanExpense['invoiceFileName'] = expense[key].filename || null;
                                    cleanExpense['invoiceFileType'] = expense[key].type || null;
                                    cleanExpense['invoiceFileSize'] = expense[key].size || null;
                                    cleanExpense['invoiceFileData'] = expense[key].data || null;
                                } else {
                                    cleanExpense[key] = expense[key];
                                }
                            }
                        });
                        const docRef = db.collection('expenses').doc(expense.id);
                        batch.set(docRef, cleanExpense);
                    });
                    await batch.commit();
                    return true;
                } catch (error) {
                    console.error('Error saving expenses to Firebase:', error);
                    // Try to save to localStorage without large files
                    try {
                        const expensesWithoutFiles = expensesArray.map(e => {
                            const exp = { ...e };
                            if (exp.invoiceFile && exp.invoiceFile.data) {
                                exp.invoiceFile = {
                                    filename: exp.invoiceFile.filename,
                                    type: exp.invoiceFile.type,
                                    size: exp.invoiceFile.size,
                                    data: null
                                };
                            }
                            return exp;
                        });
                        localStorage.setItem('warehouseExpenses', JSON.stringify(expensesWithoutFiles));
                    } catch (localError) {
                        console.error('Error saving to localStorage:', localError);
                    }
                    return false;
                }
            } else {
                // Save to localStorage without large files
                const expensesWithoutFiles = expensesArray.map(e => {
                    const exp = { ...e };
                    if (exp.invoiceFile && exp.invoiceFile.data) {
                        exp.invoiceFile = {
                            filename: exp.invoiceFile.filename,
                            type: exp.invoiceFile.type,
                            size: exp.invoiceFile.size,
                            data: null
                        };
                    }
                    return exp;
                });
                localStorage.setItem('warehouseExpenses', JSON.stringify(expensesWithoutFiles));
                return true;
            }
        }
        
        async function deleteExpenseFirebase(expenseId) {
            if (useFirebase && db) {
                try {
                    await db.collection('expenses').doc(expenseId).delete();
                    return true;
                } catch (error) {
                    console.error('Error deleting expense from Firebase:', error);
                    return false;
                }
            }
            return false;
        }
        
        // Budgets Service
        async function getBudgets() {
            if (useFirebase && db) {
                try {
                    const snapshot = await db.collection('budgets').get();
                    const budgets = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const key = `${data.warehouse}_${data.month}`;
                        if (!budgets[key]) {
                            budgets[key] = {};
                        }
                        budgets[key][data.category] = data.amount;
                    });
                    return budgets;
                } catch (error) {
                    console.error('Error loading budgets from Firebase:', error);
                    return getBudgetsLocalStorage();
                }
            } else {
                return getBudgetsLocalStorage();
            }
        }
        
        function getBudgetsLocalStorage() {
            return JSON.parse(localStorage.getItem('warehouseBudgets')) || {};
        }
        
        async function saveBudget(warehouse, month, category, amount) {
            if (useFirebase && db) {
                try {
                    const budgetKey = `${warehouse}_${month}_${category}`;
                    await db.collection('budgets').doc(budgetKey).set({
                        warehouse: warehouse,
                        month: month,
                        category: category,
                        amount: amount
                    });
                    return true;
                } catch (error) {
                    console.error('Error saving budget to Firebase:', error);
                    saveBudgetLocalStorage(warehouse, month, category, amount);
                    return false;
                }
            } else {
                saveBudgetLocalStorage(warehouse, month, category, amount);
                return true;
            }
        }
        
        function saveBudgetLocalStorage(warehouse, month, category, amount) {
            const budgets = getBudgetsLocalStorage();
            const key = `${warehouse}_${month}`;
            if (!budgets[key]) {
                budgets[key] = {};
            }
            budgets[key][category] = amount;
            localStorage.setItem('warehouseBudgets', JSON.stringify(budgets));
        }
        
        async function saveAllBudgets(budgetsObj) {
            if (useFirebase && db) {
                try {
                    const batch = db.batch();
                    Object.keys(budgetsObj).forEach(key => {
                        const [warehouse, month] = key.split('_');
                        Object.keys(budgetsObj[key]).forEach(category => {
                            const budgetKey = `${warehouse}_${month}_${category}`;
                            const docRef = db.collection('budgets').doc(budgetKey);
                            batch.set(docRef, {
                                warehouse: warehouse,
                                month: month,
                                category: category,
                                amount: budgetsObj[key][category]
                            });
                        });
                    });
                    await batch.commit();
                    return true;
                } catch (error) {
                    console.error('Error saving budgets to Firebase:', error);
                    localStorage.setItem('warehouseBudgets', JSON.stringify(budgetsObj));
                    return false;
                }
            } else {
                localStorage.setItem('warehouseBudgets', JSON.stringify(budgetsObj));
                return true;
            }
        }
        
        // ============================================
        // User Management
        // ============================================
        
        // Initialize data (will be loaded asynchronously)
        let users = {};
        let currentUser = null;
        let currentWarehouse = null;
        let expenses = [];
        let budgets = {};
        let currentFilter = 'all';
        let currentApprovalFilter = 'all';
        
        // Load initial data
        (async function initializeData() {
            users = await getUsers();
            expenses = await getExpenses();
            budgets = await getBudgets();
            
            // Set up real-time listener for expenses (Firebase only)
            if (useFirebase && db) {
                db.collection('expenses').orderBy('date', 'desc').onSnapshot(snapshot => {
                    expenses = snapshot.docs.map(doc => {
                        const data = doc.data();
                        // Reconstruct invoiceFile from flattened fields
                        if (data.invoiceFileName || data.invoiceFileData) {
                            data.invoiceFile = {
                                filename: data.invoiceFileName || null,
                                type: data.invoiceFileType || null,
                                size: data.invoiceFileSize || null,
                                data: data.invoiceFileData || null,
                                tooLarge: data.invoiceFileTooLarge || false
                            };
                            // Remove flattened fields
                            delete data.invoiceFileName;
                            delete data.invoiceFileType;
                            delete data.invoiceFileSize;
                            delete data.invoiceFileData;
                            delete data.invoiceFileTooLarge;
                        }
                        return { id: doc.id, ...data };
                    });
                    if (currentUser) {
                        displayExpenses();
                        updateSummary();
                        // Refresh approvals if on approvals tab
                        if (document.getElementById('approvals').classList.contains('active')) {
                            displayApprovals();
                        }
                    }
                });
            }
        })();
        
        // Custom Modal Functions
        function customAlert(message) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('customModalOverlay');
                const title = document.getElementById('customModalTitle');
                const body = document.getElementById('customModalMessage');
                const footer = document.getElementById('customModalFooter');
                
                title.textContent = 'myTVS Expenses Management';
                body.textContent = message;
                footer.innerHTML = '<button class="custom-modal-btn custom-modal-btn-primary" onclick="closeCustomModal(); window.customModalResolve(true);">OK</button>';
                
                overlay.classList.add('show');
                
                // Close on overlay click
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        closeCustomModal();
                        resolve(true);
                    }
                };
                
                window.customModalResolve = resolve;
            });
        }
        
        function customConfirm(message) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('customModalOverlay');
                const title = document.getElementById('customModalTitle');
                const body = document.getElementById('customModalMessage');
                const footer = document.getElementById('customModalFooter');
                
                title.textContent = 'myTVS Expenses Management';
                body.textContent = message;
                footer.innerHTML = `
                    <button class="custom-modal-btn custom-modal-btn-secondary" onclick="closeCustomModal(); window.customModalResolve(false);">Cancel</button>
                    <button class="custom-modal-btn custom-modal-btn-primary" onclick="closeCustomModal(); window.customModalResolve(true);">OK</button>
                `;
                
                overlay.classList.add('show');
                
                // Close on overlay click (cancel)
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        closeCustomModal();
                        resolve(false);
                    }
                };
                
                window.customModalResolve = resolve;
            });
        }
        
        function closeCustomModal() {
            const overlay = document.getElementById('customModalOverlay');
            overlay.classList.remove('show');
        }
        
        // Override native alert and confirm
        window.alert = customAlert;
        window.confirm = customConfirm;
        
        // Helper function to check if user has access to a warehouse
        function hasWarehouseAccess(user, warehouse) {
            if (!user.warehouse || user.warehouse === '') {
                return true; // Empty means all warehouses
            }
            const userWarehouses = user.warehouse.split(',');
            return userWarehouses.includes(warehouse);
        }

        // Initialize
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('expenseTime').value = new Date().toTimeString().slice(0, 5);
        document.getElementById('budgetMonth').value = new Date().toISOString().slice(0, 7);
        
        // Initialize warehouse field visibility
        if (document.getElementById('newRole')) {
            toggleWarehouseField();
        }
        
        // Toast notification function
        function showToast(type, title, message) {
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || '‚ÑπÔ∏è'}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Ensure users are loaded
            if (Object.keys(users).length === 0) {
                users = await getUsers();
            }
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                currentWarehouse = users[username].warehouse || null;
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                document.getElementById('currentUser').textContent = users[username].name;
                document.getElementById('userRole').textContent = users[username].role.toUpperCase();
                document.getElementById('userRole').className = `user-role ${users[username].role}`;
                
                // Show features based on role
                if (users[username].role === 'master') {
                    // Master: Full access
                    document.getElementById('warehouseSelector').style.display = 'block';
                    document.getElementById('usersTab').style.display = 'block';
                    document.getElementById('approvalsTab').style.display = 'block';
                    // Reload users to ensure cleanup is applied
                    users = await getUsers();
                    loadUsers();
                } else if (users[username].role === 'approver') {
                    // Approver: All access except user creation
                    document.getElementById('warehouseSelector').style.display = 'block';
                    document.getElementById('usersTab').style.display = 'none';
                    document.getElementById('approvalsTab').style.display = 'block';
                    // Set warehouse selector to 'all' if approver has multiple or all warehouses
                    if (!users[username].warehouse || users[username].warehouse === '' || users[username].warehouse.includes(',')) {
                        document.getElementById('warehouseSelect').value = 'all';
                        currentWarehouse = 'all';
                } else {
                        // Single warehouse assignment
                        document.getElementById('warehouseSelect').value = users[username].warehouse;
                        currentWarehouse = users[username].warehouse;
                    }
                } else {
                    // Warehouse: Entry only
                    document.getElementById('warehouseSelector').style.display = 'none';
                    document.getElementById('usersTab').style.display = 'none';
                    document.getElementById('approvalsTab').style.display = 'none';
                }
                
                // Load data (ensure expenses and budgets are loaded)
                expenses = await getExpenses();
                budgets = await getBudgets();
                displayExpenses();
                updateSummary();
            } else {
                await customAlert('Invalid username or password!');
            }
        });

        // Logout functionality
        function logout() {
            currentUser = null;
            currentWarehouse = null;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        }
        
        // Clear storage functionality
        async function clearStorage() {
            const confirmed = await customConfirm('This will delete all data including expenses and users. Are you sure?');
            if (confirmed) {
                localStorage.clear();
                await customAlert('Storage cleared! Page will reload.');
                location.reload();
            }
        }

        // Switch warehouse (for master users)
        function switchWarehouse() {
            currentWarehouse = document.getElementById('warehouseSelect').value;
            if (currentWarehouse === 'all') currentWarehouse = null;
            displayExpenses();
            updateSummary();
        }

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'list') displayExpenses();
            if (tabName === 'summary') {
                updateSummary();
            }
            if (tabName === 'users') {
                loadUsers();
            }
            if (tabName === 'approvals') {
                // Reload expenses to ensure latest data (especially for Firebase)
                (async () => {
                    expenses = await getExpenses();
                    displayApprovals();
                })();
            }
            if (tabName === 'budget') {
                loadBudgetVisualization();
                loadBudgetManagement();
            }
        }

        // Form submission
        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const vendorName = document.getElementById('vendorName').value;
            const paymentMode = document.getElementById('paymentMode').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const invoiceFile = document.getElementById('invoiceFile').files[0];
            const expenseAmount = parseFloat(document.getElementById('expenseAmount').value);
            const expenseDate = document.getElementById('expenseDate').value;
            
            // Validate required fields
            if (!vendorName || vendorName.trim() === '') {
                showToast('error', 'Validation Error', 'Vendor Name is required.');
                return;
            }
            
            if (!paymentMode) {
                showToast('error', 'Validation Error', 'Payment Mode is required.');
                return;
            }
            
            if (!invoiceNumber || invoiceNumber.trim() === '') {
                showToast('error', 'Validation Error', 'Invoice Number is required.');
                return;
            }
            
            // Invoice number format validation - only alphanumeric, spaces, hyphens, underscores, and forward slashes allowed
            const invoiceNumberPattern = /^[a-zA-Z0-9\s\-_\/]+$/;
            if (!invoiceNumberPattern.test(invoiceNumber)) {
                showToast('error', 'Invalid Invoice Number', 'Invoice number can only contain letters, numbers, spaces, hyphens (-), underscores (_), and forward slashes (/). Special characters like @, #, $, %, & are not allowed.');
                return;
            }
            
            if (!invoiceFile) {
                showToast('error', 'Validation Error', 'Invoice Document is required.');
                return;
            }
            
            // File size validation for Firebase Firestore (1MB limit per field)
            // Base64 encoding increases size by ~33%, so limit original file to ~750KB
            const maxFileSizeForFirestore = 750 * 1024; // 750KB
            const maxFileSizeGeneral = 10 * 1024 * 1024; // 10MB for non-Firebase
            
            if (useFirebase && db) {
                // For Firebase, limit to 750KB to stay within 1MB base64 limit
                if (invoiceFile.size > maxFileSizeForFirestore) {
                    const fileSizeMB = (invoiceFile.size / (1024 * 1024)).toFixed(2);
                    showToast('error', 'File Size Error', `File size (${fileSizeMB}MB) is too large for Firebase. Maximum size is 750KB (~1MB when encoded). Please compress the file or use a smaller file.`);
                    return;
                }
            } else {
                // For localStorage, limit to 10MB
                if (invoiceFile.size > maxFileSizeGeneral) {
                showToast('error', 'File Size Error', 'Invoice file size must be less than 10MB.');
                return;
                }
            }
            
            // Amount validation
            if (expenseAmount <= 0) {
                showToast('error', 'Validation Error', 'Amount must be greater than zero.');
                return;
            }
            
            // Maximum amount limit (‚Çπ1,000,000)
            if (expenseAmount > 1000000) {
                showToast('error', 'Amount Limit Exceeded', 'Maximum allowed amount is ‚Çπ10,00,000. Please contact admin for approval.');
                return;
            }
            
            // Date validation - cannot be more than 30 days in the future
            const today = new Date();
            const maxDate = new Date(today);
            maxDate.setDate(today.getDate() + 30);
            const submittedDate = new Date(expenseDate);
            
            if (submittedDate > maxDate) {
                showToast('error', 'Date Error', 'Expense date cannot be more than 30 days in the future.');
                return;
            }
            
            // Date validation - cannot be older than 45 days
            const minDate = new Date(today);
            minDate.setDate(today.getDate() - 45);
            
            if (submittedDate < minDate) {
                showToast('error', 'Date Error', 'Invoice date cannot be older than 45 days.');
                return;
            }
            
            // Function to convert file to base64
            const convertFileToBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            };
            
            // Process the form submission
            const processSubmission = async () => {
                // Determine the warehouse
                // For warehouse users, use first assigned warehouse; for others use selector or default
                let warehouse;
                if (users[currentUser].role === 'warehouse') {
                    const userWarehouses = users[currentUser].warehouse ? users[currentUser].warehouse.split(',') : [];
                    warehouse = userWarehouses.length > 0 ? userWarehouses[0] : 'warehouse_1';
                } else {
                    warehouse = currentWarehouse || 'warehouse_1';
                }
                
                // Check for duplicate invoice number in the same warehouse
                if (invoiceNumber && invoiceNumber.trim() !== '') {
                    const normalizedInvoiceNumber = invoiceNumber.trim();
                    const duplicateExists = expenses.some(expense => 
                        expense.warehouse === warehouse && 
                        expense.invoiceNumber && 
                        expense.invoiceNumber.trim() === normalizedInvoiceNumber
                    );
                    
                    if (duplicateExists) {
                        showToast('error', 'Duplicate Invoice', `Invoice number "${normalizedInvoiceNumber}" already exists in ${warehouse}. Please use a different invoice number.`);
                        return;
                    }
                }
                
                // Check for multiple expenses from same vendor on same day (possible fraud detection)
                const vendorNameLower = vendorName.toLowerCase();
                const sameDaySameVendor = expenses.filter(expense => 
                    expense.warehouse === warehouse && 
                    expense.vendorName && 
                    expense.vendorName.toLowerCase() === vendorNameLower &&
                    expense.date === expenseDate
                );
                
                if (sameDaySameVendor.length >= 3) {
                    const confirmed = await customConfirm(`Warning: This will be the ${sameDaySameVendor.length + 1} expense from vendor "${vendorName}" on ${expenseDate}. Are you sure you want to continue?`);
                    if (!confirmed) {
                        return;
                    }
                }
                
                let invoiceData = null;
                if (invoiceFile) {
                    try {
                        const base64 = await convertFileToBase64(invoiceFile);
                        invoiceData = {
                            filename: invoiceFile.name,
                            type: invoiceFile.type,
                            size: invoiceFile.size,
                            data: base64
                        };
                    } catch (error) {
                        showToast('error', 'Error', 'Failed to upload invoice file. Please try again.');
                        return;
                    }
                }
                
                const expense = {
                    id: String(Date.now()), // Convert to string for Firebase compatibility
                    date: document.getElementById('expenseDate').value,
                    time: document.getElementById('expenseTime').value,
                    category: document.getElementById('expenseCategory').value,
                    amount: expenseAmount,
                    vendorName: vendorName,
                    paymentMode: paymentMode,
                    invoiceNumber: invoiceNumber || null,
                    invoiceFile: invoiceData,
                    description: document.getElementById('expenseDescription').value || '',
                    warehouse: warehouse,
                    createdBy: currentUser,
                    createdAt: new Date().toISOString(),
                    status: 'pending',
                    approvedBy: null,
                    approvedAt: null
                };
                
                expenses.push(expense);
                await saveExpense(expense);
                
                // Reload expenses from Firebase to ensure invoice file is properly structured
                if (useFirebase && db) {
                    expenses = await getExpenses();
                }
                
                document.getElementById('expenseForm').reset();
                document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('expenseTime').value = new Date().toTimeString().slice(0, 5);
                
                showToast('info', 'Expense Submitted', 'Awaiting approval from Master Admin.');
                displayExpenses();
                updateSummary();
                // Refresh approvals if on approvals tab
                if (document.getElementById('approvals').classList.contains('active')) {
                    displayApprovals();
                }
            };
            
            processSubmission().catch(error => {
                console.error('Error in processSubmission:', error);
                const errorMessage = error.message || 'An error occurred while submitting the expense.';
                showToast('error', 'Submission Error', errorMessage);
                // Also try to save to localStorage as fallback
                console.log('Attempting to save to localStorage as fallback...');
            });
        });

        // Filter expenses
        function filterExpenses(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displayExpenses();
        }

        // Display expenses
        function displayExpenses() {
            const expenseList = document.getElementById('expenseList');
            let filteredExpenses = expenses;
            
            // Filter by warehouse based on user role
            if (users[currentUser].role === 'warehouse') {
                // Warehouse users: only see their assigned warehouse expenses
                filteredExpenses = filteredExpenses.filter(expense => {
                    const warehouseMatch = hasWarehouseAccess(users[currentUser], expense.warehouse);
                    const statusMatch = expense.status === 'approved' || expense.status === 'pending' || !expense.status;
                    return warehouseMatch && statusMatch;
                });
            } else if (users[currentUser].role === 'approver') {
                // Approver: see warehouses based on their assignment
                if (currentWarehouse && currentWarehouse !== 'all') {
                    // Filter by warehouse selector if set
                    if (hasWarehouseAccess(users[currentUser], currentWarehouse)) {
                        filteredExpenses = filteredExpenses.filter(expense => expense.warehouse === currentWarehouse);
                    } else {
                        filteredExpenses = []; // No access to selected warehouse
                    }
                } else if (users[currentUser].warehouse && users[currentUser].warehouse !== '') {
                    // Filter by approver's warehouse assignment
                    const userWarehouses = users[currentUser].warehouse.split(',');
                    filteredExpenses = filteredExpenses.filter(expense => userWarehouses.includes(expense.warehouse));
                }
                // If approver has no warehouse assignment (empty), show all
            } else if (currentWarehouse && currentWarehouse !== 'all') {
                // Master users can filter by specific warehouse
                filteredExpenses = filteredExpenses.filter(expense => expense.warehouse === currentWarehouse);
            }
            // If master/approver selects 'all' or no filter, show all expenses (or assigned warehouses)
            
            // Apply date filter
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch(currentFilter) {
                case 'daily':
                    filteredExpenses = filteredExpenses.filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate >= today;
                    });
                    break;
                case 'weekly':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    filteredExpenses = filteredExpenses.filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate >= weekStart;
                    });
                    break;
                case 'monthly':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    filteredExpenses = filteredExpenses.filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate >= monthStart;
                    });
                    break;
            }
            
            filteredExpenses.sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
            
            if (filteredExpenses.length === 0) {
                expenseList.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üìù</div>
                        <h3>No expenses found</h3>
                        <p>Start adding expenses to see them here!</p>
                    </div>
                `;
                return;
            }
            
            expenseList.innerHTML = filteredExpenses.map(expense => `
                <div class="expense-card">
                    <button class="delete-btn" onclick="deleteExpense(${expense.id})" title="Delete">√ó</button>
                    <div class="expense-header">
                        <div>
                            <span class="expense-category">${expense.category}</span>
                            <span class="warehouse-badge">${expense.warehouse}</span>
                            <span class="approval-status ${expense.status}">${expense.status.toUpperCase()}</span>
                        </div>
                        <span class="expense-amount">‚Çπ${expense.amount.toFixed(2)}</span>
                    </div>
                    <div class="expense-details">
                        üìÖ ${new Date(expense.date).toLocaleDateString()} at ${expense.time}
                        ${expense.vendorName ? `<br>üè™ Vendor: <strong>${expense.vendorName}</strong>` : ''}
                        ${expense.paymentMode ? `<br>üí≥ Payment: <strong>${expense.paymentMode}</strong>` : ''}
                        ${expense.invoiceNumber ? `<br>üßæ Invoice: <strong>${expense.invoiceNumber}</strong>` : ''}
                        ${expense.approvedBy ? `<br>‚úÖ Approved by: <strong>${users[expense.approvedBy]?.name || 'Approver'}</strong>` : ''}
                    </div>
                    ${expense.description ? `<div class="expense-description">${expense.description}</div>` : ''}
                    ${expense.invoiceFile ? `
                        <div style="margin-top: 10px;">
                            <button onclick="downloadInvoiceFile(${expense.id})" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                üìé Download Invoice
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // View invoice file in new tab
        function viewInvoiceFile(id) {
            try {
                // Convert id to string if needed
                const expenseId = String(id);
                const expense = expenses.find(e => String(e.id) === expenseId);
                if (!expense) {
                    showToast('error', 'Error', 'Expense not found');
                    console.error('Expense not found. ID:', expenseId);
                    return;
                }
                
                if (!expense.invoiceFile) {
                    showToast('error', 'Error', 'Invoice file not found for this expense');
                    return;
                }
            
                if (!expense.invoiceFile.data) {
                    showToast('error', 'Error', 'Invoice file data is not available. The file may be too large or was not uploaded.');
                    console.log('Invoice file info:', {
                        filename: expense.invoiceFile.filename,
                        type: expense.invoiceFile.type,
                        size: expense.invoiceFile.size,
                        hasData: !!expense.invoiceFile.data
                    });
                    return;
                }
            
            // Open invoice in new tab/window
            const newWindow = window.open();
            if (newWindow) {
                newWindow.document.write(`
                    <html>
                        <head>
                            <title>${expense.invoiceFile.filename}</title>
                            <style>
                                body { margin: 0; padding: 20px; background: #f5f5f5; }
                                .container { max-width: 100%; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                                img { max-width: 100%; height: auto; }
                                iframe { width: 100%; height: 80vh; border: none; }
                                .header { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0; }
                                .header h2 { margin: 0; color: #333; }
                                .header p { margin: 5px 0 0 0; color: #666; font-size: 14px; }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <div class="header">
                                    <h2>üìÑ ${expense.invoiceFile.filename}</h2>
                                    <p>Invoice #${expense.invoiceNumber || 'N/A'} | Vendor: ${expense.vendorName || 'N/A'} | Amount: ‚Çπ${expense.amount.toFixed(2)}</p>
                                </div>
                                ${expense.invoiceFile.type === 'application/pdf' 
                                    ? `<iframe src="${expense.invoiceFile.data}"></iframe>`
                                    : `<img src="${expense.invoiceFile.data}" alt="${expense.invoiceFile.filename}">`
                                }
                            </div>
                        </body>
                    </html>
                `);
            } else {
                showToast('error', 'Error', 'Please allow pop-ups to view the invoice');
            }
            } catch (error) {
                console.error('Error viewing invoice:', error);
                showToast('error', 'Error', 'Failed to view invoice: ' + error.message);
            }
        }

        // Download invoice file
        function downloadInvoiceFile(id) {
            try {
                // Convert id to string if needed
                const expenseId = String(id);
                const expense = expenses.find(e => String(e.id) === expenseId);
                if (!expense) {
                    showToast('error', 'Error', 'Expense not found');
                    console.error('Expense not found. ID:', expenseId);
                    return;
                }
                
                if (!expense.invoiceFile) {
                    showToast('error', 'Error', 'Invoice file not found for this expense');
                    return;
                }
            
                if (!expense.invoiceFile.data) {
                    showToast('error', 'Error', 'Invoice file data is not available. The file may be too large or was not uploaded.');
                return;
            }
            
            const link = document.createElement('a');
            link.href = expense.invoiceFile.data;
            link.download = expense.invoiceFile.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            } catch (error) {
                console.error('Error downloading invoice:', error);
                showToast('error', 'Error', 'Failed to download invoice: ' + error.message);
            }
        }

        // Delete expense
        async function deleteExpense(id) {
            const confirmed = await customConfirm('Are you sure you want to delete this expense?');
            if (confirmed) {
                expenses = expenses.filter(expense => expense.id !== id);
                await deleteExpenseFirebase(id);
                await saveAllExpenses(expenses);
                displayExpenses();
                updateSummary();
            }
        }

        // Update summary with date filter
        function updateSummaryWithDateFilter() {
            updateSummary();
        }

        // Update summary
        function updateSummary() {
            let filteredExpenses = expenses;
            
            // Apply date filters if provided
            const fromDate = document.getElementById('summaryFromDate')?.value;
            const toDate = document.getElementById('summaryToDate')?.value;
            
            if (fromDate) {
                filteredExpenses = filteredExpenses.filter(expense => expense.date >= fromDate);
            }
            if (toDate) {
                filteredExpenses = filteredExpenses.filter(expense => expense.date <= toDate);
            }
            
            // Filter by warehouse based on user role
            if (users[currentUser].role === 'warehouse') {
                // Warehouse users: only see their assigned warehouse approved expenses
                filteredExpenses = filteredExpenses.filter(expense => 
                    hasWarehouseAccess(users[currentUser], expense.warehouse) && expense.status === 'approved'
                );
            } else if (users[currentUser].role === 'approver') {
                // Approver: filter by warehouse selector or warehouse mapping
                if (currentWarehouse && currentWarehouse !== 'all') {
                    if (hasWarehouseAccess(users[currentUser], currentWarehouse)) {
                        filteredExpenses = filteredExpenses.filter(expense => expense.warehouse === currentWarehouse);
                    } else {
                        filteredExpenses = [];
                    }
                } else if (users[currentUser].warehouse && users[currentUser].warehouse !== '') {
                    const userWarehouses = users[currentUser].warehouse.split(',');
                    filteredExpenses = filteredExpenses.filter(expense => userWarehouses.includes(expense.warehouse));
                }
            } else if (currentWarehouse && currentWarehouse !== 'all') {
                // Master users can filter by specific warehouse
                filteredExpenses = filteredExpenses.filter(expense => expense.warehouse === currentWarehouse);
            }
            // If master/approver selects 'all' or no filter, show all expenses (or assigned warehouses)
            
            const totalAmount = filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalCount = filteredExpenses.length;
            const averageAmount = totalCount > 0 ? totalAmount / totalCount : 0;
            
            // Calculate date range
            let dateRangeText = '-';
            let lastExpenseDateText = '-';
            
            if (filteredExpenses.length > 0) {
                const dates = filteredExpenses.map(e => new Date(e.date)).sort((a, b) => a - b);
                const earliestDate = dates[0];
                const latestDate = dates[dates.length - 1];
                
                if (earliestDate.getTime() === latestDate.getTime()) {
                    dateRangeText = earliestDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                } else {
                    dateRangeText = `${earliestDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' })} - ${latestDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}`;
                }
                
                lastExpenseDateText = latestDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
            }
            
            // Update summary elements with error handling
            const totalAmountEl = document.getElementById('totalAmount');
            const totalCountEl = document.getElementById('totalCount');
            const averageAmountEl = document.getElementById('averageAmount');
            const dateRangeEl = document.getElementById('dateRange');
            const lastExpenseDateEl = document.getElementById('lastExpenseDate');
            
            if (totalAmountEl) totalAmountEl.textContent = `‚Çπ${totalAmount.toFixed(2)}`;
            if (totalCountEl) totalCountEl.textContent = totalCount;
            if (averageAmountEl) averageAmountEl.textContent = `‚Çπ${averageAmount.toFixed(2)}`;
            if (dateRangeEl) dateRangeEl.textContent = dateRangeText;
            if (lastExpenseDateEl) lastExpenseDateEl.textContent = lastExpenseDateText;
            
            // Date-wise breakdown
            const dateWiseSummary = {};
            filteredExpenses.forEach(expense => {
                if (!dateWiseSummary[expense.date]) {
                    dateWiseSummary[expense.date] = { count: 0, total: 0 };
                }
                dateWiseSummary[expense.date].count++;
                dateWiseSummary[expense.date].total += expense.amount;
            });
            
            const dateWiseDiv = document.getElementById('dateWiseSummary');
            if (Object.keys(dateWiseSummary).length === 0) {
                dateWiseDiv.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">No expenses to analyze</p>';
            } else {
                const sortedDates = Object.keys(dateWiseSummary).sort().reverse(); // Most recent first
                dateWiseDiv.innerHTML = sortedDates.map(date => {
                    const data = dateWiseSummary[date];
                    const dateObj = new Date(date);
                    const formattedDate = dateObj.toLocaleDateString('en-IN', { 
                        weekday: 'long', 
                        day: '2-digit', 
                        month: 'short', 
                        year: 'numeric' 
                    });
                    return `
                        <div class="date-wise-item">
                            <div class="date-info">
                                <div class="date-label">${formattedDate}</div>
                                <div class="date-details">Entries on this date</div>
                            </div>
                            <div class="date-stats">
                                <div class="entries-count">${data.count} entries</div>
                                <div class="expense-total">‚Çπ${data.total.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Category breakdown
            const categoryBreakdown = {};
            filteredExpenses.forEach(expense => {
                categoryBreakdown[expense.category] = (categoryBreakdown[expense.category] || 0) + expense.amount;
            });
            
            const categoryBreakdownDiv = document.getElementById('categoryBreakdown');
            if (Object.keys(categoryBreakdown).length === 0) {
                categoryBreakdownDiv.innerHTML = '<p style="text-align: center; color: #6c757d;">No expenses to analyze</p>';
            } else {
                categoryBreakdownDiv.innerHTML = Object.entries(categoryBreakdown)
                    .sort((a, b) => b[1] - a[1])
                    .map(([category, amount]) => `
                        <div class="category-item">
                            <span class="category-name">${category}</span>
                            <span class="category-amount">‚Çπ${amount.toFixed(2)}</span>
                        </div>
                    `).join('');
            }
        }

        // Budget functions
        let uploadedBudgetData = {};
        
        function loadBudgetManagement() {
            // Show budget management for master and approver users
            if (users[currentUser].role === 'warehouse') {
                document.getElementById('budgetManagementSection').style.display = 'none';
                return;
            }
            
            document.getElementById('budgetManagementSection').style.display = 'block';
            document.getElementById('budgetPreview').style.display = 'none';
        }
        
        async function saveUploadedBudgets() {
            const warehouse = document.getElementById('budgetWarehouse').value;
            const month = document.getElementById('budgetMonth').value;
            const budgetKey = `${warehouse}_${month}`;
            
            budgets[budgetKey] = uploadedBudgetData;
            
            // Save each budget entry to Firebase or localStorage
            for (const [category, amount] of Object.entries(uploadedBudgetData)) {
                await saveBudget(warehouse, month, category, amount);
            }
            
            await customAlert('‚úÖ Budgets saved successfully!');
            document.getElementById('budgetPreview').style.display = 'none';
            uploadedBudgetData = {};
            loadBudgetVisualization();
        }
        
        function loadBudgetVisualization() {
            const warehouse = document.getElementById('budgetWarehouse').value;
            const month = document.getElementById('budgetMonth').value;
            
            // Get expenses for the selected month and warehouse
            const monthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                const expenseMonth = expenseDate.toISOString().slice(0, 7);
                return expense.warehouse === warehouse && expense.status === 'approved' && expenseMonth === month;
            });
            
            // Calculate category-wise expenses
            const categoryExpenses = {};
            monthExpenses.forEach(expense => {
                if (!categoryExpenses[expense.category]) {
                    categoryExpenses[expense.category] = 0;
                }
                categoryExpenses[expense.category] += expense.amount;
            });
            
            // Get budgets for the selected warehouse and month
            const budgetKey = `${warehouse}_${month}`;
            const warehouseBudget = budgets[budgetKey] || {};
            
            // Render pie chart
            renderPieChart(categoryExpenses, warehouseBudget);
            
            // Render bar chart
            renderBarChart(categoryExpenses, warehouseBudget);
            
            // Render budget summary
            renderBudgetSummary(categoryExpenses, warehouseBudget, warehouse);
        }
        
        function renderPieChart(categoryExpenses, budgets) {
            const canvas = document.createElement('canvas');
            canvas.id = 'pieChart';
            canvas.width = 400;
            canvas.height = 400;
            
            document.getElementById('pieChartContainer').innerHTML = '';
            document.getElementById('pieChartContainer').appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            const centerX = 200;
            const centerY = 200;
            const radius = 150;
            
            // Get all categories
            const categories = new Set([...Object.keys(categoryExpenses), ...Object.keys(budgets)]);
            const categoriesArray = Array.from(categories);
            
            if (categoriesArray.length === 0) {
                ctx.font = '20px Arial';
                ctx.fillText('No data available', 100, 200);
                return;
            }
            
            // Draw pie chart
            ctx.clearRect(0, 0, 400, 400);
            
            const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#fa709a', '#ffecd2', '#fcb69f'];
            let startAngle = 0;
            
            categoriesArray.forEach((category, index) => {
                const expenseAmount = categoryExpenses[category] || 0;
                const budgetAmount = budgets[category] || 0;
                const totalAmount = budgetAmount > 0 ? (expenseAmount / budgetAmount) * 100 : 0;
                const sliceAngle = (totalAmount / 100) * 2 * Math.PI;
                
                // Draw slice
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();
                
                // Draw label
                const labelAngle = startAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
                const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.fillText(category, labelX - 30, labelY);
                
                startAngle += sliceAngle;
            });
            
            // Draw legend
            let yPos = 50;
            categoriesArray.forEach((category, index) => {
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(10, yPos, 15, 15);
                ctx.fillStyle = 'black';
                ctx.font = '12px Arial';
                ctx.fillText(category + `: ‚Çπ${categoryExpenses[category] || 0} / ‚Çπ${budgets[category] || 0}`, 30, yPos + 12);
                yPos += 20;
            });
        }
        
        function renderBarChart(categoryExpenses, budgets) {
            const canvas = document.createElement('canvas');
            canvas.id = 'barChart';
            canvas.width = 600;
            canvas.height = 400;
            
            document.getElementById('barChartContainer').innerHTML = '';
            document.getElementById('barChartContainer').appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            
            // Get all categories
            const categories = new Set([...Object.keys(categoryExpenses), ...Object.keys(budgets)]);
            const categoriesArray = Array.from(categories);
            
            if (categoriesArray.length === 0) {
                ctx.font = '20px Arial';
                ctx.fillText('No data available', 200, 200);
                return;
            }
            
            const barWidth = 80;
            const barSpacing = 10;
            const startX = 50;
            const chartHeight = 300;
            const startY = 350;
            const maxValue = Math.max(...categoriesArray.map(cat => Math.max(categoryExpenses[cat] || 0, budgets[cat] || 0)));
            const scale = chartHeight / maxValue;
            
            ctx.clearRect(0, 0, 600, 400);
            
            categoriesArray.forEach((category, index) => {
                const x = startX + index * (barWidth + barSpacing);
                const expenseAmount = categoryExpenses[category] || 0;
                const budgetAmount = budgets[category] || 0;
                
                // Draw budget bar
                ctx.fillStyle = '#667eea';
                const budgetHeight = budgetAmount * scale;
                ctx.fillRect(x, startY - budgetHeight, barWidth / 2 - 2, budgetHeight);
                
                // Draw expense bar
                ctx.fillStyle = expenseAmount > budgetAmount ? '#dc3545' : '#28a745';
                const expenseHeight = expenseAmount * scale;
                ctx.fillRect(x + barWidth / 2, startY - expenseHeight, barWidth / 2 - 2, expenseHeight);
                
                // Draw labels
                ctx.fillStyle = 'black';
                ctx.font = '10px Arial';
                ctx.save();
                ctx.translate(x + barWidth / 2, startY + 15);
                ctx.rotate(-Math.PI / 4);
                ctx.fillText(category, 0, 0);
                ctx.restore();
            });
        }
        
        function renderBudgetSummary(categoryExpenses, budgets, warehouse) {
            const summaryList = document.getElementById('budgetSummaryList');
            
            // Get all categories
            const categories = new Set([...Object.keys(categoryExpenses), ...Object.keys(budgets)]);
            const categoriesArray = Array.from(categories);
            
            if (categoriesArray.length === 0) {
                summaryList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">No budget data available. Set budgets to start tracking.</p>';
                return;
            }
            
            summaryList.innerHTML = categoriesArray.map(category => {
                const expenseAmount = categoryExpenses[category] || 0;
                const budgetAmount = budgets[category] || 0;
                const percentage = budgetAmount > 0 ? (expenseAmount / budgetAmount) * 100 : 0;
                const remaining = budgetAmount - expenseAmount;
                const isOverBudget = expenseAmount > budgetAmount;
                
                return `
                    <div class="budget-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h4 style="margin: 0;">${category}</h4>
                            <span style="font-size: 14px; color: #6c757d;">${percentage.toFixed(1)}% used</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                            <span>Budget: ‚Çπ${budgetAmount.toFixed(2)}</span>
                            <span>Spent: ‚Çπ${expenseAmount.toFixed(2)}</span>
                            <span class="budget-remaining ${remaining >= 0 ? 'positive' : 'negative'}">
                                ${remaining >= 0 ? 'Remaining' : 'Over'} ‚Çπ${Math.abs(remaining).toFixed(2)}
                            </span>
                        </div>
                        <div class="budget-progress">
                            <div class="budget-progress-bar ${isOverBudget ? 'over-budget' : 'under-budget'}" 
                                 style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Budget Excel Upload Functions
        async function downloadBudgetTemplate() {
            const categories = ['Pooja', 'Tea', 'Petrol', 'Lunch', 'Travel', 'Freight', 'Maintenance', 'Utilities', 'Supplies', 'Other'];
            const csvContent = [
                'Category,Budget',
                ...categories.map(cat => `${cat},0`)
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'budget_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            await customAlert('‚úÖ Template downloaded! Fill in the budget values and upload.');
        }
        
        function uploadBudgetFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                
                // Parse CSV
                uploadedBudgetData = {};
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const [category, budget] = line.split(',');
                    if (category && budget) {
                        const budgetValue = parseFloat(budget);
                        if (!isNaN(budgetValue) && budgetValue > 0) {
                            uploadedBudgetData[category.trim()] = budgetValue;
                        }
                    }
                }
                
                // Show preview
                showBudgetPreview();
                event.target.value = ''; // Reset file input
            };
            
            reader.readAsText(file);
        }
        
        async function showBudgetPreview() {
            const previewDiv = document.getElementById('budgetPreview');
            const previewListDiv = document.getElementById('budgetPreviewList');
            
            if (Object.keys(uploadedBudgetData).length === 0) {
                await customAlert('‚ùå No valid budget data found in the CSV file.');
                return;
            }
            
            previewListDiv.innerHTML = Object.entries(uploadedBudgetData)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .map(([category, budget]) => `
                    <div style="display: flex; justify-content: space-between; padding: 10px; margin-bottom: 5px; background: #f8f9fa; border-radius: 5px;">
                        <span style="font-weight: 600;">${category}</span>
                        <span style="color: #28a745;">‚Çπ${budget.toFixed(2)}</span>
                    </div>
                `).join('');
            
            previewDiv.style.display = 'block';
        }
        
        function exportBudgetsToCSV() {
            const warehouse = document.getElementById('budgetWarehouse').value;
            const month = document.getElementById('budgetMonth').value;
            const budgetKey = `${warehouse}_${month}`;
            const warehouseBudget = budgets[budgetKey] || {};
            
            const csvContent = [
                'Category,Budget',
                ...Object.entries(warehouseBudget).map(([category, budget]) => `${category},${budget}`)
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `budget_${warehouse}_${month}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Toggle warehouse field based on role
        function toggleWarehouseField() {
            const role = document.getElementById('newRole').value;
            const warehouseFieldGroup = document.getElementById('warehouseFieldGroup');
            const warehouseSelect = document.getElementById('newWarehouse');
            
            warehouseFieldGroup.style.display = 'block';
            
            if (role === 'warehouse') {
                // Warehouse role requires at least one warehouse
                warehouseSelect.required = true;
            } else {
                // Master and Approver can have all warehouses (empty) or specific ones
                warehouseSelect.required = false;
            }
        }

        // Load users (Master Admin only)
        async function loadUsers() {
            // Refresh users from database
            users = await getUsers();
            const userList = document.getElementById('userList');
            userList.innerHTML = Object.entries(users).map(([username, user]) => `
                <div class="user-card">
                    <h4>${user.name}</h4>
                    <p><strong>Username:</strong> ${username}</p>
                    <p><strong>Employee Code:</strong> ${user.employeeCode || 'N/A'}</p>
                    <p><strong>Role:</strong> <span class="user-role ${user.role}">${user.role.toUpperCase()}</span></p>
                    <p><strong>Warehouse:</strong> ${user.warehouse && user.warehouse !== '' ? (user.warehouse.includes(',') ? user.warehouse.split(',').join(', ') : user.warehouse) : 'All Warehouses'}</p>
                    <button onclick="deleteUser('${username}')" class="btn btn-danger" style="width: 100%; margin-top: 10px; padding: 8px;">üóëÔ∏è Delete User</button>
                </div>
            `).join('');
        }
        
        // Add new user form handler
        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const name = document.getElementById('newName').value;
            const employeeCode = document.getElementById('newEmployeeCode').value;
            const role = document.getElementById('newRole').value;
            const warehouseSelect = document.getElementById('newWarehouse');
            
            // Get selected warehouses (multiple selection)
            const selectedWarehouses = Array.from(warehouseSelect.selectedOptions).map(option => option.value);
            const warehouse = selectedWarehouses.length > 0 ? selectedWarehouses.join(',') : '';
            
            if (users[username]) {
                await customAlert('‚ùå Username already exists!');
                return;
            }
            
            // Validate warehouse is required for warehouse role
            if (role === 'warehouse' && selectedWarehouses.length === 0) {
                await customAlert('‚ùå At least one warehouse is required for warehouse entry users!');
                return;
            }
            
            users[username] = {
                password: password,
                role: role,
                name: name,
                employeeCode: employeeCode,
                warehouse: warehouse // Store as comma-separated string or empty for "all"
            };
            
            await saveUser(username, users[username]);
            
            await customAlert(`‚úÖ User "${name}" created successfully!`);
            
            // Reset form
            this.reset();
            
            // Reload user list
            users = await getUsers();
            loadUsers();
        });
        
        async function deleteUser(username) {
            if (username === 'admin') {
                await customAlert('‚ùå Cannot delete master admin user!');
                return;
            }
            
            const confirmed = await customConfirm(`Are you sure you want to delete user "${users[username].name}"?`);
            if (confirmed) {
                delete users[username];
                await deleteUserFirebase(username);
                // Also save to localStorage as backup
                localStorage.setItem('warehouseUsers', JSON.stringify(users));
                await customAlert('‚úÖ User deleted successfully!');
                users = await getUsers();
                loadUsers();
            }
        }

        // Approval functions
        function getRemainingBudget(warehouse, category, month) {
            // Get budget for the warehouse and month
            const budgetKey = `${warehouse}_${month}`;
            const warehouseBudget = budgets[budgetKey] || {};
            const budgetAmount = warehouseBudget[category] || 0;
            
            // Get total approved expenses for this category in the month
            const monthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                const expenseMonth = expenseDate.toISOString().slice(0, 7);
                return expense.warehouse === warehouse && 
                       expense.status === 'approved' && 
                       expense.category === category &&
                       expenseMonth === month;
            });
            
            const spentAmount = monthExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            return {
                budget: budgetAmount,
                spent: spentAmount,
                remaining: budgetAmount - spentAmount
            };
        }
        
        function displayApprovals() {
            const approvalsList = document.getElementById('approvalsList');
            let pendingExpenses = expenses.filter(expense => expense.status === 'pending');
            
            // Filter by warehouse based on user role
            if (users[currentUser].role === 'approver' && users[currentUser].warehouse && users[currentUser].warehouse !== '') {
                // Approver with warehouse mapping: only see their assigned warehouses
                const userWarehouses = users[currentUser].warehouse.split(',');
                pendingExpenses = pendingExpenses.filter(expense => userWarehouses.includes(expense.warehouse));
            } else if (currentApprovalFilter !== 'all') {
                // Filter by warehouse selector
                if (users[currentUser].role === 'approver' && !hasWarehouseAccess(users[currentUser], currentApprovalFilter)) {
                    pendingExpenses = [];
                } else {
                pendingExpenses = pendingExpenses.filter(expense => expense.warehouse === currentApprovalFilter);
                }
            }
            
            if (pendingExpenses.length === 0) {
                approvalsList.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 4rem; margin-bottom: 20px;">‚úÖ</div>
                        <h3>No pending approvals</h3>
                        <p>All expenses have been reviewed!</p>
                    </div>
                `;
                return;
            }
            
            approvalsList.innerHTML = pendingExpenses.map(expense => {
                // Get the month from expense date (YYYY-MM format)
                const expenseMonth = expense.date.substring(0, 7);
                const budgetInfo = getRemainingBudget(expense.warehouse, expense.category, expenseMonth);
                
                // Calculate what remaining budget will be if this is approved
                const projectedRemaining = budgetInfo.remaining - expense.amount;
                const isOverBudget = projectedRemaining < 0;
                
                let budgetDisplay = '';
                if (budgetInfo.budget > 0) {
                    budgetDisplay = `
                        <div style="background: ${isOverBudget ? '#fee' : '#e8f5e9'}; padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 3px solid ${isOverBudget ? '#dc3545' : '#28a745'};">
                            <strong style="display: block; margin-bottom: 6px;">üí∞ Budget Information for ${expense.category}:</strong>
                            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 4px;">
                                <span>Allocated Budget:</span>
                                <strong>‚Çπ${budgetInfo.budget.toFixed(2)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 4px;">
                                <span>Already Spent:</span>
                                <strong>‚Çπ${budgetInfo.spent.toFixed(2)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 4px;">
                                <span>Current Remaining:</span>
                                <strong>‚Çπ${budgetInfo.remaining.toFixed(2)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 14px; font-weight: bold; padding-top: 6px; border-top: 1px solid ${isOverBudget ? '#fcc' : '#c8e6c9'};">
                                <span style="color: ${isOverBudget ? '#dc3545' : '#28a745'}">After Approval Remaining:</span>
                                <strong style="color: ${isOverBudget ? '#dc3545' : '#28a745'}">
                                    ‚Çπ${projectedRemaining.toFixed(2)} 
                                    ${isOverBudget ? '‚ö†Ô∏è' : '‚úÖ'}
                                </strong>
                            </div>
                        </div>
                    `;
                } else {
                    budgetDisplay = `
                        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 3px solid #ffc107;">
                            <strong style="color: #856404;">‚ö†Ô∏è No budget set for ${expense.category} this month</strong>
                        </div>
                    `;
                }
                
                return `
                <div class="approval-card">
                    <div class="expense-header">
                        <div>
                            <span class="expense-category">${expense.category}</span>
                            <span class="warehouse-badge">${expense.warehouse}</span>
                            <span class="approval-status ${expense.status}">${expense.status.toUpperCase()}</span>
                        </div>
                        <span class="expense-amount">‚Çπ${expense.amount.toFixed(2)}</span>
                    </div>
                    <div class="expense-details">
                        üìÖ ${new Date(expense.date).toLocaleDateString()} at ${expense.time}
                        ${expense.vendorName ? `<br>üè™ Vendor: <strong>${expense.vendorName}</strong>` : ''}
                        ${expense.paymentMode ? `<br>üí≥ Payment: <strong>${expense.paymentMode}</strong>` : ''}
                        ${expense.invoiceNumber ? `<br>üßæ Invoice: <strong>${expense.invoiceNumber}</strong>` : ''}
                        <br>üë§ Created by: ${users[expense.createdBy]?.name || expense.createdBy}
                    </div>
                    ${expense.description ? `<div class="expense-description">${expense.description}</div>` : ''}
                    ${expense.invoiceFile ? `
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            ${expense.invoiceFile.data ? `
                                <button onclick="viewInvoiceFile('${expense.id}')" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    üëÅÔ∏è View Invoice
                                </button>
                                <button onclick="downloadInvoiceFile('${expense.id}')" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                üìé Download Invoice
                            </button>
                            ` : `
                                <div style="background: #fff3cd; padding: 8px 12px; border-radius: 6px; border-left: 3px solid #ffc107; color: #856404; font-size: 12px;">
                                    ‚ö†Ô∏è Invoice file not available (file may be too large)
                                </div>
                            `}
                        </div>
                    ` : ''}
                    ${budgetDisplay}
                    <div class="approval-actions">
                        <button class="approval-btn approve-btn" onclick="approveExpense('${expense.id}')">‚úÖ Approve</button>
                        <button class="approval-btn reject-btn" onclick="rejectExpense('${expense.id}')">‚ùå Reject</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function filterApprovals(filter) {
            currentApprovalFilter = filter;
            document.querySelectorAll('#approvals .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displayApprovals();
        }

        async function approveExpense(id) {
            try {
                    // Convert id to string if needed
                    const expenseId = String(id);
                    const expense = expenses.find(e => String(e.id) === expenseId);
                    if (!expense) {
                        showToast('error', 'Error', 'Expense not found');
                        console.error('Expense not found. ID:', expenseId, 'Available IDs:', expenses.map(e => e.id));
                        return;
                    }
                    
                    // Create a more informative confirmation message
                    const confirmMessage = `Confirm Approval\n\n` +
                        `Amount: ‚Çπ${expense.amount.toFixed(2)}\n` +
                        `Vendor: ${expense.vendorName || 'N/A'}\n` +
                        `Category: ${expense.category}\n` +
                        `Warehouse: ${expense.warehouse}\n\n` +
                        `Do you want to approve this expense?`;
                    
            const confirmed = await customConfirm(confirmMessage);
            if (confirmed) {
                    expense.status = 'approved';
                    expense.approvedBy = currentUser;
                    expense.approvedAt = new Date().toISOString();
                    await saveExpense(expense);
                    displayApprovals();
                    displayExpenses();
                    updateSummary();
                    showToast('success', 'Success', 'Expense approved successfully!');
                }
            } catch (error) {
                console.error('Error approving expense:', error);
                showToast('error', 'Error', 'Failed to approve expense: ' + error.message);
            }
        }

        async function rejectExpense(id) {
            try {
                    // Convert id to string if needed
                    const expenseId = String(id);
                    const expense = expenses.find(e => String(e.id) === expenseId);
                    if (!expense) {
                        showToast('error', 'Error', 'Expense not found');
                        console.error('Expense not found. ID:', expenseId, 'Available IDs:', expenses.map(e => e.id));
                        return;
                    }
                    
                    // Create a more informative confirmation message
                    const confirmMessage = `Confirm Rejection\n\n` +
                        `Amount: ‚Çπ${expense.amount.toFixed(2)}\n` +
                        `Vendor: ${expense.vendorName || 'N/A'}\n` +
                        `Category: ${expense.category}\n` +
                        `Warehouse: ${expense.warehouse}\n\n` +
                        `Do you want to reject this expense?`;
                    
            const confirmed = await customConfirm(confirmMessage);
            if (confirmed) {
                    expense.status = 'rejected';
                    expense.approvedBy = currentUser;
                    expense.approvedAt = new Date().toISOString();
                    await saveExpense(expense);
                    displayApprovals();
                    showToast('success', 'Success', 'Expense rejected successfully!');
                }
            } catch (error) {
                console.error('Error rejecting expense:', error);
                showToast('error', 'Error', 'Failed to reject expense: ' + error.message);
            }
        }

        // Download functions
        function downloadCSV() {
            let filteredExpenses = getFilteredExpenses();
            const csv = convertToCSV(filteredExpenses);
            downloadFile(csv, 'expenses.csv', 'text/csv');
        }

        function downloadJSON() {
            let filteredExpenses = getFilteredExpenses();
            const json = JSON.stringify(filteredExpenses, null, 2);
            downloadFile(json, 'expenses.json', 'application/json');
        }

        function downloadPDF() {
            let filteredExpenses = getFilteredExpenses();
            const pdfContent = generatePDFContent(filteredExpenses);
            downloadFile(pdfContent, 'expense-report.txt', 'text/plain');
        }

        function getFilteredExpenses() {
            let filteredExpenses = expenses;
            
            // Filter by warehouse - Master users can see all or specific warehouse, warehouse users only see their own
            if (users[currentUser].role === 'warehouse') {
                // Warehouse users: only see their assigned warehouse approved expenses
                filteredExpenses = filteredExpenses.filter(expense => 
                    hasWarehouseAccess(users[currentUser], expense.warehouse) && expense.status === 'approved'
                );
            } else if (users[currentUser].role === 'approver') {
                // Approver: filter by warehouse selector or warehouse mapping
                if (currentWarehouse && currentWarehouse !== 'all') {
                    if (hasWarehouseAccess(users[currentUser], currentWarehouse)) {
                        filteredExpenses = filteredExpenses.filter(expense => expense.warehouse === currentWarehouse);
                    } else {
                        filteredExpenses = [];
                    }
                } else if (users[currentUser].warehouse && users[currentUser].warehouse !== '') {
                    const userWarehouses = users[currentUser].warehouse.split(',');
                    filteredExpenses = filteredExpenses.filter(expense => userWarehouses.includes(expense.warehouse));
                }
            } else if (currentWarehouse && currentWarehouse !== 'all') {
                // Master users can filter by specific warehouse
                filteredExpenses = filteredExpenses.filter(expense => expense.warehouse === currentWarehouse);
            }
            // If master/approver selects 'all' or no filter, show all expenses (or assigned warehouses)
            
            // Apply date filters
            const fromDate = document.getElementById('downloadFromDate').value;
            const toDate = document.getElementById('downloadToDate').value;
            const category = document.getElementById('downloadCategory').value;
            
            if (fromDate) {
                filteredExpenses = filteredExpenses.filter(expense => expense.date >= fromDate);
            }
            if (toDate) {
                filteredExpenses = filteredExpenses.filter(expense => expense.date <= toDate);
            }
            if (category) {
                filteredExpenses = filteredExpenses.filter(expense => expense.category === category);
            }
            
            return filteredExpenses;
        }

        function convertToCSV(expenses) {
            const headers = ['Date', 'Time', 'Category', 'Amount', 'Vendor Name', 'Payment Mode', 'Invoice Number', 'Description', 'Warehouse', 'Created By', 'Status', 'Approved By', 'Approved At'];
            const csvContent = [
                headers.join(','),
                ...expenses.map(expense => [
                    expense.date,
                    expense.time,
                    expense.category,
                    expense.amount,
                    expense.vendorName || '',
                    expense.paymentMode || '',
                    expense.invoiceNumber || '',
                    `"${expense.description || ''}"`,
                    expense.warehouse,
                    users[expense.createdBy]?.name || expense.createdBy,
                    expense.status || 'pending',
                    expense.approvedBy ? (users[expense.approvedBy]?.name || 'Approver') : '',
                    expense.approvedAt || ''
                ].join(','))
            ].join('\n');
            return csvContent;
        }

        function generatePDFContent(expenses) {
            const totalAmount = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            return `
WAREHOUSE EXPENSE REPORT
Generated: ${new Date().toLocaleString()}
User: ${currentUser}
Warehouse: ${currentWarehouse || 'All'}

SUMMARY:
Total Expenses: ‚Çπ${totalAmount.toFixed(2)}
Total Entries: ${expenses.length}

DETAILED EXPENSES:
${expenses.map(expense => `
Date: ${expense.date} ${expense.time}
Category: ${expense.category}
Amount: ‚Çπ${expense.amount.toFixed(2)}
${expense.vendorName ? `Vendor: ${expense.vendorName}` : ''}
${expense.paymentMode ? `Payment Mode: ${expense.paymentMode}` : ''}
${expense.invoiceNumber ? `Invoice: ${expense.invoiceNumber}` : ''}
${expense.invoiceFile ? `Invoice File: ${expense.invoiceFile.filename}` : ''}
Description: ${expense.description || 'N/A'}
Warehouse: ${expense.warehouse}
Created By: ${users[expense.createdBy]?.name || expense.createdBy}
Status: ${expense.status || 'pending'}
${expense.approvedBy ? `Approved By: ${users[expense.approvedBy]?.name || 'Approver'}` : ''}
${expense.approvedAt ? `Approved At: ${new Date(expense.approvedAt).toLocaleString()}` : ''}
---`).join('')}
            `;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
