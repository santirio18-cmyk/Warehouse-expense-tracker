<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCM Petty Cash Expense Management System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’°</text></svg>">
    <!-- Updated: Removed demo user info from login -->
    
    <!-- Firebase SDK - Lazy loaded for better performance -->
    <script>
        // Lazy load Firebase SDK only when needed
        let firebaseLoaded = false;
        async function loadFirebaseSDK() {
            if (firebaseLoaded) return;
            const scripts = [
                'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js',
                'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js',
                'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js'
            ];
            for (const src of scripts) {
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.async = true;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
            firebaseLoaded = true;
        }
    </script>
    
    <!-- EmailJS SDK for email notifications -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
            position: relative;
            overflow-x: hidden;
        }
        
        /* myTVS Color Scheme */
        :root {
            --mytvs-orange: #FF6600;
            --mytvs-blue: #003366;
            --mytvs-blue-light: #004d99;
            --mytvs-gray: #f5f5f5;
            --mytvs-white: #ffffff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
            color: #003366;
            background: var(--mytvs-white);
            border: 3px solid var(--mytvs-orange);
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 4px 15px rgba(255, 102, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--mytvs-orange) 0%, var(--mytvs-blue) 100%);
        }

        .logo {
            margin-bottom: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo img {
            max-height: 60px;
            width: auto;
        }

        .logo-text {
            font-size: 2rem;
            font-weight: bold;
            font-family: 'Arial', sans-serif;
            letter-spacing: -1px;
        }

        .logo-text .my {
            color: #FF6600;
            text-transform: lowercase;
        }

        .logo-text .tvs {
            color: #003366;
            text-transform: uppercase;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: #003366;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom: 2px solid var(--mytvs-orange);
            padding-bottom: 8px;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
            font-weight: 500;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 50px auto;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .password-input-wrapper {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            padding: 6px 10px;
            z-index: 10;
            transition: all 0.3s ease;
        }
        
        .password-toggle:hover {
            background: var(--mytvs-orange);
            color: white;
            border-color: var(--mytvs-orange);
        }
        
        .password-input-wrapper input {
            padding-right: 45px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--mytvs-orange);
            background: white;
            box-shadow: 0 0 0 3px rgba(255, 102, 0, 0.1);
        }

        .btn {
            background: var(--mytvs-orange);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);
            width: 100%;
        }

        .btn:hover {
            background: #e55a00;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 102, 0, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            background: var(--mytvs-white);
            border-radius: 12px;
            padding: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-tab {
            padding: 12px 20px;
            margin: 0 3px;
            background: transparent;
            border: none;
            color: var(--mytvs-blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
            font-size: 16px;
        }

        .nav-tab.active {
            background: var(--mytvs-orange);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);
        }

        .nav-tab:hover {
            background: rgba(255, 102, 0, 0.1);
            color: var(--mytvs-orange);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-info {
            background: var(--mytvs-blue);
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            font-weight: 600;
        }
        
        .user-info strong {
            font-size: 15px;
            font-weight: 700;
        }

        .warehouse-selector {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px solid #e1e5e9;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .warehouse-selector h3 {
            font-size: 16px;
            font-weight: 700;
            color: #003366;
            margin-bottom: 10px;
        }
        
        .warehouse-selector select {
            font-size: 15px;
            font-weight: 600;
            padding: 10px 15px;
            width: 100%;
            max-width: 400px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: white;
            color: #003366;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .warehouse-selector select:hover {
            border-color: var(--mytvs-orange);
            box-shadow: 0 0 0 3px rgba(255, 102, 0, 0.1);
        }
        
        .warehouse-selector select:focus {
            outline: none;
            border-color: var(--mytvs-orange);
            box-shadow: 0 0 0 3px rgba(255, 102, 0, 0.2);
        }

        .expense-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
            padding-right: 50px;
        }

        .expense-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .expense-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 10px;
        }

        .expense-category {
            background: var(--mytvs-orange);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .expense-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .expense-details {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .expense-description {
            color: #495057;
            font-style: italic;
        }

        .warehouse-badge {
            background: var(--mytvs-blue);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: var(--mytvs-blue);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 51, 102, 0.3);
        }

        .summary-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .summary-card p {
            opacity: 0.9;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 25px 30px;
            border-radius: 15px;
            margin-bottom: 25px;
        }
        
        .filter-section h3 {
            margin-bottom: 18px;
            font-size: 18px;
            font-weight: 700;
            color: #003366;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 12px 24px;
            border: 2px solid var(--mytvs-orange);
            background: transparent;
            color: var(--mytvs-orange);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 15px;
        }

        .filter-btn.active {
            background: var(--mytvs-orange);
            color: white;
        }

        .filter-btn:hover {
            background: var(--mytvs-orange);
            color: white;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .delete-btn:hover {
            background: #ff5252;
            transform: scale(1.1);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .download-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #28a745;
        }

        .download-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .user-management {
            background: #fff3cd;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
        }

        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .user-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .user-role {
            background: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .user-role.master {
            background: #dc3545;
        }

        .user-role.approver {
            background: #ffc107;
            color: #000;
        }

        .user-role.warehouse {
            background: #28a745;
        }

        .approval-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .approval-status.pending {
            background: #ffc107;
            color: #000;
        }

        .approval-status.first_approved {
            background: #ff9800;
            color: white;
        }

        .approval-status.approved {
            background: #28a745;
            color: white;
        }

        .approval-status.rejected {
            background: #dc3545;
            color: white;
        }

        .approval-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .approval-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .approve-btn {
            background: var(--mytvs-orange);
            color: white;
        }

        .approve-btn:hover {
            background: #e55a00;
        }

        .reject-btn {
            background: #dc3545;
            color: white;
        }

        .reject-btn:hover {
            background: #c82333;
        }

        .approval-card {
            background: var(--mytvs-white);
            border: 2px solid var(--mytvs-orange);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .approval-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 102, 0, 0.2);
        }

        .category-breakdown {
            margin-top: 0;
        }

        .date-wise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .date-wise-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(5px);
            transition: all 0.3s ease;
        }

        .date-info {
            flex: 1;
        }

        .date-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .date-details {
            font-size: 14px;
            color: #6c757d;
        }

        .date-stats {
            text-align: right;
            margin-left: 20px;
        }

        .entries-count {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .expense-total {
            font-size: 20px;
            font-weight: bold;
            color: #28a745;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-container h3 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #2a5298;
            padding-bottom: 10px;
        }

        .budget-summary-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .budget-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid #2a5298;
        }

        .budget-progress {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .budget-progress-bar {
            height: 100%;
            transition: width 0.3s ease;
        }

        .budget-progress-bar.under-budget {
            background: #28a745;
        }

        .budget-progress-bar.over-budget {
            background: #dc3545;
        }

        .budget-stat {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 14px;
        }

        .budget-remaining.positive {
            color: #28a745;
        }

        .budget-remaining.negative {
            color: #dc3545;
        }

        .budget-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .budget-input-group label {
            flex: 0 0 150px;
            font-weight: 600;
        }

        .budget-input-group input {
            flex: 1;
        }

        /* Toast Notifications */
        /* Custom Modal Dialog */
        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .custom-modal-overlay.show {
            display: flex;
        }

        .custom-modal {
            background: white;
            border-radius: 15px;
            padding: 0;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .custom-modal-header {
            background: var(--mytvs-blue);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            font-weight: 600;
            font-size: 18px;
        }

        .custom-modal-body {
            padding: 25px;
            color: #333;
            white-space: pre-line;
            line-height: 1.6;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .custom-modal-body select {
            z-index: 10001;
            position: relative;
        }

        .custom-modal-footer {
            padding: 15px 25px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .custom-modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .custom-modal-btn-primary {
            background: var(--mytvs-orange);
            color: white;
        }

        .custom-modal-btn-primary:hover {
            background: #e55a00;
        }

        .custom-modal-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .custom-modal-btn-secondary:hover {
            background: #5a6268;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
        
        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
            border-left: 4px solid;
        }
        
        .toast.success { border-left-color: #28a745; }
        .toast.error { border-left-color: #dc3545; }
        .toast.info { border-left-color: #17a2b8; }
        .toast.warning { border-left-color: #ffc107; }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }
        
        .toast-icon {
            font-size: 24px;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 14px;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .chart-container {
                grid-template-columns: 1fr !important;
            }
            
            .toast {
                min-width: 280px;
                right: 10px;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 5px;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .filter-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Toast Container -->
        <div id="toastContainer" class="toast-container"></div>
        
        <!-- Custom Modal Dialog -->
        <div id="customModalOverlay" class="custom-modal-overlay">
            <div class="custom-modal">
                <div class="custom-modal-header" id="customModalTitle">SCM Petty Cash Expense Management System</div>
                <div class="custom-modal-body" id="customModalMessage"></div>
                <div class="custom-modal-footer" id="customModalFooter"></div>
            </div>
        </div>
        
        <!-- Login Screen -->
        <div id="loginScreen" class="login-container">
            <div class="login-form">
                <div class="logo" style="margin-bottom: 20px;">
                    <!-- Option 1: Use image logo (if you have myTVS-logo.png in the same folder) -->
                    <!-- <img src="myTVS-logo.png" alt="myTVS Logo"> -->
                    
                    <!-- Option 2: CSS-based logo -->
                    <div class="logo-text">
                        <span class="my">my</span><span class="tvs">TVS</span>
                    </div>
                </div>
                <h2>Login to Expense Tracker</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" id="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <div class="password-input-wrapper">
                        <input type="password" id="password" required>
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility()" title="Show/Hide Password">
                                <span id="passwordToggleIcon">Show</span>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="btn">Login</button>
                </form>
            </div>
        </div>

        <!-- Main Application -->
        <div id="mainApp" style="display: none;">
            <div class="header">
                <div class="logo">
                    <!-- Option 1: Use image logo (if you have myTVS-logo.png in the same folder) -->
                    <!-- <img src="myTVS-logo.png" alt="myTVS Logo"> -->
                    
                    <!-- Option 2: CSS-based logo -->
                    <div class="logo-text">
                        <span class="my">my</span><span class="tvs">TVS</span>
                    </div>
                </div>
                <h1>SCM Petty Cash Expense Management System</h1>
                <p>Multi-User Petty Cash Expense Management System</p>
            </div>

            <div class="user-info">
                <div>
                    <strong>Welcome, <span id="currentUser"></span></strong>
                </div>
                <button onclick="logout()" class="btn btn-danger" style="width: auto; padding: 8px 16px;">Logout</button>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('add')">âž• Add Expense</button>
                <button class="nav-tab" onclick="showTab('list')">ðŸ“‹ Expense List</button>
                <button class="nav-tab" onclick="showTab('summary')">ðŸ“Š Summary</button>
                <button class="nav-tab" onclick="showTab('budget')">ðŸ’° Budget</button>
                <button class="nav-tab" onclick="showTab('approvals')" id="approvalsTab" style="display: none;">âœ… Approvals</button>
                <button class="nav-tab" onclick="showTab('download')">ðŸ“¥ Download</button>
                <button class="nav-tab" onclick="showTab('users')" id="usersTab" style="display: none;">ðŸ‘¥ Users</button>
            </div>

            <!-- Warehouse Selector for Master Users -->
            <div id="warehouseSelector" class="warehouse-selector" style="display: none;">
                <h3>Select Warehouse to View:</h3>
                <select id="warehouseSelect" onchange="switchWarehouse()">
                    <option value="warehouse_1">Salem</option>
                    <option value="warehouse_2">Vellore</option>
                    <option value="warehouse_3">Chennai Tyre</option>
                    <option value="warehouse_4">Chennai Woods Road</option>
                    <option value="warehouse_5">Bangalore Tyre</option>
                    <option value="warehouse_6">Yeswanthpur</option>
                    <option value="warehouse_7">Hubli</option>
                    <option value="warehouse_8">Mangalore</option>
                    <option value="warehouse_9">Hyderabad</option>
                    <option value="warehouse_10">Vijayawada</option>
                    <option value="warehouse_11">Vishakapatinam</option>
                    <option value="warehouse_12">Kolkata</option>
                    <option value="warehouse_13">Patna</option>
                    <option value="warehouse_14">Raipur</option>
                    <option value="warehouse_15">Bhubaneshwar</option>
                    <option value="warehouse_16">Pune</option>
                    <option value="warehouse_17">Bhiwandi</option>
                    <option value="warehouse_18">Nagpur</option>
                    <option value="warehouse_19">Ahmedabad</option>
                    <option value="warehouse_20">Gurgaon</option>
                    <option value="warehouse_21">Jaipur</option>
                    <option value="warehouse_22">Lucknow</option>
                    <option value="warehouse_23">Ghaziabad</option>
                    <option value="warehouse_24">Manjumel</option>
                    <option value="warehouse_25">Namakal</option>
                    <option value="warehouse_26">Madurai Aritapatti</option>
                    <option value="warehouse_27">Madurai Ellis Nagar</option>
                    <option value="warehouse_28">Bhopal</option>
                </select>
            </div>

            <!-- Add Expense Tab -->
            <div id="add" class="tab-content active">
                <h2>Add New Expense</h2>
                <form id="expenseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseDate">Date</label>
                            <input type="date" id="expenseDate" required max="">
                        </div>
                        <div class="form-group">
                            <label for="expenseTime">Time</label>
                            <input type="time" id="expenseTime" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseCategory">Category</label>
                            <select id="expenseCategory" required>
                                <option value="Pooja">Pooja</option>
                                <option value="Tea">Tea</option>
                                <option value="Water">Water</option>
                                <option value="Petrol">Petrol</option>
                                <option value="Lunch">Lunch</option>
                                <option value="Travel">Travel</option>
                                <option value="Freight">Freight</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Supplies">Supplies</option>
                                <option value="Rent">Rent</option>
                                <option value="Staff Transportation">Staff Transportation</option>
                                <option value="Staff Welfare">Staff Welfare</option>
                                <option value="Electricity">Electricity</option>
                                <option value="Stationary">Stationary</option>
                                <option value="MHE Rental">MHE Rental</option>
                                <option value="Packing Material">Packing Material</option>
                                <option value="Internet / Broadband">Internet / Broadband</option>
                                <option value="Diesel Generator">Diesel Generator</option>
                                <option value="AMC">AMC</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expenseAmount">Amount (â‚¹)</label>
                            <input type="number" id="expenseAmount" step="0.01" min="0" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="vendorName">Vendor Name *</label>
                            <input type="text" id="vendorName" required placeholder="Enter vendor/supplier name">
                        </div>
                        <div class="form-group">
                            <label for="paymentMode">Payment Mode *</label>
                            <select id="paymentMode" required>
                                <option value="">Select payment mode</option>
                                <option value="Cash">Cash</option>
                                <option value="UPI">UPI</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Debit Card">Debit Card</option>
                                <option value="Net Banking">Net Banking</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="invoiceNumber">Invoice Number *</label>
                        <input type="text" id="invoiceNumber" required placeholder="Enter invoice number (e.g., INV-2024/001)">
                        <small style="color: #6c757d; font-size: 14px; display: block; margin-top: 5px;">Allowed: Letters, Numbers, Spaces, -, _, /</small>
                    </div>

                    <div class="form-group">
                        <label for="invoiceFile">Invoice Document (PDF/JPEG) *</label>
                        <input type="file" id="invoiceFile" accept=".pdf,.jpg,.jpeg,.png" required>
                        <small style="color: #6c757d; font-size: 14px; display: block; margin-top: 5px;">Supported formats: PDF, JPG, JPEG, PNG (Max size: 750KB for Firebase, 10MB for local storage)</small>
                    </div>

                    <div class="form-group">
                        <label for="expenseDescription">Description (Optional)</label>
                        <textarea id="expenseDescription" rows="3" placeholder="Add any additional details..."></textarea>
                    </div>

                    <button type="submit" class="btn">Add Expense</button>
                </form>
            </div>

            <!-- Expense List Tab -->
            <div id="list" class="tab-content">
                <h2>Expense List</h2>
                
                <div class="filter-section">
                    <h3>Filter Expenses</h3>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterExpenses('all')">All</button>
                        <button class="filter-btn" onclick="filterExpenses('daily')">Today</button>
                        <button class="filter-btn" onclick="filterExpenses('weekly')">This Week</button>
                        <button class="filter-btn" onclick="filterExpenses('monthly')">This Month</button>
                    </div>
                </div>

                <div id="expenseList">
                    <!-- Expenses will be populated here -->
                </div>
            </div>

            <!-- Summary Tab -->
            <div id="summary" class="tab-content">
                <h2>Expense Summary</h2>
                
                <div class="filter-section">
                    <h3>Filter by Date</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="summaryFromDate">From Date</label>
                            <input type="date" id="summaryFromDate">
                        </div>
                        <div class="form-group">
                            <label for="summaryToDate">To Date</label>
                            <input type="date" id="summaryToDate">
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button class="btn" onclick="updateSummaryWithDateFilter()" style="margin-bottom: 0;">Apply Filter</button>
                        </div>
                    </div>
                </div>
                
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3 id="totalAmount">â‚¹0.00</h3>
                        <p>Total Expenses</p>
                    </div>
                    <div class="summary-card">
                        <h3 id="totalCount">0</h3>
                        <p>Total Entries</p>
                    </div>
                    <div class="summary-card">
                        <h3 id="averageAmount">â‚¹0.00</h3>
                        <p>Average per Entry</p>
                    </div>
                    <div class="summary-card">
                        <h3 id="dateRange">-</h3>
                        <p>Date Range</p>
                    </div>
                    <div class="summary-card">
                        <h3 id="lastExpenseDate">-</h3>
                        <p>Last Expense</p>
                    </div>
                </div>

                <div class="category-breakdown">
                    <h3>Date-wise Summary</h3>
                    <div id="dateWiseSummary">
                        <!-- Date-wise breakdown will be populated here -->
                    </div>
                </div>

                <div class="category-breakdown" style="margin-top: 30px;">
                    <h3>Category Breakdown</h3>
                    <div id="categoryBreakdown">
                        <!-- Category breakdown will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Approvals Tab (Master Users Only) -->
            <div id="approvals" class="tab-content">
                <h2>Expense Approvals</h2>
                
                <div class="filter-section">
                    <h3>Filter Pending Approvals</h3>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterApprovals('all')">All Pending</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_1')">Salem</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_2')">Vellore</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_3')">Chennai Tyre</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_4')">Chennai Woods Road</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_5')">Bangalore Tyre</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_6')">Yeswanthpur</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_7')">Hubli</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_8')">Mangalore</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_9')">Hyderabad</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_10')">Vijayawada</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_11')">Vishakapatinam</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_12')">Kolkata</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_13')">Patna</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_14')">Raipur</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_15')">Bhubaneshwar</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_16')">Pune</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_17')">Bhiwandi</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_18')">Nagpur</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_19')">Ahmedabad</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_20')">Gurgaon</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_21')">Jaipur</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_22')">Lucknow</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_23')">Ghaziabad</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_24')">Manjumel</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_25')">Namakal</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_26')">Madurai Aritapatti</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_27')">Madurai Ellis Nagar</button>
                        <button class="filter-btn" onclick="filterApprovals('warehouse_28')">Bhopal</button>
                    </div>
                </div>

                <div id="approvalsList">
                    <!-- Pending approvals will be populated here -->
                </div>
            </div>

            <!-- Budget Tab -->
            <div id="budget" class="tab-content">
                <h2>ðŸ’° Budget Management & Visualization</h2>
                
                <div class="filter-section">
                    <h3>Select Warehouse</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="budgetWarehouse">Warehouse</label>
                            <select id="budgetWarehouse" onchange="loadBudgetVisualization(); loadBudgetManagement()">
                                <option value="warehouse_1">Salem</option>
                                <option value="warehouse_2">Vellore</option>
                                <option value="warehouse_3">Chennai Tyre</option>
                                <option value="warehouse_4">Chennai Woods Road</option>
                                <option value="warehouse_5">Bangalore Tyre</option>
                                <option value="warehouse_6">Yeswanthpur</option>
                                <option value="warehouse_7">Hubli</option>
                                <option value="warehouse_8">Mangalore</option>
                                <option value="warehouse_9">Hyderabad</option>
                                <option value="warehouse_10">Vijayawada</option>
                                <option value="warehouse_11">Vishakapatinam</option>
                                <option value="warehouse_12">Kolkata</option>
                                <option value="warehouse_13">Patna</option>
                                <option value="warehouse_14">Raipur</option>
                                <option value="warehouse_15">Bhubaneshwar</option>
                                <option value="warehouse_16">Pune</option>
                                <option value="warehouse_17">Bhiwandi</option>
                                <option value="warehouse_18">Nagpur</option>
                                <option value="warehouse_19">Ahmedabad</option>
                                <option value="warehouse_20">Gurgaon</option>
                                <option value="warehouse_21">Jaipur</option>
                                <option value="warehouse_22">Lucknow</option>
                                <option value="warehouse_23">Ghaziabad</option>
                                <option value="warehouse_24">Manjumel</option>
                                <option value="warehouse_25">Namakal</option>
                                <option value="warehouse_26">Madurai Aritapatti</option>
                                <option value="warehouse_27">Madurai Ellis Nagar</option>
                                <option value="warehouse_28">Bhopal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="budgetMonth">Month</label>
                            <input type="month" id="budgetMonth" onchange="loadBudgetVisualization(); loadBudgetManagement()">
                        </div>
                    </div>
                </div>

                <!-- Budget Management (Master Users Only) -->
                <div id="budgetManagementSection" style="background: #e8f5e9; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #28a745; display: none;">
                    <h3>ðŸ”§ Set Monthly Budgets (Master Access Only)</h3>
                    
                    <!-- Excel Upload Option -->
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px dashed #667eea;">
                        <h4 style="margin-bottom: 10px;">ðŸ“Š Upload Budget from Excel/CSV</h4>
                        <p style="color: #6c757d; font-size: 14px; margin-bottom: 20px;">
                            Download the template, fill in your budget values, and upload the CSV file. Budgets will be automatically saved.
                        </p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="downloadBudgetTemplate()">ðŸ“¥ Download Template</button>
                            <button class="btn" onclick="document.getElementById('budgetFileInput').click()">ðŸ“¤ Upload CSV File</button>
                            <button class="btn" onclick="exportBudgetsToCSV()">ðŸ’¾ Export Current Budgets</button>
                            <input type="file" id="budgetFileInput" accept=".csv" style="display: none;" onchange="uploadBudgetFile(event)">
                        </div>
                    </div>
                    
                    <!-- Uploaded Budget Preview -->
                    <div id="budgetPreview" style="display: none;">
                        <h4>ðŸ“‹ Budget Preview (Ready to Save)</h4>
                        <div id="budgetPreviewList" style="background: white; padding: 15px; border-radius: 10px;">
                            <!-- Budget preview will be shown here -->
                        </div>
                        <button class="btn btn-success" onclick="saveUploadedBudgets()" style="margin-top: 15px;">ðŸ’¾ Save Budgets</button>
                    </div>
                </div>

                <!-- Budget vs Expense Charts -->
                <div id="budgetVisualization">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="chart-container">
                            <h3>Pie Chart - Budget vs Expense</h3>
                            <div id="pieChartContainer">
                                <!-- Pie chart will be rendered here -->
                            </div>
                        </div>
                        <div class="chart-container">
                            <h3>Bar Graph - Budget vs Expense</h3>
                            <div id="barChartContainer">
                                <!-- Bar chart will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="budget-summary-section">
                        <h3>Budget Summary</h3>
                        <div id="budgetSummaryList">
                            <!-- Budget summary will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Download Tab -->
            <div id="download" class="tab-content">
                <h2>Download Reports</h2>
                
                <div class="download-section">
                    <h3>ðŸ“¥ Export Expense Data</h3>
                    <p>Download expense reports in various formats</p>
                    <div class="download-buttons">
                        <button class="btn btn-success" onclick="downloadCSV()">ðŸ“Š Download CSV</button>
                        <button class="btn btn-success" onclick="downloadJSON()">ðŸ“„ Download JSON</button>
                        <button class="btn btn-success" onclick="downloadPDF()">ðŸ“‹ Download PDF Report</button>
                    </div>
                </div>

                <div class="filter-section">
                    <h3>Filter Data for Download</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="downloadFromDate">From Date</label>
                            <input type="date" id="downloadFromDate">
                        </div>
                        <div class="form-group">
                            <label for="downloadToDate">To Date</label>
                            <input type="date" id="downloadToDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="downloadCategory">Category (Optional)</label>
                        <select id="downloadCategory">
                            <option value="">All Categories</option>
                            <option value="Pooja">Pooja</option>
                            <option value="Tea">Tea</option>
                            <option value="Water">Water</option>
                            <option value="Petrol">Petrol</option>
                            <option value="Lunch">Lunch</option>
                            <option value="Travel">Travel</option>
                            <option value="Freight">Freight</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Supplies">Supplies</option>
                            <option value="Rent">Rent</option>
                            <option value="Staff Transportation">Staff Transportation</option>
                            <option value="Staff Welfare">Staff Welfare</option>
                            <option value="Electricity">Electricity</option>
                            <option value="Stationary">Stationary</option>
                            <option value="MHE Rental">MHE Rental</option>
                            <option value="Packing Material">Packing Material</option>
                            <option value="Internet / Broadband">Internet / Broadband</option>
                            <option value="Diesel Generator">Diesel Generator</option>
                            <option value="AMC">AMC</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- User Management Tab (Master Admin Only) -->
            <div id="users" class="tab-content">
                <h2>User Management</h2>
                
                <!-- Add New User Section -->
                <div class="user-management" style="background: #e8f5e9; border: 2px solid #28a745;">
                    <h3>âž• Add New User</h3>
                    <form id="addUserForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newEmployeeCode">Employee Code (Username)</label>
                                <input type="text" id="newEmployeeCode" required placeholder="Enter employee code (this will be the username)">
                                <small style="color: #6c757d; font-size: 12px; display: block; margin-top: 5px;">
                                    Employee Code will be used as the username for login
                                </small>
                            </div>
                            <div class="form-group">
                                <label for="newPassword">Password</label>
                                <input type="password" id="newPassword" required placeholder="Enter password">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newName">Full Name</label>
                                <input type="text" id="newName" required placeholder="Enter full name">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newEmail">Email Address (Optional)</label>
                                <input type="email" id="newEmail" placeholder="Enter email address (e.g., user@example.com)">
                                <small style="color: #6c757d; font-size: 12px; display: block; margin-top: 5px;">
                                    ðŸ“§ Email (optional - for future email notifications)
                                </small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newRole">Role</label>
                                <select id="newRole" required onchange="toggleWarehouseField()">
                                    <option value="master">Master (Full Access)</option>
                                    <option value="approver">Approver (All Access Except User Creation)</option>
                                    <option value="warehouse">Warehouse Entry (Entry Only)</option>
                                </select>
                            </div>
                            <div class="form-group" id="warehouseFieldGroup">
                                <label for="newWarehouse">Warehouse (Hold Ctrl/Cmd to select multiple)</label>
                                <select id="newWarehouse" multiple size="8" style="min-height: 150px;">
                                    <option value="warehouse_1">Salem</option>
                                    <option value="warehouse_2">Vellore</option>
                                    <option value="warehouse_3">Chennai Tyre</option>
                                    <option value="warehouse_4">Chennai Woods Road</option>
                                    <option value="warehouse_5">Bangalore Tyre</option>
                                    <option value="warehouse_6">Yeswanthpur</option>
                                    <option value="warehouse_7">Hubli</option>
                                    <option value="warehouse_8">Mangalore</option>
                                    <option value="warehouse_9">Hyderabad</option>
                                    <option value="warehouse_10">Vijayawada</option>
                                    <option value="warehouse_11">Vishakapatinam</option>
                                    <option value="warehouse_12">Kolkata</option>
                                    <option value="warehouse_13">Patna</option>
                                    <option value="warehouse_14">Raipur</option>
                                    <option value="warehouse_15">Bhubaneshwar</option>
                                    <option value="warehouse_16">Pune</option>
                                    <option value="warehouse_17">Bhiwandi</option>
                                    <option value="warehouse_18">Nagpur</option>
                                    <option value="warehouse_19">Ahmedabad</option>
                                    <option value="warehouse_20">Gurgaon</option>
                                    <option value="warehouse_21">Jaipur</option>
                                    <option value="warehouse_22">Lucknow</option>
                                    <option value="warehouse_23">Ghaziabad</option>
                                    <option value="warehouse_24">Manjumel</option>
                                    <option value="warehouse_25">Namakal</option>
                                    <option value="warehouse_26">Madurai Aritapatti</option>
                                    <option value="warehouse_27">Madurai Ellis Nagar</option>
                                    <option value="warehouse_28">Bhopal</option>
                                </select>
                                <small style="color: #6c757d; font-size: 12px; display: block; margin-top: 5px;">
                                    ðŸ’¡ Tip: Select multiple warehouses or leave empty for "All Warehouses"
                                </small>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">âž• Add User</button>
                    </form>
                </div>
                
                <div class="user-management">
                    <h3>ðŸ‘¥ System Users</h3>
                    <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 1px solid #2196f3;">
                        <h4 style="margin-top: 0; color: #1976d2;">ðŸ“¦ Backup & Restore Users</h4>
                        <p style="margin: 10px 0; color: #555;">Export users for backup or import users from a backup file</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn" onclick="exportUsersToJSON()" style="background: #4caf50; color: white;">ðŸ“¥ Export Users (JSON)</button>
                            <button class="btn" onclick="exportUsersToCSV()" style="background: #2196f3; color: white;">ðŸ“Š Export Users (CSV)</button>
                            <label for="userFileInput" class="btn" style="background: #ff9800; color: white; cursor: pointer; display: inline-block;">
                                ðŸ“¤ Import Users (JSON)
                            </label>
                            <input type="file" id="userFileInput" accept=".json" style="display: none;" onchange="importUsersFromFile(event)">
                            <button class="btn" onclick="attemptUserRecovery()" style="background: #9c27b0; color: white;">ðŸ” Try Recover Deleted Users</button>
                        </div>
                    </div>
                    <div class="user-list" id="userList">
                        <!-- Users will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        // Firebase config for myTVS Expense Tracker
        const firebaseConfig = {
            apiKey: "AIzaSyABOT-m3kraMuaTDjGDLmBcESbxL3XpRlA",
            authDomain: "mytvs-expense-tracker.firebaseapp.com",
            projectId: "mytvs-expense-tracker",
            storageBucket: "mytvs-expense-tracker.firebasestorage.app",
            messagingSenderId: "653659771144",
            appId: "1:653659771144:web:7ebd5e188e94e19666dcbd",
            measurementId: "G-JQ5MQ08SMH"
        };
        
        // Initialize Firebase (only if config is provided)
        let db = null;
        let useFirebase = false;
        
        // Lazy initialize Firebase only if configured
        async function initializeFirebase() {
            if (useFirebase || !firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                return;
            }
            
            try {
                // Load Firebase SDK if not already loaded
                if (typeof firebase === 'undefined') {
                    await loadFirebaseSDK();
                }
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                useFirebase = true;
                console.log('âœ… Firebase initialized successfully');
                
                // Set up real-time listener after initialization
                setupFirebaseListener();
            } catch (error) {
                console.error('âŒ Firebase initialization error:', error);
                useFirebase = false;
            }
        }
        
        function setupFirebaseListener() {
            if (!useFirebase || !db) return;
            
            db.collection('expenses').orderBy('date', 'desc').onSnapshot(snapshot => {
                expenses = snapshot.docs.map(doc => {
                    const data = doc.data();
                    // Reconstruct invoiceFile from flattened fields
                    if (data.invoiceFileName || data.invoiceFileData) {
                        data.invoiceFile = {
                            filename: data.invoiceFileName || null,
                            type: data.invoiceFileType || null,
                            size: data.invoiceFileSize || null,
                            data: data.invoiceFileData || null,
                            tooLarge: data.invoiceFileTooLarge || false
                        };
                        // Remove flattened fields
                        delete data.invoiceFileName;
                        delete data.invoiceFileType;
                        delete data.invoiceFileSize;
                        delete data.invoiceFileData;
                        delete data.invoiceFileTooLarge;
                    }
                    return { id: doc.id, ...data };
                });
                if (currentUser) {
                    // Use debounced functions to prevent excessive updates
                    debouncedDisplayExpenses();
                    debouncedUpdateSummary();
                    // Refresh approvals if on approvals tab
                    if (document.getElementById('approvals') && document.getElementById('approvals').classList.contains('active')) {
                        debouncedDisplayApprovals();
                    }
                }
            });
        }
        
        // Initialize Firebase after page load for better performance
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(initializeFirebase, 1000); // Delay Firebase init by 1 second
            });
        } else {
            setTimeout(initializeFirebase, 1000);
        }
        
        // ============================================
        // EMAIL CONFIGURATION
        // ============================================
        // Option A: Resend (via Firebase Cloud Functions) - RECOMMENDED if you have Resend key
        // Option B: EmailJS - Alternative, no backend needed
        const ENABLE_EMAIL_NOTIFICATIONS = true;
        const USE_RESEND_EMAIL = true;  // Set true to use Resend via Firebase, false for EmailJS
        
        const EMAILJS_CONFIG = {
            PUBLIC_KEY: 'YOUR_PUBLIC_KEY',
            SERVICE_ID: 'YOUR_SERVICE_ID',
            TEMPLATE_APPROVAL: 'YOUR_APPROVAL_TEMPLATE_ID',
            TEMPLATE_REJECTION: 'YOUR_REJECTION_TEMPLATE_ID',
            TEMPLATE_SUBMISSION: 'YOUR_SUBMISSION_TEMPLATE_ID'
        };
        
        let emailConfigured = false;
        if (ENABLE_EMAIL_NOTIFICATIONS && USE_RESEND_EMAIL && firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
            emailConfigured = true;
            console.log('âœ… Email notifications enabled (Resend via Firebase)');
        } else if (ENABLE_EMAIL_NOTIFICATIONS && !USE_RESEND_EMAIL && EMAILJS_CONFIG.PUBLIC_KEY && EMAILJS_CONFIG.PUBLIC_KEY !== 'YOUR_PUBLIC_KEY') {
            emailConfigured = true;
            (function(){ emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY); })();
            console.log('âœ… Email notifications enabled (EmailJS)');
        } else if (ENABLE_EMAIL_NOTIFICATIONS) {
            console.log('âš ï¸ Email enabled but not configured - set up Resend (Firebase) or EmailJS');
        } else {
            console.log('â„¹ï¸ Email notifications disabled');
        }
        
        // ============================================
        // MULTI-LEVEL APPROVAL CONFIGURATION
        // ============================================
        // 2nd Level Approver (first approver after initial approval)
        const SECOND_LEVEL_APPROVER_ID = 'K02815'; // Dhanalakshmi - 2nd Level Approver
        
        // 3rd Level Approver (final approver for all transactions)
        const THIRD_LEVEL_APPROVER_ID = 'K01706'; // Varadarajan Krishnamachari - 3rd Level Approver
        
        // Check if 2nd level approval is enabled
        const ENABLE_2ND_LEVEL_APPROVAL = true; // Set to false to disable 2nd level approval
        
        // Check if 3rd level approval is enabled
        const ENABLE_3RD_LEVEL_APPROVAL = true; // Set to false to disable 3rd level approval
        
        // ============================================
        // EMAIL SENDING FUNCTIONS
        // ============================================
        
        async function sendUserCreationEmail(userEmail, userName, username, password, role) {
            // Email functionality disabled - will be enabled after configuration
            // if (!emailServerConfigured) {
            //     console.log('â„¹ï¸ Email server not configured - skipping email notification');
            //     return;
            // }
            // 
            // try {
            //     const response = await fetch(`${EMAIL_SERVER_URL}/api/send-user-email`, {
            //         method: 'POST',
            //         headers: {
            //             'Content-Type': 'application/json',
            //         },
            //         body: JSON.stringify({
            //             to_email: userEmail,
            //             user_name: userName,
            //             username: username,
            //             password: password,
            //             role: role
            //         })
            //     });
            //     
            //     const result = await response.json();
            //     if (result.success) {
            //         console.log('âœ… User creation email sent successfully');
            //     } else {
            //         throw new Error(result.error || 'Failed to send email');
            //     }
            // } catch (error) {
            //     console.error('âŒ Error sending user creation email:', error);
            //     // Don't throw error - email failure shouldn't block user creation
            // }
            return; // Email disabled
        }
        
        async function sendExpenseSubmissionEmail(expense, userEmail, userName) {
            // Email functionality disabled - will be enabled after configuration
            return; // Email disabled
        }
        
        async function sendApprovalEmail(expense, action, approverName, approverEmail) {
            if (!emailConfigured || !approverEmail) return;
            
            const actionText = action === 'approved' ? 'Approved' : action === 'first_approved' ? 'First Level Approved' : 'Rejected';
            const subject = `Expense ${actionText} - â‚¹${expense.amount.toFixed(2)}`;
            const html = `
                <p>Hello ${approverName},</p>
                <p>The following expense has been <strong>${actionText}</strong>:</p>
                <ul>
                    <li>Amount: â‚¹${expense.amount.toFixed(2)}</li>
                    <li>Category: ${expense.category}</li>
                    <li>Vendor: ${expense.vendorName || 'N/A'}</li>
                    <li>Warehouse: ${getWarehouseName(expense.warehouse)}</li>
                    <li>Date: ${new Date(expense.date).toLocaleDateString()}</li>
                    ${expense.rejectionReason ? `<li>Rejection Reason: ${expense.rejectionReason}</li>` : ''}
                </ul>
                <p>By: ${users[expense.createdBy]?.name || expense.createdBy}</p>
                <p><a href="${window.location.href}">View in App</a></p>
            `;
            
            try {
                if (USE_RESEND_EMAIL && typeof firebase !== 'undefined' && firebase.functions) {
                    const sendEmail = firebase.functions().httpsCallable('sendExpenseEmail');
                    await sendEmail({ to: approverEmail, subject: subject, html: html });
                } else {
                    const templateId = action === 'rejected' ? EMAILJS_CONFIG.TEMPLATE_REJECTION : EMAILJS_CONFIG.TEMPLATE_APPROVAL;
                    await emailjs.send(EMAILJS_CONFIG.SERVICE_ID, templateId, {
                        to_email: approverEmail, to_name: approverName, expense_amount: `â‚¹${expense.amount.toFixed(2)}`,
                        expense_category: expense.category, expense_vendor: expense.vendorName || 'N/A',
                        expense_date: new Date(expense.date).toLocaleDateString(), expense_warehouse: getWarehouseName(expense.warehouse),
                        expense_invoice: expense.invoiceNumber || 'N/A', action: actionText, rejection_reason: expense.rejectionReason || '',
                        expense_creator: users[expense.createdBy]?.name || expense.createdBy
                    });
                }
                console.log('âœ… Approval email sent');
            } catch (error) {
                console.error('âŒ Error sending approval email:', error);
            }
        }
        
        async function sendExpenseSubmissionEmail(expense, creatorEmail, creatorName, approverEmail, approverName) {
            if (!emailConfigured || !approverEmail) return;
            
            const subject = `New Expense Pending Approval - â‚¹${expense.amount.toFixed(2)}`;
            const html = `
                <p>Hello ${approverName},</p>
                <p>A new expense has been submitted and requires your approval:</p>
                <ul>
                    <li>Amount: â‚¹${expense.amount.toFixed(2)}</li>
                    <li>Category: ${expense.category}</li>
                    <li>Vendor: ${expense.vendorName || 'N/A'}</li>
                    <li>Warehouse: ${getWarehouseName(expense.warehouse)}</li>
                    <li>Date: ${new Date(expense.date).toLocaleDateString()}</li>
                    <li>Submitted by: ${creatorName} (${creatorEmail || 'N/A'})</li>
                </ul>
                <p><a href="${window.location.href}">Review in App</a></p>
            `;
            
            try {
                if (USE_RESEND_EMAIL && typeof firebase !== 'undefined' && firebase.functions) {
                    const sendEmail = firebase.functions().httpsCallable('sendExpenseEmail');
                    await sendEmail({ to: approverEmail, subject: subject, html: html });
                } else {
                    await emailjs.send(EMAILJS_CONFIG.SERVICE_ID, EMAILJS_CONFIG.TEMPLATE_SUBMISSION, {
                        to_email: approverEmail, to_name: approverName, expense_amount: `â‚¹${expense.amount.toFixed(2)}`,
                        expense_category: expense.category, expense_vendor: expense.vendorName || 'N/A',
                        expense_date: new Date(expense.date).toLocaleDateString(), expense_warehouse: getWarehouseName(expense.warehouse),
                        expense_invoice: expense.invoiceNumber || 'N/A', creator_name: creatorName, creator_email: creatorEmail || 'N/A',
                        expense_link: window.location.href
                    });
                }
                console.log('âœ… Submission email sent to approver');
            } catch (error) {
                console.error('âŒ Error sending submission email:', error);
            }
        }
        
        // Get all approvers who should be notified for an expense
        function getApproversForExpense(expense) {
            const approvers = [];
            
            // Get approvers based on warehouse access
            Object.keys(users).forEach(username => {
                const user = users[username];
                if ((user.role === 'approver' || user.role === 'master') && user.email) {
                    // Check if user has access to this warehouse
                    if (hasWarehouseAccess(user, expense.warehouse)) {
                        approvers.push({
                            username: username,
                            name: user.name,
                            email: user.email,
                            role: user.role
                        });
                    }
                }
            });
            
            // Add 2nd level approver if enabled
            if (ENABLE_2ND_LEVEL_APPROVAL && users[SECOND_LEVEL_APPROVER_ID] && users[SECOND_LEVEL_APPROVER_ID].email) {
                const secondLevelApprover = users[SECOND_LEVEL_APPROVER_ID];
                if (!approvers.find(a => a.username === SECOND_LEVEL_APPROVER_ID)) {
                    approvers.push({
                        username: SECOND_LEVEL_APPROVER_ID,
                        name: secondLevelApprover.name,
                        email: secondLevelApprover.email,
                        role: 'approver'
                    });
                }
            }
            // Add 3rd level approver if enabled
            if (ENABLE_3RD_LEVEL_APPROVAL && users[THIRD_LEVEL_APPROVER_ID] && users[THIRD_LEVEL_APPROVER_ID].email) {
                const thirdLevelApprover = users[THIRD_LEVEL_APPROVER_ID];
                if (!approvers.find(a => a.username === THIRD_LEVEL_APPROVER_ID)) {
                    approvers.push({
                        username: THIRD_LEVEL_APPROVER_ID,
                        name: thirdLevelApprover.name,
                        email: thirdLevelApprover.email,
                        role: 'approver'
                    });
                }
            }
            
            return approvers;
        }
        
        // ============================================
        // DATA SERVICE FUNCTIONS (Firebase or localStorage)
        // ============================================
        
        // Users Service - SIMPLIFIED AND SAFE
        async function getUsers(forceReload = false) {
            // Always get fresh data from localStorage first (fast, always available)
            const localUsers = getUsersLocalStorage(false); // Never cleanup
            
            // If forceReload is false and we have local users, return immediately (fast path for login)
            // Only sync with Firebase if explicitly requested or if local storage is empty
            if (!forceReload && Object.keys(localUsers).length > 0) {
                return localUsers;
            }
            
            // If Firebase is configured, merge Firebase users with local (but don't overwrite local)
            // This only happens on forceReload or when local storage is empty
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE" && db) {
                try {
                    const snapshot = await db.collection('users').get();
                    const firebaseUsers = {};
                    snapshot.forEach(doc => {
                        firebaseUsers[doc.id] = doc.data();
                    });
                    
                    // Merge: Local users take priority (they're more recent), Firebase fills gaps
                    const mergedUsers = { ...firebaseUsers, ...localUsers };
                    
                    // Ensure admin exists
                    if (!mergedUsers['admin']) {
                        mergedUsers['admin'] = { password: 'admin123', role: 'master', name: 'Master Admin' };
                    }
                    
                    // Update localStorage with merged data (but preserve local users)
                    localStorage.setItem('warehouseUsers', JSON.stringify(mergedUsers));
                    
                    return mergedUsers;
                } catch (error) {
                    console.error('Error loading users from Firebase:', error);
                    // Fall through to localStorage
                }
            }
            
            // Return localStorage users (always available)
            return localUsers;
        }
        
        function getUsersLocalStorage(cleanupOldWarehouseUsers = false) {
            // NEVER cleanup by default - only when explicitly requested
            const storedUsers = localStorage.getItem('warehouseUsers');
            if (storedUsers) {
                try {
                    const parsedUsers = JSON.parse(storedUsers);
                    const cleanedUsers = {};
                    let hasChanges = false;
                    
                    // Keep ALL users - don't filter anything unless explicitly cleaning up
                    Object.keys(parsedUsers).forEach(username => {
                        // Keep admin always
                        if (username === 'admin') {
                            cleanedUsers[username] = parsedUsers[username];
                        } 
                        // Keep all users that don't start with 'warehouse_' (employee codes like K01386)
                        else if (!username.startsWith('warehouse_')) {
                            cleanedUsers[username] = parsedUsers[username];
                        } 
                        // Only remove old warehouse_ users if cleanup is explicitly requested
                        else if (cleanupOldWarehouseUsers) {
                            hasChanges = true; // Mark that we're removing old warehouse users
                        } else {
                            // Don't remove, keep them
                            cleanedUsers[username] = parsedUsers[username];
                        }
                    });
                    
                    // Ensure admin user exists
                    if (!cleanedUsers['admin']) {
                        cleanedUsers['admin'] = { password: 'admin123', role: 'master', name: 'Master Admin' };
                        hasChanges = true;
                    }
                    
                    // Only write back if we made changes (added admin) - NEVER overwrite otherwise
                    if (hasChanges && cleanupOldWarehouseUsers) {
                        localStorage.setItem('warehouseUsers', JSON.stringify(cleanedUsers));
                    }
                    
                    return cleanedUsers;
                } catch (e) {
                    console.error('Error parsing users:', e);
                    // Return default admin if parsing fails
                    const defaultUsers = {
                        'admin': { password: 'admin123', role: 'master', name: 'Master Admin' }
                    };
                    return defaultUsers;
                }
            } else {
                const defaultUsers = {
                    'admin': { password: 'admin123', role: 'master', name: 'Master Admin' }
                };
                localStorage.setItem('warehouseUsers', JSON.stringify(defaultUsers));
                return defaultUsers;
            }
        }
        
        async function saveUser(username, userData) {
            if (useFirebase && db) {
                try {
                    await db.collection('users').doc(username).set(userData);
                    return true;
                } catch (error) {
                    console.error('Error saving user to Firebase:', error);
                    saveUserLocalStorage(username, userData);
                    return false;
                }
            } else {
                saveUserLocalStorage(username, userData);
                return true;
            }
        }
        
        function saveUserLocalStorage(username, userData) {
            // Always get fresh users from localStorage (don't use cache)
            const storedUsers = localStorage.getItem('warehouseUsers');
            let users = {};
            
            if (storedUsers) {
                try {
                    users = JSON.parse(storedUsers);
                } catch (e) {
                    console.error('Error parsing users from localStorage:', e);
                    users = {};
                }
            }
            
            // Add/update the user
            users[username] = userData;
            
            // Save back to localStorage
            try {
                localStorage.setItem('warehouseUsers', JSON.stringify(users));
                console.log(`âœ… User ${username} saved successfully to localStorage`);
                console.log(`User data:`, userData);
            } catch (e) {
                console.error('Error saving user to localStorage:', e);
                alert('Error saving user. Please try again.');
            }
        }
        
        async function deleteUserFirebase(username) {
            if (useFirebase && db) {
                try {
                    await db.collection('users').doc(username).delete();
                    return true;
                } catch (error) {
                    console.error('Error deleting user from Firebase:', error);
                    return false;
                }
            }
            return false;
        }
        
        // Expenses Service
        async function getExpenses() {
            if (useFirebase && db) {
                try {
                    const snapshot = await db.collection('expenses').orderBy('date', 'desc').get();
                    return snapshot.docs.map(doc => {
                        const data = doc.data();
                        // Reconstruct invoiceFile from flattened fields
                        if (data.invoiceFileName || data.invoiceFileData) {
                            data.invoiceFile = {
                                filename: data.invoiceFileName || null,
                                type: data.invoiceFileType || null,
                                size: data.invoiceFileSize || null,
                                data: data.invoiceFileData || null,
                                tooLarge: data.invoiceFileTooLarge || false
                            };
                            // Remove flattened fields
                            delete data.invoiceFileName;
                            delete data.invoiceFileType;
                            delete data.invoiceFileSize;
                            delete data.invoiceFileData;
                            delete data.invoiceFileTooLarge;
                        }
                        return { id: doc.id, ...data };
                    });
                } catch (error) {
                    console.error('Error loading expenses from Firebase:', error);
                    return getExpensesLocalStorage();
                }
            } else {
                return getExpensesLocalStorage();
            }
        }
        
        function getExpensesLocalStorage() {
            return JSON.parse(localStorage.getItem('warehouseExpenses')) || [];
        }
        
        async function saveExpense(expense) {
            if (useFirebase && db) {
                try {
                    // Clean the expense object - Firebase doesn't like undefined values
                    // Also flatten invoiceFile for Firebase compatibility
                    const cleanExpense = {};
                    Object.keys(expense).forEach(key => {
                        if (expense[key] !== undefined && expense[key] !== null) {
                            if (key === 'invoiceFile' && expense[key] && typeof expense[key] === 'object') {
                                // Flatten invoiceFile object for Firebase
                                cleanExpense['invoiceFileName'] = expense[key].filename || null;
                                cleanExpense['invoiceFileType'] = expense[key].type || null;
                                cleanExpense['invoiceFileSize'] = expense[key].size || null;
                                // Check base64 size before storing (Firestore 1MB limit = 1,048,487 bytes)
                                const base64Data = expense[key].data || null;
                                if (base64Data && base64Data.length > 1048487) {
                                    console.warn('Base64 data too large for Firestore, storing without file data');
                                    cleanExpense['invoiceFileData'] = null;
                                    cleanExpense['invoiceFileTooLarge'] = true;
                                } else {
                                    cleanExpense['invoiceFileData'] = base64Data;
                                }
                            } else {
                                cleanExpense[key] = expense[key];
                            }
                        }
                    });
                    
                    if (expense.id && typeof expense.id === 'string' && expense.id.length > 0) {
                        await db.collection('expenses').doc(expense.id).set(cleanExpense);
                    } else {
                        const docRef = await db.collection('expenses').add(cleanExpense);
                        expense.id = docRef.id;
                        cleanExpense.id = docRef.id;
                    }
                    // Also save to localStorage as backup (without large file data)
                    saveExpenseLocalStorage(expense, true); // Pass flag to skip large files
                    return true;
                } catch (error) {
                    console.error('Error saving expense to Firebase:', error);
                    console.error('Error details:', error.code, error.message);
                    // Fallback to localStorage (without large file data)
                    try {
                        saveExpenseLocalStorage(expense, true);
                    } catch (localError) {
                        console.error('Error saving to localStorage:', localError);
                        // If localStorage fails, at least the expense is saved in Firebase
                    }
                    throw error; // Re-throw to show error message
                }
            } else {
                saveExpenseLocalStorage(expense, true); // Skip large files in localStorage
                return true;
            }
        }
        
        function saveExpenseLocalStorage(expense, skipLargeFiles = false) {
            const expenses = getExpensesLocalStorage();
            
            // Create a copy of expense for localStorage
            const expenseForStorage = { ...expense };
            
            // If skipLargeFiles is true, remove base64 data to prevent quota exceeded
            if (skipLargeFiles && expenseForStorage.invoiceFile && expenseForStorage.invoiceFile.data) {
                expenseForStorage.invoiceFile = {
                    filename: expenseForStorage.invoiceFile.filename,
                    type: expenseForStorage.invoiceFile.type,
                    size: expenseForStorage.invoiceFile.size,
                    data: null // Don't store base64 in localStorage
                };
            }
            
            if (expense.id) {
                const index = expenses.findIndex(e => e.id === expense.id);
                if (index !== -1) {
                    expenses[index] = expenseForStorage;
                } else {
                    expenses.push(expenseForStorage);
                }
            } else {
                expenseForStorage.id = Date.now().toString();
                expenses.push(expenseForStorage);
            }
            
            try {
                localStorage.setItem('warehouseExpenses', JSON.stringify(expenses));
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    console.warn('localStorage quota exceeded. Storing expenses without file data.');
                    // Remove all file data from all expenses and try again
                    const expensesWithoutFiles = expenses.map(e => {
                        const exp = { ...e };
                        if (exp.invoiceFile && exp.invoiceFile.data) {
                            exp.invoiceFile = {
                                filename: exp.invoiceFile.filename,
                                type: exp.invoiceFile.type,
                                size: exp.invoiceFile.size,
                                data: null
                            };
                        }
                        return exp;
                    });
                    localStorage.setItem('warehouseExpenses', JSON.stringify(expensesWithoutFiles));
                } else {
                    throw error;
                }
            }
        }
        
        async function saveAllExpenses(expensesArray) {
            if (useFirebase && db) {
                try {
                    const batch = db.batch();
                    expensesArray.forEach(expense => {
                        // Flatten invoiceFile for Firebase
                        const cleanExpense = {};
                        Object.keys(expense).forEach(key => {
                            if (expense[key] !== undefined && expense[key] !== null) {
                                if (key === 'invoiceFile' && expense[key] && typeof expense[key] === 'object') {
                                    cleanExpense['invoiceFileName'] = expense[key].filename || null;
                                    cleanExpense['invoiceFileType'] = expense[key].type || null;
                                    cleanExpense['invoiceFileSize'] = expense[key].size || null;
                                    cleanExpense['invoiceFileData'] = expense[key].data || null;
                                } else {
                                    cleanExpense[key] = expense[key];
                                }
                            }
                        });
                        const docRef = db.collection('expenses').doc(expense.id);
                        batch.set(docRef, cleanExpense);
                    });
                    await batch.commit();
                    return true;
                } catch (error) {
                    console.error('Error saving expenses to Firebase:', error);
                    // Try to save to localStorage without large files
                    try {
                        const expensesWithoutFiles = expensesArray.map(e => {
                            const exp = { ...e };
                            if (exp.invoiceFile && exp.invoiceFile.data) {
                                exp.invoiceFile = {
                                    filename: exp.invoiceFile.filename,
                                    type: exp.invoiceFile.type,
                                    size: exp.invoiceFile.size,
                                    data: null
                                };
                            }
                            return exp;
                        });
                        localStorage.setItem('warehouseExpenses', JSON.stringify(expensesWithoutFiles));
                    } catch (localError) {
                        console.error('Error saving to localStorage:', localError);
                    }
                    return false;
                }
            } else {
                // Save to localStorage without large files
                const expensesWithoutFiles = expensesArray.map(e => {
                    const exp = { ...e };
                    if (exp.invoiceFile && exp.invoiceFile.data) {
                        exp.invoiceFile = {
                            filename: exp.invoiceFile.filename,
                            type: exp.invoiceFile.type,
                            size: exp.invoiceFile.size,
                            data: null
                        };
                    }
                    return exp;
                });
                localStorage.setItem('warehouseExpenses', JSON.stringify(expensesWithoutFiles));
                return true;
            }
        }
        
        async function deleteExpenseFirebase(expenseId) {
            // Delete functionality disabled - expenses cannot be deleted
            console.warn('Delete expense functionality has been disabled');
            return false;
        }
        
        // Clear all expenses from Firebase and localStorage
        async function clearAllExpenses() {
            try {
                if (useFirebase && db) {
                    // Get all expenses from Firebase
                    const snapshot = await db.collection('expenses').get();
                    
                    // Delete all expenses in batches (Firestore batch limit is 500)
                    const batches = [];
                    let currentBatch = db.batch();
                    let count = 0;
                    
                    snapshot.docs.forEach((doc) => {
                        currentBatch.delete(doc.ref);
                        count++;
                        
                        if (count >= 500) {
                            batches.push(currentBatch);
                            currentBatch = db.batch();
                            count = 0;
                        }
                    });
                    
                    if (count > 0) {
                        batches.push(currentBatch);
                    }
                    
                    // Commit all batches
                    for (const batchToCommit of batches) {
                        await batchToCommit.commit();
                    }
                    
                    console.log('All expenses cleared from Firebase');
                }
                
                // Clear from localStorage
                localStorage.removeItem('warehouseExpenses');
                console.log('All expenses cleared from localStorage');
                
                // Clear from memory
                expenses = [];
                
                // Refresh the display
                displayExpenses();
                updateSummary();
                
                return true;
            } catch (error) {
                console.error('Error clearing expenses:', error);
                throw error;
            }
        }
        
        // Budgets Service
        async function getBudgets() {
            if (useFirebase && db) {
                try {
                    const snapshot = await db.collection('budgets').get();
                    const budgets = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const key = `${data.warehouse}_${data.month}`;
                        if (!budgets[key]) {
                            budgets[key] = {};
                        }
                        budgets[key][data.category] = data.amount;
                    });
                    return budgets;
                } catch (error) {
                    console.error('Error loading budgets from Firebase:', error);
                    return getBudgetsLocalStorage();
                }
            } else {
                return getBudgetsLocalStorage();
            }
        }
        
        function getBudgetsLocalStorage() {
            return JSON.parse(localStorage.getItem('warehouseBudgets')) || {};
        }
        
        async function saveBudget(warehouse, month, category, amount) {
            if (useFirebase && db) {
                try {
                    const budgetKey = `${warehouse}_${month}_${category}`;
                    await db.collection('budgets').doc(budgetKey).set({
                        warehouse: warehouse,
                        month: month,
                        category: category,
                        amount: amount
                    });
                    return true;
                } catch (error) {
                    console.error('Error saving budget to Firebase:', error);
                    saveBudgetLocalStorage(warehouse, month, category, amount);
                    return false;
                }
            } else {
                saveBudgetLocalStorage(warehouse, month, category, amount);
                return true;
            }
        }
        
        function saveBudgetLocalStorage(warehouse, month, category, amount) {
            const budgets = getBudgetsLocalStorage();
            const key = `${warehouse}_${month}`;
            if (!budgets[key]) {
                budgets[key] = {};
            }
            budgets[key][category] = amount;
            localStorage.setItem('warehouseBudgets', JSON.stringify(budgets));
        }
        
        async function saveAllBudgets(budgetsObj) {
            if (useFirebase && db) {
                try {
                    const batch = db.batch();
                    Object.keys(budgetsObj).forEach(key => {
                        const [warehouse, month] = key.split('_');
                        Object.keys(budgetsObj[key]).forEach(category => {
                            const budgetKey = `${warehouse}_${month}_${category}`;
                            const docRef = db.collection('budgets').doc(budgetKey);
                            batch.set(docRef, {
                                warehouse: warehouse,
                                month: month,
                                category: category,
                                amount: budgetsObj[key][category]
                            });
                        });
                    });
                    await batch.commit();
                    return true;
                } catch (error) {
                    console.error('Error saving budgets to Firebase:', error);
                    localStorage.setItem('warehouseBudgets', JSON.stringify(budgetsObj));
                    return false;
                }
            } else {
                localStorage.setItem('warehouseBudgets', JSON.stringify(budgetsObj));
                return true;
            }
        }
        
        // Initialize budgets for 3 warehouses (Madurai Aritapatti, Madurai Ellis Nagar, Gurgaon)
        async function initializeBudgetsForThreeWarehouses() {
            const currentDate = new Date();
            const month = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            
            // Budget data from the table
            const budgetData = {
                'warehouse_26': { // Madurai Aritapatti
                    'Tea': 15392,
                    'Lunch': 57720,
                    'Water': 10400,
                    'Pooja': 5000,
                    'Staff Transportation': 65000,
                    'Staff Welfare': 15000,
                    'Electricity': 100000,
                    'Stationary': 20000,
                    'MHE Rental': 40000,
                    'Packing Material': 40000,
                    'Internet / Broadband': 25000,
                    'Diesel Generator': 20000,
                    'AMC': 16000
                },
                'warehouse_27': { // Madurai Ellis Nagar
                    'Tea': 3536,
                    'Lunch': 0,
                    'Water': 1040,
                    'Pooja': 2000,
                    'Staff Transportation': 0,
                    'Staff Welfare': 5000,
                    'Electricity': 7500,
                    'Stationary': 5000,
                    'MHE Rental': 0,
                    'Packing Material': 5000,
                    'Internet / Broadband': 2000,
                    'Diesel Generator': 1000,
                    'AMC': 5000
                },
                'warehouse_20': { // Gurgaon
                    'Tea': 18720,
                    'Lunch': 70200,
                    'Water': 10400,
                    'Pooja': 2000,
                    'Staff Transportation': 0,
                    'Staff Welfare': 15000,
                    'Electricity': 90000,
                    'Stationary': 25000,
                    'MHE Rental': 250000,
                    'Packing Material': 25000,
                    'Internet / Broadband': 10000,
                    'Diesel Generator': 20000,
                    'AMC': 15000
                }
            };
            
            // Save budgets for each warehouse
            for (const [warehouse, categories] of Object.entries(budgetData)) {
                for (const [category, amount] of Object.entries(categories)) {
                    await saveBudget(warehouse, month, category, amount);
                }
            }
            
            // Reload budgets
            budgets = await getBudgets();
            console.log('âœ… Budgets initialized for warehouse_26, warehouse_27, and warehouse_20');
        }
        
        // ============================================
        // User Management
        // ============================================
        
        // Initialize data (will be loaded asynchronously)
        let users = {};
        let currentUser = null;
        let currentWarehouse = null;
        let expenses = [];
        let budgets = {};
        let currentFilter = 'all';
        let currentApprovalFilter = 'all';
        
        // Performance optimization: Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Debounced update functions for better performance
        const debouncedDisplayExpenses = debounce(() => {
            requestAnimationFrame(() => {
                displayExpenses();
            });
        }, 300);
        
        const debouncedUpdateSummary = debounce(() => {
            requestAnimationFrame(() => {
                updateSummary();
            });
        }, 300);
        
        const debouncedDisplayApprovals = debounce(() => {
            requestAnimationFrame(() => {
                displayApprovals();
            });
        }, 300);
        
        // Load initial data
        (async function initializeData() {
            users = await getUsers();
            expenses = await getExpenses();
            budgets = await getBudgets();
            
            // Create user K02815 (Dhanalakshmi) - 2nd Level Approver if it doesn't exist
            if (!users['K02815']) {
                try {
                    await saveUser('K02815', {
                        password: 'K02815@123', // Default password - user should change it
                        role: 'approver',
                        name: 'Dhanalakshmi',
                        employeeCode: 'K02815',
                        email: 'dhanalakshmi.dhanapal@tvs.in',
                        warehouse: '' // Empty means all warehouses
                    });
                    users['K02815'] = {
                        password: 'K02815@123',
                        role: 'approver',
                        name: 'Dhanalakshmi',
                        employeeCode: 'K02815',
                        email: 'dhanalakshmi.dhanapal@tvs.in',
                        warehouse: ''
                    };
                    console.log('âœ… User K02815 (Dhanalakshmi) created as 2nd Level Approver');
                } catch (error) {
                    console.error('Error creating user K02815:', error);
                }
            }
            
            // Initialize budgets for 3 warehouses on first load
            const budgetsInitialized = localStorage.getItem('budgetsInitialized');
            if (!budgetsInitialized) {
                try {
                    await initializeBudgetsForThreeWarehouses();
                    localStorage.setItem('budgetsInitialized', 'true');
                    console.log('Budgets initialized for warehouse_26, warehouse_27, and warehouse_20');
                } catch (error) {
                    console.error('Error initializing budgets:', error);
                }
            }
            
            // Firebase listener is now set up in setupFirebaseListener() function
            // This is called automatically when Firebase initializes
        })();
        
        // Custom Modal Functions
        function customAlert(message) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('customModalOverlay');
                const title = document.getElementById('customModalTitle');
                const body = document.getElementById('customModalMessage');
                const footer = document.getElementById('customModalFooter');
                
                title.textContent = 'SCM Petty Cash Expense Management System';
                body.textContent = message;
                footer.innerHTML = '<button class="custom-modal-btn custom-modal-btn-primary" onclick="closeCustomModal(); window.customModalResolve(true);">OK</button>';
                
                overlay.classList.add('show');
                
                // Close on overlay click
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        closeCustomModal();
                        resolve(true);
                    }
                };
                
                window.customModalResolve = resolve;
            });
        }
        
        function customConfirm(message) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('customModalOverlay');
                const title = document.getElementById('customModalTitle');
                const body = document.getElementById('customModalMessage');
                const footer = document.getElementById('customModalFooter');
                
                title.textContent = 'SCM Petty Cash Expense Management System';
                body.textContent = message;
                footer.innerHTML = `
                    <button class="custom-modal-btn custom-modal-btn-secondary" onclick="closeCustomModal(); window.customModalResolve(false);">Cancel</button>
                    <button class="custom-modal-btn custom-modal-btn-primary" onclick="closeCustomModal(); window.customModalResolve(true);">OK</button>
                `;
                
                overlay.classList.add('show');
                
                // Close on overlay click (cancel)
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        closeCustomModal();
                        resolve(false);
                    }
                };
                
                window.customModalResolve = resolve;
            });
        }
        
        function closeCustomModal() {
            const overlay = document.getElementById('customModalOverlay');
            overlay.classList.remove('show');
            // Clear any input fields
            const body = document.getElementById('customModalMessage');
            const input = body.querySelector('input, textarea, select');
            if (input) {
                input.value = '';
            }
        }
        
        // Generic function to show custom modal with HTML content
        function showCustomModal(title, htmlContent) {
            const overlay = document.getElementById('customModalOverlay');
            const modalTitle = document.getElementById('customModalTitle');
            const modalBody = document.getElementById('customModalMessage');
            const modalFooter = document.getElementById('customModalFooter');
            
            modalTitle.textContent = title;
            modalBody.innerHTML = htmlContent; // Use innerHTML to support HTML content
            modalFooter.innerHTML = ''; // Clear footer - buttons should be in htmlContent
            
            overlay.classList.add('show');
            
            // Prevent closing on overlay click for edit modals (user should use Cancel button)
            overlay.onclick = null;
        }
        
        // Custom prompt function for rejection remarks
        function customPrompt(message, placeholder = '') {
            return new Promise((resolve) => {
                const overlay = document.getElementById('customModalOverlay');
                const title = document.getElementById('customModalTitle');
                const body = document.getElementById('customModalMessage');
                const footer = document.getElementById('customModalFooter');
                
                title.textContent = 'SCM Petty Cash Expense Management System';
                body.innerHTML = `
                    <div style="margin-bottom: 15px;">${message}</div>
                    <textarea id="rejectionRemarksInput" placeholder="${placeholder}" style="width: 100%; min-height: 100px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;" required></textarea>
                `;
                
                footer.innerHTML = `
                    <button class="custom-modal-btn custom-modal-btn-secondary" onclick="closeCustomModal(); window.customModalResolve(null);">Cancel</button>
                    <button class="custom-modal-btn custom-modal-btn-primary" onclick="handleRejectionSubmit();">Reject</button>
                `;
                
                overlay.classList.add('show');
                
                // Handle Enter key to submit
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        handleRejectionSubmit();
                    }
                };
                
                window.handleRejectionSubmit = () => {
                    const input = document.getElementById('rejectionRemarksInput');
                    const remarks = input ? input.value.trim() : '';
                    
                    if (!remarks) {
                        showToast('error', 'Required', 'Please provide rejection remarks');
                        input.focus();
                        return;
                    }
                    
                    closeCustomModal();
                    window.customModalResolve(remarks);
                };
                
                // Close on overlay click (cancel)
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        closeCustomModal();
                        resolve(null);
                    }
                };
                
                window.customModalResolve = resolve;
                
                // Focus on input
                setTimeout(() => {
                    const input = document.getElementById('rejectionRemarksInput');
                    if (input) {
                        input.focus();
                        input.addEventListener('keydown', handleKeyPress);
                    }
                }, 100);
            });
        }
        
        // Override native alert and confirm
        window.alert = customAlert;
        window.confirm = customConfirm;
        
        // Password visibility toggle
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.textContent = 'Hide';
            } else {
                passwordInput.type = 'password';
                toggleIcon.textContent = 'Show';
            }
        }
        
        // Helper function to check if user has access to a warehouse
        // Warehouse name mapping
        const warehouseNames = {
            'warehouse_1': 'Salem',
            'warehouse_2': 'Vellore',
            'warehouse_3': 'Chennai Tyre',
            'warehouse_4': 'Chennai Woods Road',
            'warehouse_5': 'Bangalore Tyre',
            'warehouse_6': 'Yeswanthpur',
            'warehouse_7': 'Hubli',
            'warehouse_8': 'Mangalore',
            'warehouse_9': 'Hyderabad',
            'warehouse_10': 'Vijayawada',
            'warehouse_11': 'Vishakapatinam',
            'warehouse_12': 'Kolkata',
            'warehouse_13': 'Patna',
            'warehouse_14': 'Raipur',
            'warehouse_15': 'Bhubaneshwar',
            'warehouse_16': 'Pune',
            'warehouse_17': 'Bhiwandi',
            'warehouse_18': 'Nagpur',
            'warehouse_19': 'Ahmedabad',
            'warehouse_20': 'Gurgaon',
            'warehouse_21': 'Jaipur',
            'warehouse_22': 'Lucknow',
            'warehouse_23': 'Ghaziabad',
            'warehouse_24': 'Manjumel',
            'warehouse_25': 'Namakal',
            'warehouse_26': 'Madurai Aritapatti',
            'warehouse_27': 'Madurai Ellis Nagar',
            'warehouse_28': 'Bhopal'
        };
        
        // Get warehouse display name
        function getWarehouseName(warehouseId) {
            return warehouseNames[warehouseId] || warehouseId;
        }
        
        // Normalize warehouse to ID (handles "Yeswanthpur" -> "warehouse_6", "warehouse_6" -> "warehouse_6")
        function normalizeWarehouseId(nameOrId) {
            if (!nameOrId) return '';
            const trimmed = String(nameOrId).trim();
            if (trimmed.startsWith('warehouse_')) return trimmed;
            for (const [id, name] of Object.entries(warehouseNames)) {
                if (name === trimmed) return id;
            }
            return trimmed;
        }
        
        // Get approval status display text
        function getApprovalStatusText(status) {
            if (status === 'pending') {
                return '1st Level Approval Pending';
            } else if (status === 'first_approved') {
                return '2nd Level Approval Pending';
            } else if (status === 'second_approved') {
                return '3rd Level Approval Pending';
            } else if (status === 'approved') {
                return 'APPROVED';
            } else if (status === 'rejected') {
                return 'REJECTED';
            }
            return status ? status.toUpperCase() : 'PENDING';
        }
        
        function hasWarehouseAccess(user, warehouse) {
            // Second-level approver always has access to all warehouses
            if (ENABLE_2ND_LEVEL_APPROVAL && currentUser === SECOND_LEVEL_APPROVER_ID) {
                return true;
            }
            // Third-level approver always has access to all warehouses
            if (ENABLE_3RD_LEVEL_APPROVAL && currentUser === THIRD_LEVEL_APPROVER_ID) {
                return true;
            }
            // If warehouse field is empty or not set, user has access to all warehouses
            if (!user.warehouse || user.warehouse === '' || user.warehouse.trim() === '') {
                return true; // Empty means all warehouses
            }
            // Get assigned warehouses (normalize to IDs)
            const userWarehouses = user.warehouse.split(',').map(w => normalizeWarehouseId(w.trim())).filter(w => w);
            // If all 28 warehouses are assigned, treat it as "all warehouses" access
            if (userWarehouses.length === 28) {
                return true;
            }
            // Check if warehouse is in user's assigned warehouses list (normalize for comparison)
            const warehouseId = normalizeWarehouseId(warehouse);
            return userWarehouses.includes(warehouseId) || userWarehouses.includes(warehouse);
        }
        
        // Get list of warehouses accessible to current user
        // This is based on warehouse assignments during user creation
        function getUserAccessibleWarehouses() {
            if (!currentUser || !users[currentUser]) {
                return []; // No user logged in
            }
            const user = users[currentUser];
            
            // Second-level approver always has access to all warehouses
            if (ENABLE_2ND_LEVEL_APPROVAL && currentUser === SECOND_LEVEL_APPROVER_ID) {
                return Array.from({length: 28}, (_, i) => `warehouse_${i + 1}`);
            }
            // Third-level approver always has access to all warehouses
            if (ENABLE_3RD_LEVEL_APPROVAL && currentUser === THIRD_LEVEL_APPROVER_ID) {
                return Array.from({length: 28}, (_, i) => `warehouse_${i + 1}`);
            }
            
            // If warehouse field is empty or not set, user has access to all warehouses
            if (!user.warehouse || user.warehouse === '' || user.warehouse.trim() === '') {
                // Empty means all warehouses - return all 28 warehouses
                return Array.from({length: 28}, (_, i) => `warehouse_${i + 1}`);
            }
            
            // Get assigned warehouses (normalize to IDs for consistency)
            const assignedWarehouses = user.warehouse.split(',').map(w => normalizeWarehouseId(w.trim())).filter(w => w);
            
            // If all 28 warehouses are assigned, treat it as "all warehouses" access
            if (assignedWarehouses.length === 28) {
                return Array.from({length: 28}, (_, i) => `warehouse_${i + 1}`);
            }
            
            // Return only assigned warehouses (respects warehouse assignments from user creation)
            return assignedWarehouses;
        }
        
        // Filter warehouse dropdown options to only show accessible warehouses
        function filterWarehouseOptions(selectElementId) {
            const selectElement = document.getElementById(selectElementId);
            if (!selectElement) return;
            
            const accessibleWarehouses = getUserAccessibleWarehouses();
            
            // Store all option data before clearing
            const allOptionsData = Array.from(selectElement.options).map(option => ({
                value: option.value,
                text: option.textContent
            }));
            
            // Remove all options first
            selectElement.innerHTML = '';
            
            // For 2nd/3rd level approvers and users with all warehouses: add 'All' option as first choice
            const hasFullAccess = accessibleWarehouses.length === 28 ||
                (ENABLE_2ND_LEVEL_APPROVAL && currentUser === SECOND_LEVEL_APPROVER_ID) ||
                (ENABLE_3RD_LEVEL_APPROVAL && currentUser === THIRD_LEVEL_APPROVER_ID);
            if (hasFullAccess && selectElementId === 'warehouseSelect') {
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'All Warehouses';
                selectElement.appendChild(allOption);
            }
            // Add only accessible warehouses
            allOptionsData.forEach(optionData => {
                const warehouseValue = optionData.value;
                // Keep 'all' option only if user has access to all warehouses
                if (warehouseValue === 'all') {
                    if (accessibleWarehouses.length === 28) {
                        const option = document.createElement('option');
                        option.value = optionData.value;
                        option.textContent = optionData.text;
                        selectElement.appendChild(option);
                    }
                } else if (accessibleWarehouses.includes(warehouseValue) || accessibleWarehouses.length === 28) {
                    const option = document.createElement('option');
                    option.value = optionData.value;
                    option.textContent = optionData.text;
                    selectElement.appendChild(option);
                }
            });
        }
        
        // Filter approval filter buttons to only show accessible warehouses
        function filterApprovalFilterButtons() {
            const accessibleWarehouses = getUserAccessibleWarehouses();
            const filterButtons = document.querySelectorAll('#approvals .filter-btn');
            
            // Second and third level approvers always see all warehouses
            const hasFullAccess = (ENABLE_2ND_LEVEL_APPROVAL && currentUser === SECOND_LEVEL_APPROVER_ID) ||
                                  (ENABLE_3RD_LEVEL_APPROVAL && currentUser === THIRD_LEVEL_APPROVER_ID);
            
            filterButtons.forEach(button => {
                const onclickAttr = button.getAttribute('onclick');
                if (onclickAttr) {
                    // Extract warehouse value from onclick (e.g., "filterApprovals('warehouse_1')")
                    const match = onclickAttr.match(/filterApprovals\('([^']+)'\)/);
                    if (match) {
                        const warehouseValue = match[1];
                        if (warehouseValue === 'all') {
                            // Show 'all' only if user has access to all warehouses
                            button.style.display = (accessibleWarehouses.length === 28 || hasFullAccess) ? '' : 'none';
                        } else {
                            // Show button only if warehouse is accessible
                            button.style.display = accessibleWarehouses.includes(warehouseValue) || accessibleWarehouses.length === 28 || hasFullAccess ? '' : 'none';
                        }
                    }
                }
            });
        }

        // Initialize
        const today = new Date().toISOString().split('T')[0];
        const expenseDateInput = document.getElementById('expenseDate');
        if (expenseDateInput) {
            expenseDateInput.value = today;
            expenseDateInput.setAttribute('max', today); // Prevent future dates
            // Also set it as a property to ensure it works
            expenseDateInput.max = today;
        }
        document.getElementById('expenseTime').value = new Date().toTimeString().slice(0, 5);
        document.getElementById('budgetMonth').value = new Date().toISOString().slice(0, 7);
        
        // Update max date every second to prevent future dates (in case user changes system date)
        setInterval(() => {
            const todayUpdate = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('expenseDate');
            if (dateInput) {
                dateInput.setAttribute('max', todayUpdate);
                dateInput.max = todayUpdate;
                // If current value is in the future, reset to today
                if (dateInput.value > todayUpdate) {
                    dateInput.value = todayUpdate;
                }
            }
        }, 1000);
        
        // Initialize warehouse field visibility
        if (document.getElementById('newRole')) {
            toggleWarehouseField();
        }
        
        // Toast notification function
        function showToast(type, title, message) {
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸',
                warning: 'âš ï¸'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || 'â„¹ï¸'}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            // Show loading state
            const loginButton = e.target.querySelector('button[type="submit"]');
            const originalButtonText = loginButton.textContent;
            loginButton.disabled = true;
            loginButton.textContent = 'Logging in...';
            
            try {
                // Always sync users from Firebase on login (ensures K02852, K01386, etc. are found - no stale cache)
                if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                    await initializeFirebase();
                }
                users = await getUsers(true); // Force reload - always get latest from Firebase
                console.log('Users loaded:', Object.keys(users).length, 'users');
                
                // Ensure admin user exists (fallback)
                if (!users['admin']) {
                    const adminData = { password: 'admin123', role: 'master', name: 'Master Admin' };
                    await saveUser('admin', adminData);
                    users['admin'] = adminData;
                }
                
                // Ensure K02815 (Dhanalakshmi) exists - 2nd Level Approver
                if (!users['K02815']) {
                    try {
                        const userData = {
                            password: 'K02815@123',
                            role: 'approver',
                            name: 'Dhanalakshmi',
                            employeeCode: 'K02815',
                            email: 'dhanalakshmi.dhanapal@tvs.in',
                            warehouse: ''
                        };
                        await saveUser('K02815', userData);
                        users['K02815'] = userData;
                    } catch (error) {
                        console.error('Error creating K02815 during login:', error);
                    }
                }
                
                // Validate user exists
                if (!users[username]) {
                    const availableUsers = Object.keys(users).join(', ');
                    await customAlert(`Invalid username or password!\n\nUser "${username}" not found.\n\nAvailable users: ${availableUsers}\n\nPlease check:\nâ€¢ Username is correct (case-sensitive)\nâ€¢ User exists in the system\nâ€¢ Contact admin if user needs to be created`);
                    loginButton.disabled = false;
                    loginButton.textContent = originalButtonText;
                    return;
                }
                
                if (users[username].password !== password) {
                    await customAlert('Invalid username or password!');
                    loginButton.disabled = false;
                    loginButton.textContent = originalButtonText;
                    return;
                }
                
                // Login successful - show UI immediately
                currentUser = username;
                currentWarehouse = users[username].warehouse || null;
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                document.getElementById('currentUser').textContent = users[username].name;
                
                // Show features based on role
                if (users[username].role === 'master') {
                    // Master: Full access
                    document.getElementById('warehouseSelector').style.display = 'block';
                    document.getElementById('usersTab').style.display = 'block';
                    document.getElementById('approvalsTab').style.display = 'block';
                    // Reload users list UI (users data already loaded above)
                    loadUsers();
                    // Filter warehouse options based on user's warehouse access
                    filterWarehouseOptions('warehouseSelect');
                    filterWarehouseOptions('budgetWarehouse');
                    filterApprovalFilterButtons();
                    // Remove 'all' option if it exists and set default to first accessible warehouse
                    const warehouseSelect = document.getElementById('warehouseSelect');
                    const allOption = warehouseSelect.querySelector('option[value="all"]');
                    if (allOption) {
                        allOption.remove();
                    }
                    const accessibleWarehouses = getUserAccessibleWarehouses();
                    if (accessibleWarehouses.length > 0 && (!warehouseSelect.value || warehouseSelect.value === 'all')) {
                        warehouseSelect.value = accessibleWarehouses[0];
                        currentWarehouse = accessibleWarehouses[0];
                    }
                    // Master/admin: Approvals tab should show ALL pending by default (all warehouses)
                    currentApprovalFilter = 'all';
                } else if (users[username].role === 'approver') {
                    // Approver: All access except user creation
                    document.getElementById('warehouseSelector').style.display = 'block';
                    document.getElementById('usersTab').style.display = 'none';
                    document.getElementById('approvalsTab').style.display = 'block';
                    // Filter warehouse options based on user's warehouse access
                    filterWarehouseOptions('warehouseSelect');
                    filterWarehouseOptions('budgetWarehouse');
                    filterApprovalFilterButtons();
                    
                    // For 2nd level approver (K02815), set approval filter to 'all' to show all warehouses
                    if (ENABLE_2ND_LEVEL_APPROVAL && username === SECOND_LEVEL_APPROVER_ID) {
                        currentApprovalFilter = 'all';
                        currentWarehouse = 'all';
                        const warehouseSelect = document.getElementById('warehouseSelect');
                        if (warehouseSelect) {
                            warehouseSelect.value = 'all';
                        }
                    } else {
                        // For other approvers, set warehouse selector to first accessible warehouse
                        const accessibleWarehouses = getUserAccessibleWarehouses();
                        if (accessibleWarehouses.length > 0) {
                            document.getElementById('warehouseSelect').value = accessibleWarehouses[0];
                            currentWarehouse = accessibleWarehouses[0];
                        } else {
                            // Fallback if no warehouses assigned
                            document.getElementById('warehouseSelect').value = 'warehouse_1';
                            currentWarehouse = 'warehouse_1';
                        }
                        // Remove 'all' option if it exists (for non-2nd-level approvers)
                        const warehouseSelect = document.getElementById('warehouseSelect');
                        const allOption = warehouseSelect.querySelector('option[value="all"]');
                        if (allOption) {
                            allOption.remove();
                        }
                    }
                } else {
                    // Warehouse: Entry only
                    document.getElementById('warehouseSelector').style.display = 'none';
                    document.getElementById('usersTab').style.display = 'none';
                    document.getElementById('approvalsTab').style.display = 'none';
                }
                
                // Show UI immediately, load data in background
                // Load expenses and budgets asynchronously (don't block UI)
                Promise.all([
                    getExpenses().then(data => { expenses = data; }),
                    getBudgets().then(data => { budgets = data; })
                ]).then(() => {
                    displayExpenses();
                    updateSummary();
                }).catch(error => {
                    console.error('Error loading data:', error);
                    // Still show UI even if data loading fails
                    displayExpenses();
                    updateSummary();
                });
                
                // Restore button state
                loginButton.disabled = false;
                loginButton.textContent = originalButtonText;
            } catch (error) {
                console.error('Login error:', error);
                await customAlert('Login failed: ' + (error.message || 'Unknown error. Please try again.'));
                loginButton.disabled = false;
                loginButton.textContent = originalButtonText;
            }
        });

        // Logout functionality
        function logout() {
            currentUser = null;
            currentWarehouse = null;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        }
        
        // Clear storage functionality
        async function clearStorage() {
            const confirmed = await customConfirm('This will delete all data including expenses and users. Are you sure?');
            if (confirmed) {
                localStorage.clear();
                await customAlert('Storage cleared! Page will reload.');
                location.reload();
            }
        }

        // Switch warehouse (for master users) with performance optimization
        function switchWarehouse() {
            const warehouseSelect = document.getElementById('warehouseSelect');
            currentWarehouse = String(warehouseSelect.value || '').trim();
            // For 2nd/3rd level approvers: keep 'all' - don't reset to first warehouse
            const isFullAccessApprover = (ENABLE_2ND_LEVEL_APPROVAL && currentUser === SECOND_LEVEL_APPROVER_ID) ||
                (ENABLE_3RD_LEVEL_APPROVAL && currentUser === THIRD_LEVEL_APPROVER_ID);
            if ((currentWarehouse === 'all' || !currentWarehouse) && !isFullAccessApprover) {
                const accessibleWarehouses = getUserAccessibleWarehouses();
                currentWarehouse = accessibleWarehouses.length > 0 ? accessibleWarehouses[0] : 'warehouse_1';
                warehouseSelect.value = currentWarehouse;
            }
            // For master/admin and 2nd/3rd level approvers: warehouse selector doesn't change approval filter
            // For other approvers: sync approval filter with warehouse selector
            if (users[currentUser]?.role !== 'master' && !isFullAccessApprover) {
                currentApprovalFilter = currentWarehouse;
            }
            // Update active state of approval filter buttons
            document.querySelectorAll('#approvals .filter-btn').forEach(btn => {
                btn.classList.remove('active');
                const onclickAttr = btn.getAttribute('onclick');
                if (onclickAttr) {
                    const match = onclickAttr.match(/filterApprovals\('([^']+)'\)/);
                    if (match && match[1] === currentWarehouse) {
                        btn.classList.add('active');
                    } else if (currentWarehouse && onclickAttr.includes("filterApprovals('all')")) {
                        // If a specific warehouse is selected, deactivate 'all' button
                    }
                }
            });
            // Use requestAnimationFrame for smooth updates
            requestAnimationFrame(() => {
            displayExpenses();
            updateSummary();
            displayApprovals(); // Also refresh approvals to respect warehouse change
            });
        }

        // Tab switching with performance optimization
        let lastApprovalsLoad = 0;
        const APPROVALS_CACHE_TIME = 5000; // 5 seconds cache
        
        function showTab(tabName) {
            // Immediate UI update for better responsiveness
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Use requestAnimationFrame for smooth updates
            if (tabName === 'list') {
                requestAnimationFrame(() => displayExpenses());
            }
            if (tabName === 'summary') {
                requestAnimationFrame(() => updateSummary());
            }
            if (tabName === 'users') {
                requestAnimationFrame(() => loadUsers());
            }
            if (tabName === 'approvals') {
                // For master/admin AND 2nd/3rd level approvers: Always default to 'All Pending' so Hubli, Patna, etc. all show
                const hasFullApprovalAccess = users[currentUser]?.role === 'master' ||
                    (ENABLE_2ND_LEVEL_APPROVAL && currentUser === SECOND_LEVEL_APPROVER_ID) ||
                    (ENABLE_3RD_LEVEL_APPROVAL && currentUser === THIRD_LEVEL_APPROVER_ID);
                if (hasFullApprovalAccess) {
                    currentApprovalFilter = 'all';
                    document.querySelectorAll('#approvals .filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                        const onclickAttr = btn.getAttribute('onclick');
                        if (onclickAttr && onclickAttr.includes("filterApprovals('all')")) {
                            btn.classList.add('active');
                        }
                    });
                } else if (currentWarehouse && currentWarehouse !== 'all' && (!currentApprovalFilter || currentApprovalFilter === 'all')) {
                    // For other approvers: sync approval filter with warehouse selector
                    currentApprovalFilter = currentWarehouse;
                    document.querySelectorAll('#approvals .filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                        const onclickAttr = btn.getAttribute('onclick');
                        if (onclickAttr) {
                            const match = onclickAttr.match(/filterApprovals\('([^']+)'\)/);
                            if (match && match[1] === currentWarehouse) {
                                btn.classList.add('active');
                            }
                        }
                    });
                }
                // Only reload if cache is stale (more than 5 seconds old)
                const now = Date.now();
                if (now - lastApprovalsLoad > APPROVALS_CACHE_TIME) {
                    lastApprovalsLoad = now;
                    // Show loading indicator
                    const approvalsList = document.getElementById('approvalsList');
                    if (approvalsList) {
                        approvalsList.innerHTML = '<div class="empty-state"><div style="font-size: 2rem; margin-bottom: 10px;">â³</div><p>Loading approvals...</p></div>';
                    }
                    // Reload expenses asynchronously
                    (async () => {
                        expenses = await getExpenses();
                        requestAnimationFrame(() => displayApprovals());
                    })();
                } else {
                    // Use cached data, but refresh display to respect current filter
                    requestAnimationFrame(() => displayApprovals());
                }
            }
            if (tabName === 'budget') {
                // Filter budget warehouse selector when switching to budget tab
                filterWarehouseOptions('budgetWarehouse');
                requestAnimationFrame(() => {
                loadBudgetVisualization();
                loadBudgetManagement();
                });
            }
        }

        // Form submission
        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const vendorName = document.getElementById('vendorName').value;
            const paymentMode = document.getElementById('paymentMode').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const invoiceFile = document.getElementById('invoiceFile').files[0];
            const expenseAmount = parseFloat(document.getElementById('expenseAmount').value);
            const expenseDate = document.getElementById('expenseDate').value;
            
            // Validate required fields
            if (!vendorName || vendorName.trim() === '') {
                showToast('error', 'Validation Error', 'Vendor Name is required.');
                return;
            }
            
            if (!paymentMode) {
                showToast('error', 'Validation Error', 'Payment Mode is required.');
                return;
            }
            
            if (!invoiceNumber || invoiceNumber.trim() === '') {
                showToast('error', 'Validation Error', 'Invoice Number is required.');
                return;
            }
            
            // Invoice number format validation - only alphanumeric, spaces, hyphens, underscores, and forward slashes allowed
            const invoiceNumberPattern = /^[a-zA-Z0-9\s\-_\/]+$/;
            if (!invoiceNumberPattern.test(invoiceNumber)) {
                showToast('error', 'Invalid Invoice Number', 'Invoice number can only contain letters, numbers, spaces, hyphens (-), underscores (_), and forward slashes (/). Special characters like @, #, $, %, & are not allowed.');
                return;
            }
            
            if (!invoiceFile) {
                showToast('error', 'Validation Error', 'Invoice Document is required.');
                return;
            }
            
            // File size validation for Firebase Firestore (1MB limit per field)
            // Base64 encoding increases size by ~33%, so limit original file to ~750KB
            const maxFileSizeForFirestore = 750 * 1024; // 750KB
            const maxFileSizeGeneral = 10 * 1024 * 1024; // 10MB for non-Firebase
            
            if (useFirebase && db) {
                // For Firebase, limit to 750KB to stay within 1MB base64 limit
                if (invoiceFile.size > maxFileSizeForFirestore) {
                    const fileSizeMB = (invoiceFile.size / (1024 * 1024)).toFixed(2);
                    showToast('error', 'File Size Error', `File size (${fileSizeMB}MB) is too large for Firebase. Maximum size is 750KB (~1MB when encoded). Please compress the file or use a smaller file.`);
                    return;
                }
            } else {
                // For localStorage, limit to 10MB
                if (invoiceFile.size > maxFileSizeGeneral) {
                showToast('error', 'File Size Error', 'Invoice file size must be less than 10MB.');
                return;
                }
            }
            
            // Amount validation
            if (expenseAmount <= 0) {
                showToast('error', 'Validation Error', 'Amount must be greater than zero.');
                return;
            }
            
            // Maximum amount limit (â‚¹1,000,000)
            if (expenseAmount > 1000000) {
                showToast('error', 'Amount Limit Exceeded', 'Maximum allowed amount is â‚¹10,00,000. Please contact admin for approval.');
                return;
            }
            
            // Date validation - cannot be in the future (only today and past dates allowed)
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to start of day for accurate comparison
            const submittedDate = new Date(expenseDate + 'T00:00:00'); // Ensure time is set to midnight
            submittedDate.setHours(0, 0, 0, 0);
            
            // Also check the input's max attribute as a double check
            const dateInput = document.getElementById('expenseDate');
            if (dateInput && dateInput.value > dateInput.max) {
                showToast('error', 'Date Error', 'Expense date cannot be in the future. Only today and past dates are allowed.');
                dateInput.value = new Date().toISOString().split('T')[0]; // Reset to today
                return;
            }
            
            if (submittedDate > today) {
                showToast('error', 'Date Error', 'Expense date cannot be in the future. Only today and past dates are allowed.');
                if (dateInput) {
                    dateInput.value = new Date().toISOString().split('T')[0]; // Reset to today
                }
                return;
            }
            
            // Date validation - cannot be older than 45 days
            const minDate = new Date(today);
            minDate.setDate(today.getDate() - 45);
            
            if (submittedDate < minDate) {
                showToast('error', 'Date Error', 'Invoice date cannot be older than 45 days.');
                return;
            }
            
            // Function to convert file to base64
            const convertFileToBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            };
            
            // Process the form submission
            const processSubmission = async () => {
                // Determine the warehouse
                // For warehouse users, use first assigned warehouse; for others use selector or default
                let warehouse;
                const accessibleWarehouses = getUserAccessibleWarehouses();
                if (users[currentUser].role === 'warehouse') {
                    const userWarehouses = users[currentUser].warehouse ? users[currentUser].warehouse.split(',') : [];
                    warehouse = userWarehouses.length > 0 ? userWarehouses[0] : 'warehouse_1';
                } else {
                    warehouse = currentWarehouse || 'warehouse_1';
                }
                
                // Validate that user has access to the selected warehouse
                if (!hasWarehouseAccess(users[currentUser], warehouse)) {
                    showToast('error', 'Access Denied', 'You do not have access to submit expenses for this warehouse.');
                    return;
                }
                
                // Check for duplicate invoice number in the same warehouse
                if (invoiceNumber && invoiceNumber.trim() !== '') {
                    const normalizedInvoiceNumber = invoiceNumber.trim();
                    const duplicateExists = expenses.some(expense => 
                        expense.warehouse === warehouse && 
                        expense.invoiceNumber && 
                        expense.invoiceNumber.trim() === normalizedInvoiceNumber
                    );
                    
                    if (duplicateExists) {
                        showToast('error', 'Duplicate Invoice', `Invoice number "${normalizedInvoiceNumber}" already exists in ${warehouse}. Please use a different invoice number.`);
                        return;
                    }
                }
                
                // Check for multiple expenses from same vendor on same day (possible fraud detection)
                const vendorNameLower = vendorName.toLowerCase();
                const sameDaySameVendor = expenses.filter(expense => 
                    expense.warehouse === warehouse && 
                    expense.vendorName && 
                    expense.vendorName.toLowerCase() === vendorNameLower &&
                    expense.date === expenseDate
                );
                
                if (sameDaySameVendor.length >= 3) {
                    const confirmed = await customConfirm(`Warning: This will be the ${sameDaySameVendor.length + 1} expense from vendor "${vendorName}" on ${expenseDate}. Are you sure you want to continue?`);
                    if (!confirmed) {
                        return;
                    }
                }
                
                let invoiceData = null;
                if (invoiceFile) {
                    try {
                        const base64 = await convertFileToBase64(invoiceFile);
                        invoiceData = {
                            filename: invoiceFile.name,
                            type: invoiceFile.type,
                            size: invoiceFile.size,
                            data: base64
                        };
                    } catch (error) {
                        showToast('error', 'Error', 'Failed to upload invoice file. Please try again.');
                        return;
                    }
                }
                
                const expense = {
                    id: String(Date.now()), // Convert to string for Firebase compatibility
                    date: document.getElementById('expenseDate').value,
                    time: document.getElementById('expenseTime').value,
                    category: document.getElementById('expenseCategory').value,
                    amount: expenseAmount,
                    vendorName: vendorName,
                    paymentMode: paymentMode,
                    invoiceNumber: invoiceNumber || null,
                    invoiceFile: invoiceData,
                    description: document.getElementById('expenseDescription').value || '',
                    warehouse: warehouse,
                    createdBy: currentUser,
                    createdAt: new Date().toISOString(),
                    status: 'pending',
                    approvedBy: null,
                    approvedAt: null
                };
                
                expenses.push(expense);
                await saveExpense(expense);
                
                // Show success message immediately (don't wait for email/Firebase reload)
                showToast('info', 'Expense Submitted', 'Awaiting approval from Master Admin.');
                
                // Reset form immediately
                document.getElementById('expenseForm').reset();
                const todayDate = new Date().toISOString().split('T')[0];
                const expenseDateInput = document.getElementById('expenseDate');
                if (expenseDateInput) {
                    expenseDateInput.value = todayDate;
                    expenseDateInput.setAttribute('max', todayDate); // Ensure max date is set
                    expenseDateInput.max = todayDate; // Set as property too
                }
                document.getElementById('expenseTime').value = new Date().toTimeString().slice(0, 5);
                
                // Update UI immediately
                displayExpenses();
                updateSummary();
                
                // Send email notifications to approvers
                if (emailConfigured) {
                    const creatorData = users[currentUser];
                    const approvers = getApproversForExpense(expense);
                    
                    // Send email to each approver who has access to this warehouse
                    approvers.forEach(approver => {
                        sendExpenseSubmissionEmail(
                            expense,
                            creatorData?.email || '',
                            creatorData?.name || currentUser,
                            approver.email,
                            approver.name
                        ).catch(err => {
                            console.error(`Error sending email to ${approver.name}:`, err);
                        });
                    });
                }
                
                // Reload expenses from Firebase in background (non-blocking)
                if (useFirebase && db) {
                    getExpenses().then(loadedExpenses => {
                        expenses = loadedExpenses;
                        displayExpenses();
                        updateSummary();
                    }).catch(err => {
                        console.error('Firebase reload failed (non-critical):', err);
                    });
                }
                // Refresh approvals if on approvals tab
                if (document.getElementById('approvals').classList.contains('active')) {
                    displayApprovals();
                }
            };
            
            processSubmission().catch(error => {
                console.error('Error in processSubmission:', error);
                const errorMessage = error.message || 'An error occurred while submitting the expense.';
                showToast('error', 'Submission Error', errorMessage);
                // Also try to save to localStorage as fallback
                console.log('Attempting to save to localStorage as fallback...');
            });
        });

        // Filter expenses
        function filterExpenses(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displayExpenses();
        }

        // Display expenses with performance optimization
        function displayExpenses() {
            const expenseList = document.getElementById('expenseList');
            if (!expenseList) return; // Safety check
            
            // Show loading indicator for better UX
            if (expenses.length > 50) {
                expenseList.innerHTML = '<div class="empty-state"><div style="font-size: 2rem; margin-bottom: 10px;">â³</div><p>Loading expenses...</p></div>';
            }
            
            let filteredExpenses = expenses;
            
            // Get user's accessible warehouses
            const accessibleWarehouses = getUserAccessibleWarehouses();
            
            // Filter by warehouse based on user role
            if (users[currentUser].role === 'warehouse') {
                // Warehouse users: see ALL their warehouse expenses (all statuses - pending, 2nd/3rd level pending, approved, rejected)
                filteredExpenses = filteredExpenses.filter(expense => {
                    const warehouseMatch = hasWarehouseAccess(users[currentUser], expense.warehouse);
                    return warehouseMatch;
                });
            } else if (users[currentUser].role === 'approver') {
                // Approver: see warehouses based on their assignment
                if (currentWarehouse && currentWarehouse !== 'all') {
                    // Filter by warehouse selector if set - normalize for comparison (handles warehouse_6 vs Yeswanthpur)
                    if (hasWarehouseAccess(users[currentUser], currentWarehouse)) {
                        const filterWarehouseId = normalizeWarehouseId(currentWarehouse);
                        filteredExpenses = filteredExpenses.filter(expense => {
                            const expenseWarehouseId = normalizeWarehouseId(expense.warehouse);
                            return expenseWarehouseId === filterWarehouseId;
                        });
                    } else {
                        filteredExpenses = []; // No access to selected warehouse
                    }
                } else {
                    // If no specific warehouse selected, show only accessible warehouses
                    filteredExpenses = filteredExpenses.filter(expense => {
                        const expenseWarehouseId = normalizeWarehouseId(expense.warehouse);
                        return accessibleWarehouses.includes(expenseWarehouseId) || accessibleWarehouses.includes(expense.warehouse);
                    });
                }
            } else if (users[currentUser].role === 'master') {
                // Master users: respect warehouse restrictions if they have assigned warehouses
                if (users[currentUser].warehouse && users[currentUser].warehouse !== '') {
                    // Master with warehouse restrictions
                    if (currentWarehouse && currentWarehouse !== 'all') {
                        if (hasWarehouseAccess(users[currentUser], currentWarehouse)) {
                            filteredExpenses = filteredExpenses.filter(expense => {
                                const expenseWarehouse = String(expense.warehouse || '').trim();
                                const filterWarehouse = String(currentWarehouse || '').trim();
                                return expenseWarehouse === filterWarehouse;
                            });
                        } else {
                            filteredExpenses = [];
                        }
                    } else {
                        // Show all accessible warehouses
                        filteredExpenses = filteredExpenses.filter(expense => 
                            accessibleWarehouses.includes(expense.warehouse)
                        );
                    }
            } else if (currentWarehouse && currentWarehouse !== 'all') {
                    // Master with no restrictions: filter by selected warehouse - use strict string comparison
                    filteredExpenses = filteredExpenses.filter(expense => {
                        const expenseWarehouse = String(expense.warehouse || '').trim();
                        const filterWarehouse = String(currentWarehouse || '').trim();
                        return expenseWarehouse === filterWarehouse;
                    });
                }
                // If master has no restrictions and no filter, show all expenses
            }
            
            // Apply date filter
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch(currentFilter) {
                case 'daily':
                    filteredExpenses = filteredExpenses.filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate >= today;
                    });
                    break;
                case 'weekly':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    filteredExpenses = filteredExpenses.filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate >= weekStart;
                    });
                    break;
                case 'monthly':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    filteredExpenses = filteredExpenses.filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate >= monthStart;
                    });
                    break;
            }
            
            filteredExpenses.sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
            
            if (filteredExpenses.length === 0) {
                expenseList.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 4rem; margin-bottom: 20px;">ðŸ“</div>
                        <h3>No expenses found</h3>
                        <p>Start adding expenses to see them here!</p>
                    </div>
                `;
                return;
            }
            
            // Pagination for better performance (only if more than 50 items)
            const itemsPerPage = 50;
            const currentPage = window.currentExpensePage || 1;
            let paginatedExpenses = filteredExpenses;
            let totalPages = 1;
            let showPagination = false;
            
            if (filteredExpenses.length > itemsPerPage) {
                showPagination = true;
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                paginatedExpenses = filteredExpenses.slice(startIndex, endIndex);
                totalPages = Math.ceil(filteredExpenses.length / itemsPerPage);
            }
            
            // Render expenses (optimized for performance)
            let expensesHTML = paginatedExpenses.map(expense => `
                <div class="expense-card">
                    <div class="expense-header">
                        <div>
                            <span class="expense-category">${expense.category}</span>
                            <span class="warehouse-badge">${getWarehouseName(expense.warehouse)}</span>
                            <span class="approval-status ${expense.status}">${getApprovalStatusText(expense.status)}</span>
                        </div>
                        <span class="expense-amount">â‚¹${expense.amount.toFixed(2)}</span>
                    </div>
                    <div class="expense-details">
                        ðŸ“… ${new Date(expense.date).toLocaleDateString()} at ${expense.time}
                        ${expense.vendorName ? `<br>ðŸª Vendor: <strong>${expense.vendorName}</strong>` : ''}
                        ${expense.paymentMode ? `<br>ðŸ’³ Payment: <strong>${expense.paymentMode}</strong>` : ''}
                        ${expense.invoiceNumber ? `<br>ðŸ§¾ Invoice: <strong>${expense.invoiceNumber}</strong>` : ''}
                        ${ENABLE_2ND_LEVEL_APPROVAL && expense.firstApprovedBy ? `<br>âœ… First Approved by: <strong>${users[expense.firstApprovedBy]?.name || expense.firstApprovedBy}</strong>${expense.firstApprovedAt ? ` on ${new Date(expense.firstApprovedAt).toLocaleString()}` : ''}` : ''}
                        ${ENABLE_3RD_LEVEL_APPROVAL && expense.secondApprovedBy ? `<br>âœ… Second Approved by: <strong>${users[expense.secondApprovedBy]?.name || expense.secondApprovedBy}</strong>${expense.secondApprovedAt ? ` on ${new Date(expense.secondApprovedAt).toLocaleString()}` : ''}` : ''}
                        ${expense.approvedBy && expense.status === 'rejected' ? `<br>âŒ Rejected by: <strong>${users[expense.approvedBy]?.name || 'Approver'}</strong>${expense.approvedAt ? ` on ${new Date(expense.approvedAt).toLocaleString()}` : ''}${expense.rejectionReason ? `<br>ðŸ“ Rejection Reason: <strong>${expense.rejectionReason}</strong>` : ''}` : ''}
                        ${expense.approvedBy && expense.status === 'approved' ? `<br>âœ… Final Approved by: <strong>${users[expense.approvedBy]?.name || 'Approver'}</strong>${expense.approvedAt ? ` on ${new Date(expense.approvedAt).toLocaleString()}` : ''}` : ''}
                    </div>
                    ${expense.description ? `<div class="expense-description">${expense.description}</div>` : ''}
                    ${expense.invoiceFile ? `
                        <div style="margin-top: 10px;">
                            <button onclick="downloadInvoiceFile(${expense.id})" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                ðŸ“Ž Download Invoice
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
            // Add pagination controls if needed
            if (showPagination) {
                let paginationHTML = '<div style="margin-top: 20px; display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">';
                paginationHTML += `<span style="color: #666;">Page ${currentPage} of ${totalPages} (${filteredExpenses.length} total expenses)</span>`;
                if (currentPage > 1) {
                    paginationHTML += `<button onclick="window.currentExpensePage = ${currentPage - 1}; displayExpenses();" style="padding: 8px 16px; background: var(--mytvs-orange); color: white; border: none; border-radius: 6px; cursor: pointer;">â† Previous</button>`;
                }
                if (currentPage < totalPages) {
                    paginationHTML += `<button onclick="window.currentExpensePage = ${currentPage + 1}; displayExpenses();" style="padding: 8px 16px; background: var(--mytvs-orange); color: white; border: none; border-radius: 6px; cursor: pointer;">Next â†’</button>`;
                }
                paginationHTML += '</div>';
                expensesHTML += paginationHTML;
            } else {
                window.currentExpensePage = 1; // Reset to page 1 if pagination not needed
            }
            
            expenseList.innerHTML = expensesHTML;
        }

        // View invoice file in new tab
        function viewInvoiceFile(id) {
            try {
                // Convert id to string if needed
                const expenseId = String(id);
                const expense = expenses.find(e => String(e.id) === expenseId);
                if (!expense) {
                    showToast('error', 'Error', 'Expense not found');
                    console.error('Expense not found. ID:', expenseId);
                    return;
                }
                
                if (!expense.invoiceFile) {
                    showToast('error', 'Error', 'Invoice file not found for this expense');
                    return;
                }
            
                if (!expense.invoiceFile.data) {
                    showToast('error', 'Error', 'Invoice file data is not available. The file may be too large or was not uploaded.');
                    console.log('Invoice file info:', {
                        filename: expense.invoiceFile.filename,
                        type: expense.invoiceFile.type,
                        size: expense.invoiceFile.size,
                        hasData: !!expense.invoiceFile.data
                    });
                    return;
                }
            
            // Open invoice in new tab/window
            const newWindow = window.open();
            if (newWindow) {
                newWindow.document.write(`
                    <html>
                        <head>
                            <title>${expense.invoiceFile.filename}</title>
                            <style>
                                body { margin: 0; padding: 20px; background: #f5f5f5; }
                                .container { max-width: 100%; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                                img { max-width: 100%; height: auto; }
                                iframe { width: 100%; height: 80vh; border: none; }
                                .header { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0; }
                                .header h2 { margin: 0; color: #333; }
                                .header p { margin: 5px 0 0 0; color: #666; font-size: 14px; }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <div class="header">
                                    <h2>ðŸ“„ ${expense.invoiceFile.filename}</h2>
                                    <p>Invoice #${expense.invoiceNumber || 'N/A'} | Vendor: ${expense.vendorName || 'N/A'} | Amount: â‚¹${expense.amount.toFixed(2)}</p>
                                </div>
                                ${expense.invoiceFile.type === 'application/pdf' 
                                    ? `<iframe src="${expense.invoiceFile.data}"></iframe>`
                                    : `<img src="${expense.invoiceFile.data}" alt="${expense.invoiceFile.filename}">`
                                }
                            </div>
                        </body>
                    </html>
                `);
            } else {
                showToast('error', 'Error', 'Please allow pop-ups to view the invoice');
            }
            } catch (error) {
                console.error('Error viewing invoice:', error);
                showToast('error', 'Error', 'Failed to view invoice: ' + error.message);
            }
        }

        // Download invoice file
        function downloadInvoiceFile(id) {
            try {
                // Convert id to string if needed
                const expenseId = String(id);
                const expense = expenses.find(e => String(e.id) === expenseId);
                if (!expense) {
                    showToast('error', 'Error', 'Expense not found');
                    console.error('Expense not found. ID:', expenseId);
                    return;
                }
                
                if (!expense.invoiceFile) {
                    showToast('error', 'Error', 'Invoice file not found for this expense');
                    return;
                }
            
                if (!expense.invoiceFile.data) {
                    showToast('error', 'Error', 'Invoice file data is not available. The file may be too large or was not uploaded.');
                return;
            }
            
            const link = document.createElement('a');
            link.href = expense.invoiceFile.data;
            link.download = expense.invoiceFile.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            } catch (error) {
                console.error('Error downloading invoice:', error);
                showToast('error', 'Error', 'Failed to download invoice: ' + error.message);
            }
        }

        // Delete expense
        async function deleteExpense(id) {
            // Delete functionality has been disabled - expenses cannot be deleted
            await customAlert('âŒ Delete functionality has been disabled. Expenses cannot be deleted.');
        }

        // Update summary with date filter
        function updateSummaryWithDateFilter() {
            updateSummary();
        }

        // Update summary
        function updateSummary() {
            let filteredExpenses = expenses;
            
            // Apply date filters if provided
            const fromDate = document.getElementById('summaryFromDate')?.value;
            const toDate = document.getElementById('summaryToDate')?.value;
            
            if (fromDate) {
                filteredExpenses = filteredExpenses.filter(expense => expense.date >= fromDate);
            }
            if (toDate) {
                filteredExpenses = filteredExpenses.filter(expense => expense.date <= toDate);
            }
            
            // Get user's accessible warehouses
            const accessibleWarehouses = getUserAccessibleWarehouses();
            
            // Filter by warehouse based on user role (Summary: approved only for totals)
            if (users[currentUser].role === 'warehouse') {
                // Warehouse users: only approved expenses in summary
                filteredExpenses = filteredExpenses.filter(expense => 
                    hasWarehouseAccess(users[currentUser], expense.warehouse) && expense.status === 'approved'
                );
            } else if (users[currentUser].role === 'approver') {
                // Approver: filter by warehouse selector or warehouse mapping
                if (currentWarehouse && currentWarehouse !== 'all') {
                    if (hasWarehouseAccess(users[currentUser], currentWarehouse)) {
                        filteredExpenses = filteredExpenses.filter(expense => {
                            const expenseWarehouse = String(expense.warehouse || '').trim();
                            const filterWarehouse = String(currentWarehouse || '').trim();
                            return expenseWarehouse === filterWarehouse;
                        });
                    } else {
                        filteredExpenses = [];
                    }
                } else {
                    // If no specific warehouse selected, show only accessible warehouses
                    filteredExpenses = filteredExpenses.filter(expense => 
                        accessibleWarehouses.includes(expense.warehouse)
                    );
                }
            } else if (users[currentUser].role === 'master') {
                // Master users: respect warehouse restrictions if they have assigned warehouses
                if (users[currentUser].warehouse && users[currentUser].warehouse !== '') {
                    // Master with warehouse restrictions
                    if (currentWarehouse && currentWarehouse !== 'all') {
                        if (hasWarehouseAccess(users[currentUser], currentWarehouse)) {
                            filteredExpenses = filteredExpenses.filter(expense => {
                                const expenseWarehouse = String(expense.warehouse || '').trim();
                                const filterWarehouse = String(currentWarehouse || '').trim();
                                return expenseWarehouse === filterWarehouse;
                            });
                        } else {
                            filteredExpenses = [];
                        }
                    } else {
                        // Show all accessible warehouses
                        filteredExpenses = filteredExpenses.filter(expense => 
                            accessibleWarehouses.includes(expense.warehouse)
                        );
                    }
            } else if (currentWarehouse && currentWarehouse !== 'all') {
                    // Master with no restrictions: filter by selected warehouse - use strict string comparison
                    filteredExpenses = filteredExpenses.filter(expense => {
                        const expenseWarehouse = String(expense.warehouse || '').trim();
                        const filterWarehouse = String(currentWarehouse || '').trim();
                        return expenseWarehouse === filterWarehouse;
                    });
                }
                // If master has no restrictions and no filter, show all expenses
            }
            
            const totalAmount = filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalCount = filteredExpenses.length;
            const averageAmount = totalCount > 0 ? totalAmount / totalCount : 0;
            
            // Calculate date range
            let dateRangeText = '-';
            let lastExpenseDateText = '-';
            
            if (filteredExpenses.length > 0) {
                const dates = filteredExpenses.map(e => new Date(e.date)).sort((a, b) => a - b);
                const earliestDate = dates[0];
                const latestDate = dates[dates.length - 1];
                
                if (earliestDate.getTime() === latestDate.getTime()) {
                    dateRangeText = earliestDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                } else {
                    dateRangeText = `${earliestDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' })} - ${latestDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}`;
                }
                
                lastExpenseDateText = latestDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
            }
            
            // Update summary elements with error handling
            const totalAmountEl = document.getElementById('totalAmount');
            const totalCountEl = document.getElementById('totalCount');
            const averageAmountEl = document.getElementById('averageAmount');
            const dateRangeEl = document.getElementById('dateRange');
            const lastExpenseDateEl = document.getElementById('lastExpenseDate');
            
            if (totalAmountEl) totalAmountEl.textContent = `â‚¹${totalAmount.toFixed(2)}`;
            if (totalCountEl) totalCountEl.textContent = totalCount;
            if (averageAmountEl) averageAmountEl.textContent = `â‚¹${averageAmount.toFixed(2)}`;
            if (dateRangeEl) dateRangeEl.textContent = dateRangeText;
            if (lastExpenseDateEl) lastExpenseDateEl.textContent = lastExpenseDateText;
            
            // Date-wise breakdown
            const dateWiseSummary = {};
            filteredExpenses.forEach(expense => {
                if (!dateWiseSummary[expense.date]) {
                    dateWiseSummary[expense.date] = { count: 0, total: 0 };
                }
                dateWiseSummary[expense.date].count++;
                dateWiseSummary[expense.date].total += expense.amount;
            });
            
            const dateWiseDiv = document.getElementById('dateWiseSummary');
            if (Object.keys(dateWiseSummary).length === 0) {
                dateWiseDiv.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">No expenses to analyze</p>';
            } else {
                const sortedDates = Object.keys(dateWiseSummary).sort().reverse(); // Most recent first
                dateWiseDiv.innerHTML = sortedDates.map(date => {
                    const data = dateWiseSummary[date];
                    const dateObj = new Date(date);
                    const formattedDate = dateObj.toLocaleDateString('en-IN', { 
                        weekday: 'long', 
                        day: '2-digit', 
                        month: 'short', 
                        year: 'numeric' 
                    });
                    return `
                        <div class="date-wise-item">
                            <div class="date-info">
                                <div class="date-label">${formattedDate}</div>
                                <div class="date-details">Entries on this date</div>
                            </div>
                            <div class="date-stats">
                                <div class="entries-count">${data.count} entries</div>
                                <div class="expense-total">â‚¹${data.total.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Category breakdown
            const categoryBreakdown = {};
            filteredExpenses.forEach(expense => {
                categoryBreakdown[expense.category] = (categoryBreakdown[expense.category] || 0) + expense.amount;
            });
            
            const categoryBreakdownDiv = document.getElementById('categoryBreakdown');
            if (Object.keys(categoryBreakdown).length === 0) {
                categoryBreakdownDiv.innerHTML = '<p style="text-align: center; color: #6c757d;">No expenses to analyze</p>';
            } else {
                categoryBreakdownDiv.innerHTML = Object.entries(categoryBreakdown)
                    .sort((a, b) => b[1] - a[1])
                    .map(([category, amount]) => `
                        <div class="category-item">
                            <span class="category-name">${category}</span>
                            <span class="category-amount">â‚¹${amount.toFixed(2)}</span>
                        </div>
                    `).join('');
            }
        }

        // Budget functions
        let uploadedBudgetData = {}; // For single warehouse upload (old format)
        let uploadedBudgetDataByWarehouse = {}; // For multi-warehouse upload (new format)
        
        function loadBudgetManagement() {
            // Show budget management for master and approver users
            if (users[currentUser].role === 'warehouse') {
                document.getElementById('budgetManagementSection').style.display = 'none';
                return;
            }
            
            document.getElementById('budgetManagementSection').style.display = 'block';
            document.getElementById('budgetPreview').style.display = 'none';
        }
        
        async function saveUploadedBudgets() {
            const month = document.getElementById('budgetMonth').value;
            
            // Check if multi-warehouse format or single warehouse format
            const isMultiWarehouse = Object.keys(uploadedBudgetDataByWarehouse).length > 0;
            
            if (isMultiWarehouse) {
                // Save budgets for all warehouses
                let savedCount = 0;
                const warehouses = Object.keys(uploadedBudgetDataByWarehouse);
                
                for (const warehouseId of warehouses) {
                    const warehouseBudgets = uploadedBudgetDataByWarehouse[warehouseId];
                    const budgetKey = `${warehouseId}_${month}`;
                    
                    budgets[budgetKey] = warehouseBudgets;
                    
                    // Save each budget entry to Firebase or localStorage
                    for (const [category, amount] of Object.entries(warehouseBudgets)) {
                        await saveBudget(warehouseId, month, category, amount);
                    }
                    savedCount++;
                }
                
                await customAlert(`âœ… Budgets saved successfully for ${savedCount} warehouse(s)!`);
                document.getElementById('budgetPreview').style.display = 'none';
                uploadedBudgetDataByWarehouse = {};
            } else {
                // Single warehouse format: Use selected warehouse
                const warehouse = document.getElementById('budgetWarehouse').value;
                const budgetKey = `${warehouse}_${month}`;
                
                budgets[budgetKey] = uploadedBudgetData;
                
                // Save each budget entry to Firebase or localStorage
                for (const [category, amount] of Object.entries(uploadedBudgetData)) {
                    await saveBudget(warehouse, month, category, amount);
                }
                
                await customAlert('âœ… Budgets saved successfully!');
                document.getElementById('budgetPreview').style.display = 'none';
                uploadedBudgetData = {};
            }
            
            loadBudgetVisualization();
        }
        
        function loadBudgetVisualization() {
            const warehouse = document.getElementById('budgetWarehouse').value;
            const month = document.getElementById('budgetMonth').value;
            
            // Get expenses for the selected month and warehouse
            const monthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                const expenseMonth = expenseDate.toISOString().slice(0, 7);
                return expense.warehouse === warehouse && expense.status === 'approved' && expenseMonth === month;
            });
            
            // Calculate category-wise expenses
            const categoryExpenses = {};
            monthExpenses.forEach(expense => {
                if (!categoryExpenses[expense.category]) {
                    categoryExpenses[expense.category] = 0;
                }
                categoryExpenses[expense.category] += expense.amount;
            });
            
            // Get budgets for the selected warehouse and month
            const budgetKey = `${warehouse}_${month}`;
            const warehouseBudget = budgets[budgetKey] || {};
            
            // Render pie chart
            renderPieChart(categoryExpenses, warehouseBudget);
            
            // Render bar chart
            renderBarChart(categoryExpenses, warehouseBudget);
            
            // Render budget summary
            renderBudgetSummary(categoryExpenses, warehouseBudget, warehouse);
        }
        
        function renderPieChart(categoryExpenses, budgets) {
            const canvas = document.createElement('canvas');
            canvas.id = 'pieChart';
            canvas.width = 400;
            canvas.height = 400;
            
            document.getElementById('pieChartContainer').innerHTML = '';
            document.getElementById('pieChartContainer').appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            const centerX = 200;
            const centerY = 200;
            const radius = 150;
            
            // Get all categories
            const categories = new Set([...Object.keys(categoryExpenses), ...Object.keys(budgets)]);
            const categoriesArray = Array.from(categories);
            
            if (categoriesArray.length === 0) {
                ctx.font = '20px Arial';
                ctx.fillText('No data available', 100, 200);
                return;
            }
            
            // Draw pie chart
            ctx.clearRect(0, 0, 400, 400);
            
            const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#fa709a', '#ffecd2', '#fcb69f'];
            let startAngle = 0;
            
            categoriesArray.forEach((category, index) => {
                const expenseAmount = categoryExpenses[category] || 0;
                const budgetAmount = budgets[category] || 0;
                const totalAmount = budgetAmount > 0 ? (expenseAmount / budgetAmount) * 100 : 0;
                const sliceAngle = (totalAmount / 100) * 2 * Math.PI;
                
                // Draw slice
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();
                
                // Draw label
                const labelAngle = startAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
                const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.fillText(category, labelX - 30, labelY);
                
                startAngle += sliceAngle;
            });
            
            // Draw legend
            let yPos = 50;
            categoriesArray.forEach((category, index) => {
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(10, yPos, 15, 15);
                ctx.fillStyle = 'black';
                ctx.font = '12px Arial';
                ctx.fillText(category + `: â‚¹${categoryExpenses[category] || 0} / â‚¹${budgets[category] || 0}`, 30, yPos + 12);
                yPos += 20;
            });
        }
        
        function renderBarChart(categoryExpenses, budgets) {
            const canvas = document.createElement('canvas');
            canvas.id = 'barChart';
            canvas.width = 600;
            canvas.height = 400;
            
            document.getElementById('barChartContainer').innerHTML = '';
            document.getElementById('barChartContainer').appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            
            // Get all categories
            const categories = new Set([...Object.keys(categoryExpenses), ...Object.keys(budgets)]);
            const categoriesArray = Array.from(categories);
            
            if (categoriesArray.length === 0) {
                ctx.font = '20px Arial';
                ctx.fillText('No data available', 200, 200);
                return;
            }
            
            const barWidth = 80;
            const barSpacing = 10;
            const startX = 50;
            const chartHeight = 300;
            const startY = 350;
            const maxValue = Math.max(...categoriesArray.map(cat => Math.max(categoryExpenses[cat] || 0, budgets[cat] || 0)));
            const scale = chartHeight / maxValue;
            
            ctx.clearRect(0, 0, 600, 400);
            
            categoriesArray.forEach((category, index) => {
                const x = startX + index * (barWidth + barSpacing);
                const expenseAmount = categoryExpenses[category] || 0;
                const budgetAmount = budgets[category] || 0;
                
                // Draw budget bar
                ctx.fillStyle = '#667eea';
                const budgetHeight = budgetAmount * scale;
                ctx.fillRect(x, startY - budgetHeight, barWidth / 2 - 2, budgetHeight);
                
                // Draw expense bar
                ctx.fillStyle = expenseAmount > budgetAmount ? '#dc3545' : '#28a745';
                const expenseHeight = expenseAmount * scale;
                ctx.fillRect(x + barWidth / 2, startY - expenseHeight, barWidth / 2 - 2, expenseHeight);
                
                // Draw labels
                ctx.fillStyle = 'black';
                ctx.font = '10px Arial';
                ctx.save();
                ctx.translate(x + barWidth / 2, startY + 15);
                ctx.rotate(-Math.PI / 4);
                ctx.fillText(category, 0, 0);
                ctx.restore();
            });
        }
        
        function renderBudgetSummary(categoryExpenses, budgets, warehouse) {
            const summaryList = document.getElementById('budgetSummaryList');
            
            // Get all categories
            const categories = new Set([...Object.keys(categoryExpenses), ...Object.keys(budgets)]);
            const categoriesArray = Array.from(categories);
            
            if (categoriesArray.length === 0) {
                summaryList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">No budget data available. Set budgets to start tracking.</p>';
                return;
            }
            
            summaryList.innerHTML = categoriesArray.map(category => {
                const expenseAmount = categoryExpenses[category] || 0;
                const budgetAmount = budgets[category] || 0;
                const percentage = budgetAmount > 0 ? (expenseAmount / budgetAmount) * 100 : 0;
                const remaining = budgetAmount - expenseAmount;
                const isOverBudget = expenseAmount > budgetAmount;
                
                return `
                    <div class="budget-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h4 style="margin: 0;">${category}</h4>
                            <span style="font-size: 14px; color: #6c757d;">${percentage.toFixed(1)}% used</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                            <span>Budget: â‚¹${budgetAmount.toFixed(2)}</span>
                            <span>Spent: â‚¹${expenseAmount.toFixed(2)}</span>
                            <span class="budget-remaining ${remaining >= 0 ? 'positive' : 'negative'}">
                                ${remaining >= 0 ? 'Remaining' : 'Over'} â‚¹${Math.abs(remaining).toFixed(2)}
                            </span>
                        </div>
                        <div class="budget-progress">
                            <div class="budget-progress-bar ${isOverBudget ? 'over-budget' : 'under-budget'}" 
                                 style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Budget Excel Upload Functions
        async function downloadBudgetTemplate() {
            // Get all categories from the expense category dropdown to ensure they match
            const categorySelect = document.getElementById('expenseCategory');
            const categories = Array.from(categorySelect.options).map(option => option.value);
            
            // If categories dropdown not found, use default list
            const defaultCategories = categories.length > 0 ? categories : [
                'Pooja', 'Tea', 'Water', 'Petrol', 'Lunch', 'Travel', 'Freight', 
                'Maintenance', 'Utilities', 'Supplies', 'Staff Transportation', 
                'Staff Welfare', 'Electricity', 'Stationary', 'MHE Rental', 
                'Packing Material', 'Internet / Broadband', 'Diesel Generator', 'AMC', 'Other'
            ];
            
            // Get all warehouses (all 28 warehouses)
            const allWarehouses = Array.from({length: 28}, (_, i) => ({
                id: `warehouse_${i + 1}`,
                name: getWarehouseName(`warehouse_${i + 1}`)
            }));
            
            // Create CSV with Warehouse, Category, Budget format
            // Each warehouse gets a row for each category
            const csvRows = ['Warehouse,Warehouse ID,Category,Budget'];
            
            allWarehouses.forEach(warehouse => {
                defaultCategories.forEach(category => {
                    csvRows.push(`${warehouse.name},${warehouse.id},${category},0`);
                });
            });
            
            const csvContent = csvRows.join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'budget_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            await customAlert('âœ… Template downloaded! Fill in the budget values and upload.');
        }
        
        function uploadBudgetFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                
                // Check if it's the new format (with Warehouse column) or old format
                const header = lines[0].toLowerCase();
                const isNewFormat = header.includes('warehouse');
                
                // Parse CSV
                uploadedBudgetData = {};
                uploadedBudgetDataByWarehouse = {}; // Store budgets by warehouse
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    if (isNewFormat) {
                        // New format: Warehouse,Warehouse ID,Category,Budget
                        const parts = line.split(',');
                        if (parts.length >= 4) {
                            const warehouseName = parts[0].trim();
                            const warehouseId = parts[1].trim();
                            const category = parts[2].trim();
                            const budget = parts[3].trim();
                            
                            const budgetValue = parseFloat(budget);
                            if (!isNaN(budgetValue) && budgetValue >= 0 && warehouseId && category) {
                                // Store by warehouse
                                if (!uploadedBudgetDataByWarehouse[warehouseId]) {
                                    uploadedBudgetDataByWarehouse[warehouseId] = {};
                                }
                                uploadedBudgetDataByWarehouse[warehouseId][category] = budgetValue;
                            }
                        }
                    } else {
                        // Old format: Category,Budget (for single warehouse)
                        const [category, budget] = line.split(',');
                        if (category && budget) {
                            const budgetValue = parseFloat(budget);
                            if (!isNaN(budgetValue) && budgetValue > 0) {
                                uploadedBudgetData[category.trim()] = budgetValue;
                            }
                        }
                    }
                }
                
                // Show preview
                await showBudgetPreview();
                event.target.value = ''; // Reset file input
            };
            
            reader.readAsText(file);
        }
        
        async function showBudgetPreview() {
            const previewDiv = document.getElementById('budgetPreview');
            const previewListDiv = document.getElementById('budgetPreviewList');
            
            // Check if multi-warehouse format or single warehouse format
            const isMultiWarehouse = Object.keys(uploadedBudgetDataByWarehouse).length > 0;
            
            if (!isMultiWarehouse && Object.keys(uploadedBudgetData).length === 0) {
                await customAlert('âŒ No valid budget data found in the CSV file.');
                return;
            }
            
            if (isMultiWarehouse) {
                // Multi-warehouse format: Show all warehouses
                let previewHTML = '<div style="max-height: 500px; overflow-y: auto;">';
                const warehouses = Object.keys(uploadedBudgetDataByWarehouse).sort();
                
                warehouses.forEach(warehouseId => {
                    const warehouseBudgets = uploadedBudgetDataByWarehouse[warehouseId];
                    const warehouseName = getWarehouseName(warehouseId);
                    const totalBudget = Object.values(warehouseBudgets).reduce((sum, val) => sum + val, 0);
                    
                    previewHTML += `
                        <div style="margin-bottom: 20px; border: 2px solid #28a745; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                            <h4 style="margin-top: 0; color: #28a745; margin-bottom: 10px;">
                                ðŸ“¦ ${warehouseName} (${warehouseId})
                                <span style="float: right; font-size: 14px; color: #666;">Total: â‚¹${totalBudget.toFixed(2)}</span>
                            </h4>
                            ${Object.entries(warehouseBudgets)
                                .sort((a, b) => a[0].localeCompare(b[0]))
                                .map(([category, budget]) => `
                                    <div style="display: flex; justify-content: space-between; padding: 8px; margin-bottom: 5px; background: white; border-radius: 5px;">
                                        <span>${category}</span>
                                        <span style="color: #28a745; font-weight: 600;">â‚¹${budget.toFixed(2)}</span>
                                    </div>
                                `).join('')}
                        </div>
                    `;
                });
                
                previewHTML += '</div>';
                previewListDiv.innerHTML = previewHTML;
            } else {
                // Single warehouse format: Show categories only
                previewListDiv.innerHTML = Object.entries(uploadedBudgetData)
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([category, budget]) => `
                        <div style="display: flex; justify-content: space-between; padding: 10px; margin-bottom: 5px; background: #f8f9fa; border-radius: 5px;">
                            <span style="font-weight: 600;">${category}</span>
                            <span style="color: #28a745;">â‚¹${budget.toFixed(2)}</span>
                        </div>
                    `).join('');
            }
            
            previewDiv.style.display = 'block';
        }
        
        function exportBudgetsToCSV() {
            const warehouse = document.getElementById('budgetWarehouse').value;
            const month = document.getElementById('budgetMonth').value;
            const budgetKey = `${warehouse}_${month}`;
            const warehouseBudget = budgets[budgetKey] || {};
            
            const csvContent = [
                'Category,Budget',
                ...Object.entries(warehouseBudget).map(([category, budget]) => `${category},${budget}`)
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `budget_${warehouse}_${month}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Toggle warehouse field based on role
        function toggleWarehouseField() {
            const role = document.getElementById('newRole').value;
            const warehouseFieldGroup = document.getElementById('warehouseFieldGroup');
            const warehouseSelect = document.getElementById('newWarehouse');
            
            warehouseFieldGroup.style.display = 'block';
            
            if (role === 'warehouse') {
                // Warehouse role requires at least one warehouse
                warehouseSelect.required = true;
            } else {
                // Master and Approver can have all warehouses (empty) or specific ones
                warehouseSelect.required = false;
            }
        }

        // Load users (Master Admin only)
        async function loadUsers() {
            try {
                // Force reload users from database
                users = await getUsers(true); // Force reload
                const userList = document.getElementById('userList');
                
                if (!userList) {
                    console.error('userList element not found!');
                    return;
                }
                
                // Check if users object is empty or invalid
                if (!users || typeof users !== 'object' || Object.keys(users).length === 0) {
                    userList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #666;">
                            <p style="font-size: 18px; margin-bottom: 10px;">ðŸ‘¤ No users found</p>
                            <p>Create your first user using the form above.</p>
                            <p style="margin-top: 10px; font-size: 12px; color: #999;">
                                Note: Admin user should always exist. If you don't see admin, refresh the page.
                            </p>
                        </div>
                    `;
                    console.log('No users found. Users object:', users);
                    return;
                }
                
                // Filter out warehouse_ users (old format) and only show employee codes
                const filteredUsers = {};
                Object.keys(users).forEach(username => {
                    // Keep admin and all non-warehouse_ users (employee codes like K01386)
                    if (username === 'admin' || !username.startsWith('warehouse_')) {
                        filteredUsers[username] = users[username];
                    }
                });
                
                if (Object.keys(filteredUsers).length === 0) {
                    userList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #666;">
                            <p style="font-size: 18px; margin-bottom: 10px;">ðŸ‘¤ No users found</p>
                            <p>Create your first user using the form above.</p>
                        </div>
                    `;
                    return;
                }
                
                // Display users
                userList.innerHTML = Object.entries(filteredUsers).map(([username, user]) => {
                    // Validate user data
                    if (!user || !user.name || !user.role) {
                        console.warn(`Invalid user data for ${username}:`, user);
                        return '';
                    }
                    
                    return `
                        <div class="user-card">
                            <h4>${user.name || 'Unknown'}</h4>
                            <p><strong>Employee Code (Username):</strong> ${username}</p>
                            <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                            <p><strong>Role:</strong> <span class="user-role ${user.role}">${(user.role || 'unknown').toUpperCase()}</span></p>
                            <p><strong>Warehouse:</strong> ${user.warehouse && user.warehouse !== '' ? (user.warehouse.includes(',') ? user.warehouse.split(',').map(w => getWarehouseName(w.trim())).join(', ') : getWarehouseName(user.warehouse)) : 'All Warehouses'}</p>
                            <p id="password-${username}" style="display: none; margin-top: 10px; padding: 8px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px;">
                                <strong>Password:</strong> <code style="font-size: 14px; color: #856404;">${user.password || 'N/A'}</code>
                            </p>
                            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <button onclick="editUserWarehouses('${username}')" class="btn" style="flex: 1; min-width: 120px; padding: 8px; background: #ff9800; color: white;">âœï¸ Edit Warehouses</button>
                                <button onclick="togglePassword('${username}')" class="btn" style="flex: 1; min-width: 120px; padding: 8px; background: #17a2b8; color: white;">ðŸ”‘ Show Password</button>
                                <button onclick="deleteUser('${username}')" class="btn btn-danger" style="flex: 1; min-width: 120px; padding: 8px;">ðŸ—‘ï¸ Delete</button>
                            </div>
                        </div>
                    `;
                }).filter(html => html !== '').join('');
                
                console.log(`Loaded ${Object.keys(filteredUsers).length} user(s)`);
            } catch (error) {
                console.error('Error loading users:', error);
                const userList = document.getElementById('userList');
                if (userList) {
                    userList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #d32f2f;">
                            <p style="font-size: 18px; margin-bottom: 10px;">âŒ Error loading users</p>
                            <p>${error.message}</p>
                            <button onclick="loadUsers()" class="btn" style="margin-top: 10px;">ðŸ”„ Retry</button>
                        </div>
                    `;
                }
            }
        }
        
        // Toggle password visibility
        function togglePassword(username) {
            const passwordElement = document.getElementById(`password-${username}`);
            const button = event.target;
            
            if (passwordElement.style.display === 'none') {
                passwordElement.style.display = 'block';
                button.textContent = 'ðŸ™ˆ Hide Password';
                button.style.background = '#6c757d';
            } else {
                passwordElement.style.display = 'none';
                button.textContent = 'ðŸ”‘ Show Password';
                button.style.background = '#17a2b8';
            }
        }
        
        // Add new user form handler
        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const employeeCode = document.getElementById('newEmployeeCode').value.trim();
            const password = document.getElementById('newPassword').value;
            const name = document.getElementById('newName').value;
            const email = document.getElementById('newEmail').value.trim();
            const role = document.getElementById('newRole').value;
            const warehouseSelect = document.getElementById('newWarehouse');
            
            // Use Employee Code as username
            const username = employeeCode;
            
            // Validate employee code is not empty
            if (!employeeCode || employeeCode.trim() === '') {
                await customAlert('âŒ Employee Code is required and will be used as username!');
                return;
            }
            
            // Validate email format only if email is provided (it's optional)
            if (email && email.trim() !== '') {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    await customAlert('âŒ Please enter a valid email address!');
                    return;
                }
            }
            
            // Get selected warehouses (multiple selection)
            const selectedWarehouses = Array.from(warehouseSelect.selectedOptions).map(option => option.value);
            const warehouse = selectedWarehouses.length > 0 ? selectedWarehouses.join(',') : '';
            
            if (users[username]) {
                await customAlert('âŒ Employee Code already exists! Please use a different Employee Code.');
                return;
            }
            
            // Validate warehouse is required for warehouse role
            if (role === 'warehouse' && selectedWarehouses.length === 0) {
                await customAlert('âŒ At least one warehouse is required for warehouse entry users!');
                return;
            }
            
            users[username] = {
                password: password,
                role: role,
                name: name,
                employeeCode: employeeCode,
                email: email,
                warehouse: warehouse // Store as comma-separated string or empty for "all"
            };
            
            await saveUser(username, users[username]);
            
            // Send welcome email to new user
            // Email functionality disabled - will be enabled after configuration
            // await sendUserCreationEmail(email, name, username, password, role);
            
            await customAlert(`âœ… User "${name}" created successfully!`);
            
            // Reset form
            this.reset();
            
            // Reload user list
            users = await getUsers();
            loadUsers();
        });
        
        async function deleteUser(username) {
            if (username === 'admin') {
                await customAlert('âŒ Cannot delete master admin user!');
                return;
            }
            
            const confirmed = await customConfirm(`Are you sure you want to delete user "${users[username].name}"?`);
            if (confirmed) {
                delete users[username];
                await deleteUserFirebase(username);
                // Also save to localStorage as backup
                localStorage.setItem('warehouseUsers', JSON.stringify(users));
                await customAlert('âœ… User deleted successfully!');
                users = await getUsers();
                loadUsers();
            }
        }
        
        // Edit user warehouses
        async function editUserWarehouses(username) {
            if (!users[username]) {
                await customAlert('âŒ User not found!');
                return;
            }
            
            const user = users[username];
            const currentWarehouses = user.warehouse ? user.warehouse.split(',').map(w => w.trim()).filter(w => w) : [];
            
            // Create modal for editing warehouses
            const modalHTML = `
                <div style="padding: 20px;">
                    <h3 style="margin-top: 0;">âœï¸ Edit Warehouses for ${user.name}</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        <strong>Employee Code:</strong> ${username}<br>
                        <strong>Role:</strong> ${user.role.toUpperCase()}<br>
                        <strong>Current Warehouses:</strong> ${currentWarehouses.length > 0 ? currentWarehouses.map(w => getWarehouseName(w)).join(', ') : 'All Warehouses'}
                    </p>
                    <div class="form-group">
                        <label for="editWarehouseSelect" style="display: block; margin-bottom: 8px; font-weight: 600;">Select Warehouses (Hold Ctrl/Cmd to select multiple)</label>
                        <select id="editWarehouseSelect" multiple size="10" style="width: 100%; min-height: 200px; padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; background: white;">
                            ${Array.from({length: 28}, (_, i) => {
                                const warehouseId = `warehouse_${i + 1}`;
                                const warehouseName = getWarehouseName(warehouseId);
                                const isSelected = currentWarehouses.includes(warehouseId);
                                return `<option value="${warehouseId}" ${isSelected ? 'selected' : ''}>${warehouseName}</option>`;
                            }).join('')}
                        </select>
                        <small style="color: #6c757d; font-size: 12px; display: block; margin-top: 5px;">
                            ðŸ’¡ Tip: Hold Ctrl (Windows) or Cmd (Mac) and click to select multiple warehouses. Leave empty for "All Warehouses" access.
                        </small>
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeCustomModal(); window.editWarehouseResolve(false);" class="btn" style="background: #6c757d; color: white;">Cancel</button>
                        <button onclick="saveUserWarehouses('${username}');" class="btn" style="background: #28a745; color: white;">ðŸ’¾ Save Changes</button>
                    </div>
                </div>
            `;
            
            // Show modal and wait for user action
            return new Promise((resolve) => {
                window.editWarehouseResolve = resolve;
                showCustomModal('Edit User Warehouses', modalHTML);
                
                // Ensure dropdown is clickable after modal is shown
                setTimeout(() => {
                    const selectElement = document.getElementById('editWarehouseSelect');
                    if (selectElement) {
                        // Make sure it's not disabled and is visible
                        selectElement.disabled = false;
                        selectElement.style.pointerEvents = 'auto';
                        selectElement.style.zIndex = '10001';
                        // Focus on it to ensure it's interactive
                        selectElement.focus();
                    }
                }, 100);
            });
        }
        
        async function saveUserWarehouses(username) {
            const warehouseSelect = document.getElementById('editWarehouseSelect');
            const selectedWarehouses = Array.from(warehouseSelect.selectedOptions).map(option => option.value);
            const warehouseString = selectedWarehouses.length > 0 ? selectedWarehouses.join(',') : '';
            
            // Validate warehouse requirement for warehouse role
            if (users[username].role === 'warehouse' && selectedWarehouses.length === 0) {
                await customAlert('âŒ At least one warehouse is required for warehouse entry users!');
                return;
            }
            
            // Update user's warehouses
            users[username].warehouse = warehouseString;
            
            // Save to database
            await saveUser(username, users[username]);
            
            // Close modal
            closeCustomModal();
            if (window.editWarehouseResolve) {
                window.editWarehouseResolve(true);
            }
            
            await customAlert(`âœ… Warehouses updated successfully for ${users[username].name}!`);
            
            // Reload users list
            users = await getUsers();
            loadUsers();
        }
        
        // Export users to JSON file
        function exportUsersToJSON() {
            const usersData = JSON.parse(localStorage.getItem('warehouseUsers') || '{}');
            const dataStr = JSON.stringify(usersData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `users_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            customAlert(`âœ… Users exported successfully! (${Object.keys(usersData).length} users)`);
        }
        
        // Export users to CSV file
        function exportUsersToCSV() {
            const usersData = JSON.parse(localStorage.getItem('warehouseUsers') || '{}');
            let csv = 'Employee Code,Name,Email,Role,Warehouse,Password\n';
            
            Object.entries(usersData).forEach(([username, user]) => {
                const name = (user.name || '').replace(/"/g, '""');
                const email = (user.email || '').replace(/"/g, '""');
                const role = (user.role || '').replace(/"/g, '""');
                const warehouse = (user.warehouse || 'All Warehouses').replace(/"/g, '""');
                const password = (user.password || '').replace(/"/g, '""');
                csv += `"${username}","${name}","${email}","${role}","${warehouse}","${password}"\n`;
            });
            
            const dataBlob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `users_backup_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            customAlert(`âœ… Users exported to CSV successfully! (${Object.keys(usersData).length} users)`);
        }
        
        // Import users from JSON file
        async function importUsersFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedUsers = JSON.parse(e.target.result);
                    
                    if (!importedUsers || typeof importedUsers !== 'object') {
                        await customAlert('âŒ Invalid file format! Please import a valid JSON file.');
                        return;
                    }
                    
                    // Count users to import
                    const userCount = Object.keys(importedUsers).length;
                    if (userCount === 0) {
                        await customAlert('âŒ No users found in the file!');
                        return;
                    }
                    
                    const confirmed = await customConfirm(
                        `This will import ${userCount} user(s). Existing users with the same Employee Code will be overwritten. Continue?`
                    );
                    
                    if (!confirmed) {
                        event.target.value = ''; // Reset file input
                        return;
                    }
                    
                    // Load current users
                    const currentUsers = await getUsers();
                    
                    // Merge imported users (imported users take priority)
                    const mergedUsers = { ...currentUsers, ...importedUsers };
                    
                    // Save each imported user
                    let importedCount = 0;
                    let skippedCount = 0;
                    
                    for (const [username, userData] of Object.entries(importedUsers)) {
                        // Validate user data structure
                        if (!userData.password || !userData.role || !userData.name) {
                            console.warn(`Skipping invalid user: ${username}`, userData);
                            skippedCount++;
                            continue;
                        }
                        
                        await saveUser(username, userData);
                        importedCount++;
                    }
                    
                    // Reload users
                    users = await getUsers();
                    loadUsers();
                    
                    // Reset file input
                    event.target.value = '';
                    
                    await customAlert(
                        `âœ… Import completed!\n` +
                        `â€¢ Imported: ${importedCount} user(s)\n` +
                        `â€¢ Skipped: ${skippedCount} user(s)`
                    );
                } catch (error) {
                    console.error('Import error:', error);
                    await customAlert('âŒ Error importing users: ' + error.message);
                    event.target.value = ''; // Reset file input
                }
            };
            reader.readAsText(file);
        }
        
        // Attempt to recover deleted users from various sources
        async function attemptUserRecovery() {
            let recoveredCount = 0;
            const recoveredUsers = {};
            const recoverySources = [];
            
            // 1. Check Firebase (if configured)
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE" && db) {
                try {
                    const snapshot = await db.collection('users').get();
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        if (doc.id !== 'admin' && !doc.id.startsWith('warehouse_')) {
                            recoveredUsers[doc.id] = userData;
                            recoverySources.push(`Firebase: ${doc.id}`);
                        }
                    });
                    if (Object.keys(recoveredUsers).length > 0) {
                        recoverySources.push(`Found ${Object.keys(recoveredUsers).length} user(s) in Firebase`);
                    }
                } catch (error) {
                    console.error('Firebase recovery error:', error);
                }
            }
            
            // 2. Check all localStorage keys for user data
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.toLowerCase().includes('user') || key.toLowerCase().includes('warehouse'))) {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            if (data && typeof data === 'object') {
                                Object.keys(data).forEach(username => {
                                    if (username !== 'admin' && !username.startsWith('warehouse_') && data[username] && data[username].password) {
                                        if (!recoveredUsers[username]) {
                                            recoveredUsers[username] = data[username];
                                            recoverySources.push(`localStorage (${key}): ${username}`);
                                        }
                                    }
                                });
                            }
                        } catch (e) {
                            // Not JSON, skip
                        }
                    }
                }
            } catch (error) {
                console.error('localStorage recovery error:', error);
            }
            
            // 3. Check sessionStorage (sometimes used as backup)
            try {
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key && key.toLowerCase().includes('user')) {
                        try {
                            const data = JSON.parse(sessionStorage.getItem(key));
                            if (data && typeof data === 'object') {
                                Object.keys(data).forEach(username => {
                                    if (username !== 'admin' && !username.startsWith('warehouse_') && data[username] && data[username].password) {
                                        if (!recoveredUsers[username]) {
                                            recoveredUsers[username] = data[username];
                                            recoverySources.push(`sessionStorage (${key}): ${username}`);
                                        }
                                    }
                                });
                            }
                        } catch (e) {
                            // Not JSON, skip
                        }
                    }
                }
            } catch (error) {
                console.error('sessionStorage recovery error:', error);
            }
            
            // Remove admin from recovered users
            delete recoveredUsers['admin'];
            
            recoveredCount = Object.keys(recoveredUsers).length;
            
            if (recoveredCount === 0) {
                await customAlert(
                    'âŒ No recoverable users found.\n\n' +
                    'Possible reasons:\n' +
                    'â€¢ Users were never saved\n' +
                    'â€¢ Browser storage was cleared\n' +
                    'â€¢ Firebase is not configured\n\n' +
                    'Please recreate users manually or import from a backup file.'
                );
                return;
            }
            
            // Show recovery results
            const recoveryDetails = recoverySources.length > 0 
                ? '\n\nRecovery sources:\n' + recoverySources.slice(0, 10).join('\n') + (recoverySources.length > 10 ? '\n... and more' : '')
                : '';
            
            const confirmed = await customConfirm(
                `Found ${recoveredCount} recoverable user(s)!\n\n` +
                `Do you want to restore these users?\n\n` +
                `Note: Existing users with the same Employee Code will be overwritten.` +
                recoveryDetails
            );
            
            if (!confirmed) {
                return;
            }
            
            // Restore recovered users
            let restoredCount = 0;
            let skippedCount = 0;
            
            for (const [username, userData] of Object.entries(recoveredUsers)) {
                try {
                    // Validate user data
                    if (!userData.password || !userData.role || !userData.name) {
                        console.warn(`Skipping invalid recovered user: ${username}`, userData);
                        skippedCount++;
                        continue;
                    }
                    
                    await saveUser(username, userData);
                    restoredCount++;
                } catch (error) {
                    console.error(`Error restoring user ${username}:`, error);
                    skippedCount++;
                }
            }
            
            // Reload users
            users = await getUsers();
            loadUsers();
            
            await customAlert(
                `âœ… Recovery completed!\n\n` +
                `â€¢ Restored: ${restoredCount} user(s)\n` +
                `â€¢ Skipped: ${skippedCount} user(s)\n\n` +
                `Please verify the restored users in the user list.`
            );
        }

        // Approval functions
        function getRemainingBudget(warehouse, category, month) {
            // Get budget for the warehouse and month
            const budgetKey = `${warehouse}_${month}`;
            const warehouseBudget = budgets[budgetKey] || {};
            const budgetAmount = warehouseBudget[category] || 0;
            
            // Get total approved expenses for this category in the month
            const monthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                const expenseMonth = expenseDate.toISOString().slice(0, 7);
                return expense.warehouse === warehouse && 
                       expense.status === 'approved' && 
                       expense.category === category &&
                       expenseMonth === month;
            });
            
            const spentAmount = monthExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            return {
                budget: budgetAmount,
                spent: spentAmount,
                remaining: budgetAmount - spentAmount
            };
        }
        
        function displayApprovals() {
            const approvalsList = document.getElementById('approvalsList');
            
            // Determine which expenses to show based on user role and approval levels
            let expensesToShow = [];
            
            if (ENABLE_3RD_LEVEL_APPROVAL && currentUser === THIRD_LEVEL_APPROVER_ID) {
                // 3rd level approver sees expenses that are second_approved
                expensesToShow = expenses.filter(expense => expense.status === 'second_approved');
            } else if (ENABLE_2ND_LEVEL_APPROVAL && currentUser === SECOND_LEVEL_APPROVER_ID) {
                // 2nd level approver sees expenses that are first_approved
                const allFirstApproved = expenses.filter(expense => expense.status === 'first_approved');
                console.log(`[2nd Level Approver] Total expenses: ${expenses.length}, First approved: ${allFirstApproved.length}`);
                console.log(`[2nd Level Approver] Current approval filter: ${currentApprovalFilter}, Current warehouse: ${currentWarehouse}`);
                expensesToShow = allFirstApproved;
            } else {
                // First level approvers (including admin/master) see expenses that are pending (or have no status, which defaults to pending)
                expensesToShow = expenses.filter(expense => expense.status === 'pending' || !expense.status || expense.status === '');
            }
            
            // Debug logging
            console.log(`[displayApprovals] Current user: ${currentUser}, Role: ${users[currentUser]?.role}`);
            console.log(`[displayApprovals] Total expenses: ${expenses.length}, Filtered by status: ${expensesToShow.length}`);
            console.log(`[displayApprovals] Status breakdown:`, {
                pending: expenses.filter(e => e.status === 'pending' || !e.status).length,
                first_approved: expenses.filter(e => e.status === 'first_approved').length,
                second_approved: expenses.filter(e => e.status === 'second_approved').length,
                approved: expenses.filter(e => e.status === 'approved').length,
                rejected: expenses.filter(e => e.status === 'rejected').length
            });
            
            // Get user's accessible warehouses
            const accessibleWarehouses = getUserAccessibleWarehouses();
            
            // Third-level approver always sees all warehouses - no filtering needed
            if (ENABLE_3RD_LEVEL_APPROVAL && currentUser === THIRD_LEVEL_APPROVER_ID) {
                // Only filter by warehouse selector if a specific warehouse is selected
                if (currentApprovalFilter && currentApprovalFilter !== 'all') {
                    expensesToShow = expensesToShow.filter(expense => {
                        const expenseWarehouse = String(expense.warehouse || '').trim();
                        const filterWarehouse = String(currentApprovalFilter || '').trim();
                        return expenseWarehouse === filterWarehouse;
                    });
                }
                // If 'all' is selected or no filter, show all warehouses (no additional filtering)
            } else if (ENABLE_2ND_LEVEL_APPROVAL && currentUser === SECOND_LEVEL_APPROVER_ID) {
                // 2nd level approver sees ALL first_approved expenses from ALL warehouses
                // Only filter by warehouse selector if a specific warehouse filter button is clicked
                if (currentApprovalFilter && currentApprovalFilter !== 'all' && currentApprovalFilter.startsWith('warehouse_')) {
                    expensesToShow = expensesToShow.filter(expense => {
                        const expenseWarehouse = String(expense.warehouse || '').trim();
                        const filterWarehouse = String(currentApprovalFilter || '').trim();
                        return expenseWarehouse === filterWarehouse;
                    });
                }
                // If 'all' is selected or no filter, show all warehouses (no additional filtering)
                // Note: currentWarehouse selector should NOT filter approvals for 2nd level approver
            } else if (users[currentUser].role === 'approver' && users[currentUser].warehouse && users[currentUser].warehouse !== '') {
                // Approver with warehouse mapping: filter by approval filter or warehouse selector first
                if (currentApprovalFilter && currentApprovalFilter !== 'all') {
                    // Filter by approval filter button if set
                    const userWarehouses = users[currentUser].warehouse.split(',');
                    if (userWarehouses.includes(currentApprovalFilter)) {
                        expensesToShow = expensesToShow.filter(expense => {
                            const expenseWarehouse = String(expense.warehouse || '').trim();
                            const filterWarehouse = String(currentApprovalFilter || '').trim();
                            return expenseWarehouse === filterWarehouse;
                        });
                    } else {
                        expensesToShow = [];
                    }
                } else if (currentWarehouse && currentWarehouse !== 'all') {
                    // Filter by warehouse selector if approval filter is 'all'
                    const userWarehouses = users[currentUser].warehouse.split(',');
                    if (userWarehouses.includes(currentWarehouse)) {
                        expensesToShow = expensesToShow.filter(expense => {
                            const expenseWarehouse = String(expense.warehouse || '').trim();
                            const filterWarehouse = String(currentWarehouse || '').trim();
                            return expenseWarehouse === filterWarehouse;
                        });
                    } else {
                        expensesToShow = [];
                    }
                } else {
                    // Show all assigned warehouses if no filter is set
                    const userWarehouses = users[currentUser].warehouse.split(',');
                    expensesToShow = expensesToShow.filter(expense => userWarehouses.includes(expense.warehouse));
                }
            } else if (users[currentUser].role === 'master' && users[currentUser].warehouse && users[currentUser].warehouse !== '') {
                // Master with warehouse restrictions: only see accessible warehouses
                if (currentApprovalFilter && currentApprovalFilter !== 'all') {
                    if (hasWarehouseAccess(users[currentUser], currentApprovalFilter)) {
                        expensesToShow = expensesToShow.filter(expense => {
                            const expenseWarehouse = String(expense.warehouse || '');
                            const filterWarehouse = String(currentApprovalFilter || '');
                            return expenseWarehouse === filterWarehouse;
                        });
                    } else {
                        expensesToShow = [];
                    }
                } else {
                    // Show all accessible warehouses
                    expensesToShow = expensesToShow.filter(expense => 
                        accessibleWarehouses.includes(expense.warehouse)
                    );
                }
            } else if (currentApprovalFilter && currentApprovalFilter !== 'all') {
                // Filter by approval filter button (only if a specific warehouse is selected)
                if (users[currentUser].role === 'approver' && !hasWarehouseAccess(users[currentUser], currentApprovalFilter)) {
                    expensesToShow = [];
                } else {
                    // Strict string comparison to ensure exact warehouse match (prevents warehouse_1 matching warehouse_11)
                    expensesToShow = expensesToShow.filter(expense => {
                        const expenseWarehouse = String(expense.warehouse || '').trim();
                        const filterWarehouse = String(currentApprovalFilter || '').trim();
                        const matches = expenseWarehouse === filterWarehouse;
                        if (!matches && (expenseWarehouse === 'warehouse_7' || expenseWarehouse === 'warehouse_13')) {
                            console.log(`[Filter Debug] Expense ${expense.id} from ${expenseWarehouse} (${getWarehouseName(expenseWarehouse)}) filtered out by filter ${filterWarehouse}`);
                        }
                        return matches;
                    });
                }
            } else if (currentWarehouse && currentWarehouse !== 'all') {
                // If no approval filter is set but warehouse selector is set, use warehouse selector
                // BUT: For master/admin users with 'All Pending' selected, show ALL expenses (Hubli, Patna, etc.)
                if (users[currentUser].role === 'master' && (currentApprovalFilter === 'all' || !currentApprovalFilter)) {
                    // Master with 'All Pending': show all pending expenses from all warehouses
                } else {
                    expensesToShow = expensesToShow.filter(expense => {
                        const expenseWarehouse = String(expense.warehouse || '').trim();
                        const filterWarehouse = String(currentWarehouse || '').trim();
                        return expenseWarehouse === filterWarehouse;
                    });
                }
            } else if (users[currentUser].role === 'master' && users[currentUser].warehouse && users[currentUser].warehouse !== '') {
                // Master with warehouse restrictions but 'all' filter: show only accessible warehouses
                expensesToShow = expensesToShow.filter(expense => 
                    accessibleWarehouses.includes(expense.warehouse)
                );
            }
            // For master users with no warehouse restrictions and 'all' filter, show all pending expenses (no additional filtering)
            
            console.log(`[displayApprovals] After warehouse filtering: ${expensesToShow.length} expenses`);
            console.log(`[displayApprovals] Current approval filter: ${currentApprovalFilter}, Current warehouse: ${currentWarehouse}`);
            
            if (expensesToShow.length === 0) {
                let message = 'No pending approvals';
                if (ENABLE_3RD_LEVEL_APPROVAL && currentUser === THIRD_LEVEL_APPROVER_ID) {
                    message = 'No expenses pending final (3rd level) approval';
                } else if (ENABLE_2ND_LEVEL_APPROVAL && currentUser === SECOND_LEVEL_APPROVER_ID) {
                    message = 'No expenses pending 2nd level approval';
                } else {
                    message = 'No pending approvals';
                }
                approvalsList.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 4rem; margin-bottom: 20px;">âœ…</div>
                        <h3>${message}</h3>
                        <p>All expenses have been reviewed!</p>
                    </div>
                `;
                return;
            }
            
            approvalsList.innerHTML = expensesToShow.map(expense => {
                // Get the month from expense date (YYYY-MM format)
                const expenseMonth = expense.date.substring(0, 7);
                const budgetInfo = getRemainingBudget(expense.warehouse, expense.category, expenseMonth);
                
                // Calculate what remaining budget will be if this is approved
                const projectedRemaining = budgetInfo.remaining - expense.amount;
                const isOverBudget = projectedRemaining < 0;
                
                let budgetDisplay = '';
                if (budgetInfo.budget > 0) {
                    budgetDisplay = `
                        <div style="background: ${isOverBudget ? '#fee' : '#e8f5e9'}; padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 3px solid ${isOverBudget ? '#dc3545' : '#28a745'};">
                            <strong style="display: block; margin-bottom: 6px;">ðŸ’° Budget Information for ${expense.category}:</strong>
                            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 4px;">
                                <span>Allocated Budget:</span>
                                <strong>â‚¹${budgetInfo.budget.toFixed(2)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 4px;">
                                <span>Already Spent:</span>
                                <strong>â‚¹${budgetInfo.spent.toFixed(2)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 4px;">
                                <span>Current Remaining:</span>
                                <strong>â‚¹${budgetInfo.remaining.toFixed(2)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 14px; font-weight: bold; padding-top: 6px; border-top: 1px solid ${isOverBudget ? '#fcc' : '#c8e6c9'};">
                                <span style="color: ${isOverBudget ? '#dc3545' : '#28a745'}">After Approval Remaining:</span>
                                <strong style="color: ${isOverBudget ? '#dc3545' : '#28a745'}">
                                    â‚¹${projectedRemaining.toFixed(2)} 
                                    ${isOverBudget ? 'âš ï¸' : 'âœ…'}
                                </strong>
                            </div>
                        </div>
                    `;
                } else {
                    budgetDisplay = `
                        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 3px solid #ffc107;">
                            <strong style="color: #856404;">âš ï¸ No budget set for ${expense.category} this month</strong>
                        </div>
                    `;
                }
                
                return `
                <div class="approval-card">
                    <div class="expense-header">
                        <div>
                            <span class="expense-category">${expense.category}</span>
                            <span class="warehouse-badge">${getWarehouseName(expense.warehouse)}</span>
                            <span class="approval-status ${expense.status}">${getApprovalStatusText(expense.status)}</span>
                        </div>
                        <span class="expense-amount">â‚¹${expense.amount.toFixed(2)}</span>
                    </div>
                    <div class="expense-details">
                        ðŸ“… ${new Date(expense.date).toLocaleDateString()} at ${expense.time}
                        ${expense.vendorName ? `<br>ðŸª Vendor: <strong>${expense.vendorName}</strong>` : ''}
                        ${expense.paymentMode ? `<br>ðŸ’³ Payment: <strong>${expense.paymentMode}</strong>` : ''}
                        ${expense.invoiceNumber ? `<br>ðŸ§¾ Invoice: <strong>${expense.invoiceNumber}</strong>` : ''}
                        <br>ðŸ‘¤ Created by: ${users[expense.createdBy]?.name || expense.createdBy}
                        ${ENABLE_2ND_LEVEL_APPROVAL && expense.firstApprovedBy ? `<br>âœ… First Approved by: ${users[expense.firstApprovedBy]?.name || expense.firstApprovedBy}${expense.firstApprovedAt ? ` on ${new Date(expense.firstApprovedAt).toLocaleString()}` : ''}` : ''}
                        ${ENABLE_3RD_LEVEL_APPROVAL && expense.secondApprovedBy ? `<br>âœ… Second Approved by: ${users[expense.secondApprovedBy]?.name || expense.secondApprovedBy}${expense.secondApprovedAt ? ` on ${new Date(expense.secondApprovedAt).toLocaleString()}` : ''}` : ''}
                        ${expense.approvedBy && expense.status === 'rejected' ? `<br>âŒ Rejected by: <strong>${users[expense.approvedBy]?.name || 'Approver'}</strong>${expense.approvedAt ? ` on ${new Date(expense.approvedAt).toLocaleString()}` : ''}${expense.rejectionReason ? `<br>ðŸ“ Rejection Reason: <strong style="color: #dc3545;">${expense.rejectionReason}</strong>` : ''}` : ''}
                        ${expense.approvedBy && expense.status === 'approved' ? `<br>âœ… Final Approved by: <strong>${users[expense.approvedBy]?.name || 'Approver'}</strong>${expense.approvedAt ? ` on ${new Date(expense.approvedAt).toLocaleString()}` : ''}` : ''}
                    </div>
                    ${expense.description ? `<div class="expense-description">${expense.description}</div>` : ''}
                    ${expense.invoiceFile ? `
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            ${expense.invoiceFile.data ? `
                                <button onclick="viewInvoiceFile('${expense.id}')" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    ðŸ‘ï¸ View Invoice
                                </button>
                                <button onclick="downloadInvoiceFile('${expense.id}')" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                ðŸ“Ž Download Invoice
                            </button>
                            ` : `
                                <div style="background: #fff3cd; padding: 8px 12px; border-radius: 6px; border-left: 3px solid #ffc107; color: #856404; font-size: 12px;">
                                    âš ï¸ Invoice file not available (file may be too large)
                                </div>
                            `}
                        </div>
                    ` : ''}
                    ${budgetDisplay}
                    ${ENABLE_2ND_LEVEL_APPROVAL && expense.status === 'first_approved' ? `
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #2196f3;">
                            <strong style="color: #1976d2;">ðŸ“‹ First Level Approved</strong>
                            ${expense.firstApprovedBy ? ` by ${users[expense.firstApprovedBy]?.name || expense.firstApprovedBy}` : ''}
                            ${expense.firstApprovedAt ? ` on ${new Date(expense.firstApprovedAt).toLocaleString()}` : ''}
                        </div>
                    ` : ''}
                    ${ENABLE_3RD_LEVEL_APPROVAL && expense.status === 'second_approved' ? `
                        <div style="background: #fff3e0; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #ff9800;">
                            <strong style="color: #e65100;">ðŸ“‹ Second Level Approved</strong>
                            ${expense.secondApprovedBy ? ` by ${users[expense.secondApprovedBy]?.name || expense.secondApprovedBy}` : ''}
                            ${expense.secondApprovedAt ? ` on ${new Date(expense.secondApprovedAt).toLocaleString()}` : ''}
                        </div>
                    ` : ''}
                    ${ENABLE_2ND_LEVEL_APPROVAL && expense.status === 'first_approved' && !ENABLE_3RD_LEVEL_APPROVAL ? `
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #2196f3;">
                            <strong style="color: #1976d2;">ðŸ“‹ First Level Approved</strong>
                            <div style="font-size: 12px; color: #555; margin-top: 4px;">
                                Approved by: ${users[expense.firstApprovedBy]?.name || expense.firstApprovedBy || 'N/A'}
                                ${expense.firstApprovedAt ? ` on ${new Date(expense.firstApprovedAt).toLocaleString()}` : ''}
                            </div>
                        </div>
                    ` : ''}
                    <div class="approval-actions">
                        ${ENABLE_3RD_LEVEL_APPROVAL && currentUser === THIRD_LEVEL_APPROVER_ID && expense.status === 'second_approved' ? `
                            <button class="approval-btn approve-btn" onclick="approveExpense('${expense.id}')">âœ… Final Approve</button>
                            <button class="approval-btn reject-btn" onclick="rejectExpense('${expense.id}')">âŒ Reject</button>
                        ` : ENABLE_2ND_LEVEL_APPROVAL && currentUser === SECOND_LEVEL_APPROVER_ID && expense.status === 'first_approved' ? `
                            <button class="approval-btn approve-btn" onclick="approveExpense('${expense.id}')">âœ… Second Approve</button>
                            <button class="approval-btn reject-btn" onclick="rejectExpense('${expense.id}')">âŒ Reject</button>
                        ` : ENABLE_2ND_LEVEL_APPROVAL && expense.status === 'pending' ? `
                            <button class="approval-btn approve-btn" onclick="approveExpense('${expense.id}')">âœ… First Approve</button>
                            <button class="approval-btn reject-btn" onclick="rejectExpense('${expense.id}')">âŒ Reject</button>
                        ` : `
                            <button class="approval-btn approve-btn" onclick="approveExpense('${expense.id}')">âœ… Approve</button>
                            <button class="approval-btn reject-btn" onclick="rejectExpense('${expense.id}')">âŒ Reject</button>
                        `}
                    </div>
                </div>
            `;
            }).join('');
        }

        function filterApprovals(filter) {
            currentApprovalFilter = filter;
            // Remove active class from all filter buttons
            document.querySelectorAll('#approvals .filter-btn').forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            if (event && event.target) {
            event.target.classList.add('active');
            } else {
                // Fallback: find button by filter value
                document.querySelectorAll('#approvals .filter-btn').forEach(btn => {
                    if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`'${filter}'`)) {
                        btn.classList.add('active');
                    }
                });
            }
            displayApprovals();
        }

        async function approveExpense(id) {
            try {
                    // Convert id to string if needed
                    const expenseId = String(id);
                    const expense = expenses.find(e => String(e.id) === expenseId);
                    if (!expense) {
                        showToast('error', 'Error', 'Expense not found');
                        console.error('Expense not found. ID:', expenseId, 'Available IDs:', expenses.map(e => e.id));
                        return;
                    }
                    
                    // Determine approval level
                    const isThirdLevelApprover = ENABLE_3RD_LEVEL_APPROVAL && currentUser === THIRD_LEVEL_APPROVER_ID;
                    const isSecondLevelApprover = ENABLE_2ND_LEVEL_APPROVAL && currentUser === SECOND_LEVEL_APPROVER_ID;
                    const isFirstApproval = expense.status === 'pending';
                    const isSecondApproval = expense.status === 'first_approved';
                    const isFinalApproval = expense.status === 'second_approved';
                    
                    // Create a more informative confirmation message
                    let confirmMessage = '';
                    if (ENABLE_3RD_LEVEL_APPROVAL && isFinalApproval) {
                        confirmMessage = `Confirm Final (3rd Level) Approval\n\n` +
                            `Amount: â‚¹${expense.amount.toFixed(2)}\n` +
                            `Vendor: ${expense.vendorName || 'N/A'}\n` +
                            `Category: ${expense.category}\n` +
                            `Warehouse: ${getWarehouseName(expense.warehouse)}\n` +
                            `First Approved by: ${users[expense.firstApprovedBy]?.name || expense.firstApprovedBy || 'N/A'}\n` +
                            `Second Approved by: ${users[expense.secondApprovedBy]?.name || expense.secondApprovedBy || 'N/A'}\n\n` +
                            `Do you want to give final approval to this expense?`;
                    } else if (ENABLE_2ND_LEVEL_APPROVAL && isSecondApproval && !ENABLE_3RD_LEVEL_APPROVAL) {
                        confirmMessage = `Confirm Final Approval\n\n` +
                            `Amount: â‚¹${expense.amount.toFixed(2)}\n` +
                            `Vendor: ${expense.vendorName || 'N/A'}\n` +
                            `Category: ${expense.category}\n` +
                            `Warehouse: ${getWarehouseName(expense.warehouse)}\n` +
                            `First Approved by: ${users[expense.firstApprovedBy]?.name || expense.firstApprovedBy || 'N/A'}\n\n` +
                            `Do you want to give final approval to this expense?`;
                    } else if (ENABLE_2ND_LEVEL_APPROVAL && isSecondApproval && ENABLE_3RD_LEVEL_APPROVAL) {
                        confirmMessage = `Confirm Second Level Approval\n\n` +
                            `Amount: â‚¹${expense.amount.toFixed(2)}\n` +
                            `Vendor: ${expense.vendorName || 'N/A'}\n` +
                            `Category: ${expense.category}\n` +
                            `Warehouse: ${getWarehouseName(expense.warehouse)}\n` +
                            `First Approved by: ${users[expense.firstApprovedBy]?.name || expense.firstApprovedBy || 'N/A'}\n\n` +
                            `This expense will require final approval from ${users[THIRD_LEVEL_APPROVER_ID]?.name || THIRD_LEVEL_APPROVER_ID}.\n\n` +
                            `Do you want to approve this expense?`;
                    } else if (ENABLE_2ND_LEVEL_APPROVAL && isFirstApproval) {
                        confirmMessage = `Confirm First Level Approval\n\n` +
                            `Amount: â‚¹${expense.amount.toFixed(2)}\n` +
                            `Vendor: ${expense.vendorName || 'N/A'}\n` +
                            `Category: ${expense.category}\n` +
                            `Warehouse: ${expense.warehouse}\n\n` +
                            `This expense will require approval from ${users[SECOND_LEVEL_APPROVER_ID]?.name || SECOND_LEVEL_APPROVER_ID}${ENABLE_3RD_LEVEL_APPROVAL ? ` and then ${users[THIRD_LEVEL_APPROVER_ID]?.name || THIRD_LEVEL_APPROVER_ID}` : ''}.\n\n` +
                            `Do you want to approve this expense?`;
                    } else {
                        confirmMessage = `Confirm Approval\n\n` +
                            `Amount: â‚¹${expense.amount.toFixed(2)}\n` +
                            `Vendor: ${expense.vendorName || 'N/A'}\n` +
                            `Category: ${expense.category}\n` +
                            `Warehouse: ${expense.warehouse}\n\n` +
                            `Do you want to approve this expense?`;
                    }
                    
            const confirmed = await customConfirm(confirmMessage);
            if (confirmed) {
                    if (ENABLE_3RD_LEVEL_APPROVAL && isFinalApproval) {
                        // Final (3rd level) approval - change status to approved
                        expense.status = 'approved';
                        expense.approvedBy = currentUser;
                        expense.approvedAt = new Date().toISOString();
                        await saveExpense(expense);
                        
                        // Show success message immediately
                        showToast('success', 'Success', 'Expense finally approved successfully!');
                        
                        // Send email notifications
                        const approverData = users[currentUser];
                        if (approverData && approverData.email && emailConfigured) {
                            sendApprovalEmail(expense, 'approved', approverData.name, approverData.email).catch(err => {
                                console.error('Email sending failed (non-critical):', err);
                            });
                        }
                        
                        // Notify expense creator
                        const creatorData = users[expense.createdBy];
                        if (creatorData && creatorData.email && emailConfigured) {
                            sendApprovalEmail(expense, 'approved', creatorData.name, creatorData.email).catch(err => {
                                console.error('Email sending failed (non-critical):', err);
                            });
                        }
                    } else if (ENABLE_2ND_LEVEL_APPROVAL && isSecondApproval && ENABLE_3RD_LEVEL_APPROVAL) {
                        // Second level approval - change status to second_approved
                        expense.status = 'second_approved';
                        expense.secondApprovedBy = currentUser;
                        expense.secondApprovedAt = new Date().toISOString();
                        await saveExpense(expense);
                        
                        // Show success message immediately
                        showToast('success', 'Success', 'Expense second level approved! Waiting for final (3rd level) approval.');
                        
                        // Send email notifications
                        const approverData = users[currentUser];
                        if (approverData && approverData.email && emailConfigured) {
                            sendApprovalEmail(expense, 'second_approved', approverData.name, approverData.email).catch(err => {
                                console.error('Email sending failed (non-critical):', err);
                            });
                        }
                        
                        // Notify 3rd level approver
                        const thirdLevelApprover = users[THIRD_LEVEL_APPROVER_ID];
                        if (thirdLevelApprover && thirdLevelApprover.email && emailConfigured) {
                            sendExpenseSubmissionEmail(
                                expense, 
                                users[expense.createdBy]?.email || '', 
                                users[expense.createdBy]?.name || expense.createdBy,
                                thirdLevelApprover.email,
                                thirdLevelApprover.name
                            ).catch(err => {
                                console.error('Error sending notification to 3rd level approver:', err);
                            });
                        }
                    } else if (ENABLE_2ND_LEVEL_APPROVAL && isSecondApproval && !ENABLE_3RD_LEVEL_APPROVAL) {
                        // Final approval (when 3rd level is disabled) - change status to approved
                        expense.status = 'approved';
                        expense.approvedBy = currentUser;
                        expense.approvedAt = new Date().toISOString();
                        await saveExpense(expense);
                        
                        // Show success message immediately
                        showToast('success', 'Success', 'Expense finally approved successfully!');
                        
                        // Send email notifications
                        const approverData = users[currentUser];
                        if (approverData && approverData.email && emailConfigured) {
                            sendApprovalEmail(expense, 'approved', approverData.name, approverData.email).catch(err => {
                                console.error('Email sending failed (non-critical):', err);
                            });
                        }
                        
                        // Notify expense creator
                        const creatorData = users[expense.createdBy];
                        if (creatorData && creatorData.email && emailConfigured) {
                            sendApprovalEmail(expense, 'approved', creatorData.name, creatorData.email).catch(err => {
                                console.error('Email sending failed (non-critical):', err);
                            });
                        }
                    } else if (ENABLE_2ND_LEVEL_APPROVAL && isFirstApproval) {
                        // First level approval - change status to first_approved
                        expense.status = 'first_approved';
                        expense.firstApprovedBy = currentUser;
                        expense.firstApprovedAt = new Date().toISOString();
                        await saveExpense(expense);
                        
                        // Show success message immediately
                        const nextLevel = ENABLE_3RD_LEVEL_APPROVAL ? '2nd and 3rd level' : 'final';
                        showToast('success', 'Success', `Expense first level approved! Waiting for ${nextLevel} approval.`);
                        
                        // Send email notifications
                        const approverData = users[currentUser];
                        if (approverData && approverData.email && emailConfigured) {
                            sendApprovalEmail(expense, 'first_approved', approverData.name, approverData.email).catch(err => {
                                console.error('Email sending failed (non-critical):', err);
                            });
                        }
                        
                        // Notify 2nd level approver
                        const secondLevelApprover = users[SECOND_LEVEL_APPROVER_ID];
                        if (secondLevelApprover && secondLevelApprover.email && emailConfigured) {
                            sendExpenseSubmissionEmail(
                                expense, 
                                users[expense.createdBy]?.email || '', 
                                users[expense.createdBy]?.name || expense.createdBy,
                                secondLevelApprover.email,
                                secondLevelApprover.name
                            ).catch(err => {
                                console.error('Error sending notification to 2nd level approver:', err);
                            });
                        }
                    } else {
                        // Single level approval (2nd level disabled)
                        expense.status = 'approved';
                        expense.approvedBy = currentUser;
                        expense.approvedAt = new Date().toISOString();
                        await saveExpense(expense);
                        
                        // Show success message immediately
                        showToast('success', 'Success', 'Expense approved successfully!');
                        
                        // Send email notification to approver
                        const approverData = users[currentUser];
                        if (approverData && approverData.email && emailConfigured) {
                            sendApprovalEmail(expense, 'approved', approverData.name, approverData.email).catch(err => {
                                console.error('Email sending failed (non-critical):', err);
                            });
                        }
                        
                        // Notify expense creator
                        const creatorData = users[expense.createdBy];
                        if (creatorData && creatorData.email && emailConfigured) {
                            sendApprovalEmail(expense, 'approved', creatorData.name, creatorData.email).catch(err => {
                                console.error('Email sending failed (non-critical):', err);
                            });
                        }
                    }
                    
                    displayApprovals();
                    displayExpenses();
                    updateSummary();
                }
            } catch (error) {
                console.error('Error approving expense:', error);
                showToast('error', 'Error', 'Failed to approve expense: ' + error.message);
            }
        }

        async function rejectExpense(id) {
            try {
                    // Convert id to string if needed
                    const expenseId = String(id);
                    const expense = expenses.find(e => String(e.id) === expenseId);
                    if (!expense) {
                        showToast('error', 'Error', 'Expense not found');
                        console.error('Expense not found. ID:', expenseId, 'Available IDs:', expenses.map(e => e.id));
                        return;
                    }
                    
                    // Create a more informative message with input for remarks
                    const promptMessage = `Reject Expense\n\n` +
                        `Amount: â‚¹${expense.amount.toFixed(2)}\n` +
                        `Vendor: ${expense.vendorName || 'N/A'}\n` +
                        `Category: ${expense.category}\n` +
                        `Warehouse: ${getWarehouseName(expense.warehouse)}\n\n` +
                        `Please provide rejection remarks (required):`;
                    
                    const rejectionRemarks = await customPrompt(promptMessage, 'Enter reason for rejection...');
                    
                    if (!rejectionRemarks) {
                        // User cancelled
                        return;
                    }
                    
                    expense.status = 'rejected';
                    expense.approvedBy = currentUser;
                    expense.approvedAt = new Date().toISOString();
                    expense.rejectionReason = rejectionRemarks;
                    await saveExpense(expense);
                    
                    // Show success message immediately
                    showToast('success', 'Success', 'Expense rejected successfully!');
                    
                    // Send email notifications
                    const approverData = users[currentUser];
                    if (approverData && approverData.email && emailConfigured) {
                        sendApprovalEmail(expense, 'rejected', approverData.name, approverData.email).catch(err => {
                            console.error('Email sending failed (non-critical):', err);
                        });
                    }
                    
                    // Notify expense creator about rejection
                    const creatorData = users[expense.createdBy];
                    if (creatorData && creatorData.email && emailConfigured) {
                        sendApprovalEmail(expense, 'rejected', creatorData.name, creatorData.email).catch(err => {
                            console.error('Email sending failed (non-critical):', err);
                        });
                    }
                    
                    displayApprovals();
                    displayExpenses();
            } catch (error) {
                console.error('Error rejecting expense:', error);
                showToast('error', 'Error', 'Failed to reject expense: ' + error.message);
            }
        }

        // Download functions
        async function downloadCSV() {
            // Ensure expenses are loaded before downloading
            if (!expenses || expenses.length === 0) {
                console.log('Expenses array is empty, reloading...');
                expenses = await getExpenses();
            }
            
            let filteredExpenses = getFilteredExpenses();
            
            // Debug: Log what's being filtered
            console.log('Total expenses:', expenses.length);
            console.log('Filtered expenses:', filteredExpenses.length);
            console.log('Current user:', currentUser);
            console.log('Current warehouse:', currentWarehouse);
            
            if (filteredExpenses.length === 0) {
                showToast('warning', 'No Data', 'No expenses found matching the current filters. Try changing warehouse selector or date filters.');
                return;
            }
            
            const csv = convertToCSV(filteredExpenses);
            downloadFile(csv, 'expenses.csv', 'text/csv');
            showToast('success', 'Download Started', `Downloading ${filteredExpenses.length} expense(s) as CSV...`);
        }

        function downloadJSON() {
            let filteredExpenses = getFilteredExpenses();
            const json = JSON.stringify(filteredExpenses, null, 2);
            downloadFile(json, 'expenses.json', 'application/json');
        }

        function downloadPDF() {
            let filteredExpenses = getFilteredExpenses();
            const pdfContent = generatePDFContent(filteredExpenses);
            downloadFile(pdfContent, 'expense-report.txt', 'text/plain');
        }

        function getFilteredExpenses() {
            // Start with all expenses - ensure it's an array
            let filteredExpenses = expenses || [];
            
            // Debug logging
            console.log('getFilteredExpenses - Total expenses:', filteredExpenses.length);
            console.log('getFilteredExpenses - Current user:', currentUser);
            console.log('getFilteredExpenses - Current warehouse:', currentWarehouse);
            
            // If no expenses, return empty array
            if (filteredExpenses.length === 0) {
                console.warn('No expenses found in expenses array');
                return [];
            }
            
            // Ensure currentUser exists
            if (!currentUser || !users[currentUser]) {
                console.error('Invalid currentUser:', currentUser);
                return [];
            }
            
            // Get user's accessible warehouses
            const accessibleWarehouses = getUserAccessibleWarehouses();
            console.log('getFilteredExpenses - Accessible warehouses:', accessibleWarehouses.length);
            
            // Filter by warehouse - Respect user's warehouse access restrictions
            if (users[currentUser].role === 'warehouse') {
                // Warehouse users: see ALL their warehouse expenses (all statuses)
                filteredExpenses = filteredExpenses.filter(expense => 
                    hasWarehouseAccess(users[currentUser], expense.warehouse)
                );
            } else if (users[currentUser].role === 'approver') {
                // Approver: filter by warehouse selector or warehouse mapping
                if (currentWarehouse && currentWarehouse !== 'all') {
                    if (hasWarehouseAccess(users[currentUser], currentWarehouse)) {
                        filteredExpenses = filteredExpenses.filter(expense => {
                            const expenseWarehouse = String(expense.warehouse || '').trim();
                            const filterWarehouse = String(currentWarehouse || '').trim();
                            return expenseWarehouse === filterWarehouse;
                        });
                    } else {
                        filteredExpenses = [];
                    }
                } else {
                    // If no specific warehouse selected, show only accessible warehouses
                    filteredExpenses = filteredExpenses.filter(expense => 
                        accessibleWarehouses.includes(expense.warehouse)
                    );
                }
            } else if (users[currentUser].role === 'master') {
                // Master users: respect warehouse restrictions if they have assigned warehouses
                if (users[currentUser].warehouse && users[currentUser].warehouse !== '') {
                    // Master with warehouse restrictions: only show accessible warehouses
                    if (currentWarehouse && currentWarehouse !== 'all') {
                        if (hasWarehouseAccess(users[currentUser], currentWarehouse)) {
                            filteredExpenses = filteredExpenses.filter(expense => {
                                const expenseWarehouse = String(expense.warehouse || '').trim();
                                const filterWarehouse = String(currentWarehouse || '').trim();
                                return expenseWarehouse === filterWarehouse;
                            });
                        } else {
                            filteredExpenses = [];
                        }
                    } else {
                        // Show all accessible warehouses
                        filteredExpenses = filteredExpenses.filter(expense => 
                            accessibleWarehouses.includes(expense.warehouse)
                        );
                    }
                } else {
                    // Master with no restrictions: filter by selected warehouse if specified
                    if (currentWarehouse && currentWarehouse !== 'all') {
                        filteredExpenses = filteredExpenses.filter(expense => {
                            const expenseWarehouse = String(expense.warehouse || '').trim();
                            const filterWarehouse = String(currentWarehouse || '').trim();
                            return expenseWarehouse === filterWarehouse;
                        });
                    }
                    // If master has no restrictions and no filter, show all expenses (no additional filtering)
                }
            }
            
            console.log('getFilteredExpenses - After warehouse filtering:', filteredExpenses.length);
            
            // Apply date and category filters from download section
            const fromDateEl = document.getElementById('downloadFromDate');
            const toDateEl = document.getElementById('downloadToDate');
            const categoryEl = document.getElementById('downloadCategory');
            
            const fromDate = fromDateEl ? fromDateEl.value : '';
            const toDate = toDateEl ? toDateEl.value : '';
            const category = categoryEl ? categoryEl.value : '';
            
            if (fromDate) {
                filteredExpenses = filteredExpenses.filter(expense => expense.date >= fromDate);
                console.log('getFilteredExpenses - After fromDate filter:', filteredExpenses.length);
            }
            if (toDate) {
                filteredExpenses = filteredExpenses.filter(expense => expense.date <= toDate);
                console.log('getFilteredExpenses - After toDate filter:', filteredExpenses.length);
            }
            if (category) {
                filteredExpenses = filteredExpenses.filter(expense => expense.category === category);
                console.log('getFilteredExpenses - After category filter:', filteredExpenses.length);
            }
            
            console.log('getFilteredExpenses - Final count:', filteredExpenses.length);
            return filteredExpenses;
        }

        // Helper function to escape CSV values properly
        function escapeCSV(value) {
            if (value === null || value === undefined || value === '') {
                return '';
            }
            const stringValue = String(value);
            // If value contains comma, quote, or newline, wrap in quotes and escape quotes
            if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n') || stringValue.includes('\r')) {
                return `"${stringValue.replace(/"/g, '""')}"`;
            }
            return stringValue;
        }
        
        // Helper function to format date consistently
        function formatDateForCSV(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString; // Return original if invalid
                return date.toLocaleDateString('en-IN', { year: 'numeric', month: '2-digit', day: '2-digit' });
            } catch (e) {
                return dateString;
            }
        }
        
        // Helper function to format datetime consistently for CSV (DD/MM/YYYY HH:MM format)
        function formatDateTimeForCSV(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString; // Return original if invalid
                // Format as DD/MM/YYYY HH:MM
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            } catch (e) {
                return dateString;
            }
        }
        
        function convertToCSV(expenses) {
            // Handle empty expenses array
            if (!expenses || expenses.length === 0) {
                console.warn('No expenses to convert to CSV');
                return 'ID,Date,Time,Category,Amount,Vendor Name,Payment Mode,Invoice Number,Invoice File Name,Description,Warehouse,Created By,Created At,Status,First Approved By,First Approved At,Second Approved By,Second Approved At,Final Approved By,Final Approved At,Rejection Reason\nNo data available';
            }
            
            // Build headers based on approval level
            let headers = ['ID', 'Date', 'Time', 'Category', 'Amount (â‚¹)', 'Vendor Name', 'Payment Mode', 'Invoice Number', 'Invoice File Name', 'Description', 'Warehouse', 'Created By', 'Created At', 'Status'];
            
            if (ENABLE_3RD_LEVEL_APPROVAL) {
                headers.push('First Approved By', 'First Approved At', 'Second Approved By', 'Second Approved At', 'Final Approved By', 'Final Approved At', 'Rejection Reason');
            } else if (ENABLE_2ND_LEVEL_APPROVAL) {
                headers.push('First Approved By', 'First Approved At', 'Final Approved By', 'Final Approved At', 'Rejection Reason');
            } else {
                headers.push('Approved By', 'Approved At', 'Rejection Reason');
            }
            
            const csvRows = [headers.join(',')];
            
            expenses.forEach(expense => {
                try {
                    // Get invoice file name
                    let invoiceFileName = '';
                    if (expense.invoiceFile) {
                        if (typeof expense.invoiceFile === 'object' && expense.invoiceFile.filename) {
                            invoiceFileName = expense.invoiceFile.filename;
                        } else if (expense.invoiceFileName) {
                            invoiceFileName = expense.invoiceFileName;
                        }
                    }
                    
                    // Base fields (always present)
                    const baseFields = [
                        escapeCSV(expense.id || ''),
                        escapeCSV(formatDateForCSV(expense.date)),
                        escapeCSV(expense.time || ''),
                        escapeCSV(expense.category || ''),
                        escapeCSV(expense.amount ? expense.amount.toFixed(2) : '0.00'),
                        escapeCSV(expense.vendorName || ''),
                        escapeCSV(expense.paymentMode || ''),
                        escapeCSV(expense.invoiceNumber || ''),
                        escapeCSV(invoiceFileName),
                        escapeCSV(expense.description || ''),
                        escapeCSV(getWarehouseName(expense.warehouse) || expense.warehouse || ''),
                        escapeCSV(expense.createdBy || ''), // Show employee code instead of name
                        escapeCSV(formatDateTimeForCSV(expense.createdAt)),
                        escapeCSV(getApprovalStatusText(expense.status || 'pending'))
                    ];
                    
                    // Approval fields based on level
                    let approvalFields = [];
                    if (ENABLE_3RD_LEVEL_APPROVAL) {
                        approvalFields = [
                            escapeCSV(expense.firstApprovedBy || ''), // Show employee code instead of name
                            escapeCSV(formatDateTimeForCSV(expense.firstApprovedAt)),
                            escapeCSV(expense.secondApprovedBy || ''), // Show employee code instead of name
                            escapeCSV(formatDateTimeForCSV(expense.secondApprovedAt)),
                            escapeCSV(expense.approvedBy && expense.status === 'approved' ? expense.approvedBy : ''), // Show employee code instead of name
                            escapeCSV(formatDateTimeForCSV(expense.approvedAt && expense.status === 'approved' ? expense.approvedAt : '')),
                            escapeCSV(expense.status === 'rejected' ? (expense.rejectionReason || '') : '')
                        ];
                    } else if (ENABLE_2ND_LEVEL_APPROVAL) {
                        approvalFields = [
                            escapeCSV(expense.firstApprovedBy || ''), // Show employee code instead of name
                            escapeCSV(formatDateTimeForCSV(expense.firstApprovedAt)),
                            escapeCSV(expense.approvedBy && expense.status === 'approved' ? expense.approvedBy : ''), // Show employee code instead of name
                            escapeCSV(formatDateTimeForCSV(expense.approvedAt && expense.status === 'approved' ? expense.approvedAt : '')),
                            escapeCSV(expense.status === 'rejected' ? (expense.rejectionReason || '') : '')
                        ];
                    } else {
                        approvalFields = [
                            escapeCSV(expense.approvedBy || ''), // Show employee code instead of name
                            escapeCSV(formatDateTimeForCSV(expense.approvedAt)),
                            escapeCSV(expense.status === 'rejected' ? (expense.rejectionReason || '') : '')
                        ];
                    }
                    
                    const row = [...baseFields, ...approvalFields].join(',');
                    csvRows.push(row);
                } catch (error) {
                    console.error('Error converting expense to CSV row:', error, expense);
                }
            });
            
            return csvRows.join('\n');
        }

        function generatePDFContent(expenses) {
            const totalAmount = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            return `
WAREHOUSE EXPENSE REPORT
Generated: ${new Date().toLocaleString()}
User: ${currentUser}
Warehouse: ${currentWarehouse || 'All'}

SUMMARY:
Total Expenses: â‚¹${totalAmount.toFixed(2)}
Total Entries: ${expenses.length}

DETAILED EXPENSES:
${expenses.map(expense => `
Date: ${expense.date} ${expense.time}
Category: ${expense.category}
Amount: â‚¹${expense.amount.toFixed(2)}
${expense.vendorName ? `Vendor: ${expense.vendorName}` : ''}
${expense.paymentMode ? `Payment Mode: ${expense.paymentMode}` : ''}
${expense.invoiceNumber ? `Invoice: ${expense.invoiceNumber}` : ''}
${expense.invoiceFile ? `Invoice File: ${expense.invoiceFile.filename}` : ''}
Description: ${expense.description || 'N/A'}
Warehouse: ${getWarehouseName(expense.warehouse)}
Created By: ${users[expense.createdBy]?.name || expense.createdBy}
Status: ${expense.status || 'pending'}
${ENABLE_2ND_LEVEL_APPROVAL && expense.firstApprovedBy ? `First Approved By: ${users[expense.firstApprovedBy]?.name || 'First Approver'}` : ''}
${ENABLE_2ND_LEVEL_APPROVAL && expense.firstApprovedAt ? `First Approved At: ${new Date(expense.firstApprovedAt).toLocaleString()}` : ''}
${ENABLE_3RD_LEVEL_APPROVAL && expense.secondApprovedBy ? `Second Approved By: ${users[expense.secondApprovedBy]?.name || 'Second Approver'}` : ''}
${ENABLE_3RD_LEVEL_APPROVAL && expense.secondApprovedAt ? `Second Approved At: ${new Date(expense.secondApprovedAt).toLocaleString()}` : ''}
${expense.approvedBy && expense.status === 'rejected' ? `Rejected By: ${users[expense.approvedBy]?.name || 'Approver'}` : ''}
${expense.approvedAt && expense.status === 'rejected' ? `Rejected At: ${new Date(expense.approvedAt).toLocaleString()}` : ''}
${expense.approvedBy && expense.status === 'approved' ? `Final Approved By: ${users[expense.approvedBy]?.name || 'Approver'}` : ''}
${expense.approvedAt && expense.status === 'approved' ? `Final Approved At: ${new Date(expense.approvedAt).toLocaleString()}` : ''}
${expense.rejectionReason && expense.status === 'rejected' ? `Rejection Reason: ${expense.rejectionReason}` : ''}
${expense.approvedBy && expense.status !== 'rejected' ? `Final Approved By: ${users[expense.approvedBy]?.name || 'Approver'}` : ''}
${expense.approvedAt && expense.status !== 'rejected' ? `Final Approved At: ${new Date(expense.approvedAt).toLocaleString()}` : ''}
---`).join('')}
            `;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
